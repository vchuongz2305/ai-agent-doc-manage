{
  "nodes_to_add": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  id,\n  processing_id,\n  audit_id,\n  file_name,\n  file_url,\n  cloudinary_url,\n  user_id,\n  department,\n  uploader,\n  analysis_results,\n  gdpr_decision,\n  gdpr_justification,\n  legal_basis,\n  retention_days,\n  redaction_fields,\n  personal_data_found,\n  sensitive_data_detected,\n  data_volume,\n  notify_dpo,\n  status,\n  gdpr_action_performed,\n  ai_decision_timestamp,\n  gdpr_completed_at,\n  workflow_source,\n  flow2_completed\nFROM gdpr_compliance_results \nWHERE processing_id = '{{ $json.processing_id }}' \nORDER BY created_at DESC \nLIMIT 1;",
        "options": {}
      },
      "name": "üîç Query GDPR t·ª´ Database",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2400, 144],
      "credentials": {
        "postgres": {
          "id": "lYVcMJl3c3m62cYc",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// üìã Merge d·ªØ li·ªáu GDPR t·ª´ database v·ªõi d·ªØ li·ªáu chia s·∫ª\nconst gdprData = $json || {};\nconst originalData = $input.first().json || {};\n\nconsole.log('=== üìã MERGE GDPR DATA ===');\nconsole.log('GDPR Data from DB:', gdprData);\nconsole.log('Original Data:', originalData);\n\n// Format d·ªØ li·ªáu personal_data_found\nlet personalDataFound = [];\nif (gdprData.personal_data_found) {\n  if (Array.isArray(gdprData.personal_data_found)) {\n    personalDataFound = gdprData.personal_data_found;\n  } else if (typeof gdprData.personal_data_found === 'string') {\n    try {\n      personalDataFound = JSON.parse(gdprData.personal_data_found);\n    } catch (e) {\n      personalDataFound = [gdprData.personal_data_found];\n    }\n  }\n}\n\n// Format d·ªØ li·ªáu redaction_fields\nlet redactionFields = [];\nif (gdprData.redaction_fields) {\n  if (Array.isArray(gdprData.redaction_fields)) {\n    redactionFields = gdprData.redaction_fields;\n  } else if (typeof gdprData.redaction_fields === 'string') {\n    try {\n      redactionFields = JSON.parse(gdprData.redaction_fields);\n    } catch (e) {\n      redactionFields = [gdprData.redaction_fields];\n    }\n  }\n}\n\n// Format personal data found cho email\nlet personalDataFoundText = 'Kh√¥ng c√≥';\nif (personalDataFound && personalDataFound.length > 0) {\n  personalDataFoundText = personalDataFound.map(item => {\n    if (typeof item === 'string') return item;\n    return JSON.stringify(item);\n  }).join(', ');\n}\n\n// Format redaction fields cho email\nlet redactionFieldsText = 'Kh√¥ng c√≥';\nif (redactionFields && redactionFields.length > 0) {\n  redactionFieldsText = redactionFields.join(', ');\n}\n\n// Merge t·∫•t c·∫£ d·ªØ li·ªáu\nconst mergedData = {\n  // Gi·ªØ nguy√™n d·ªØ li·ªáu g·ªëc\n  ...originalData,\n  \n  // D·ªØ li·ªáu GDPR t·ª´ database (∆∞u ti√™n)\n  gdpr_decision: gdprData.gdpr_decision || originalData.gdpr_decision || null,\n  gdpr_justification: gdprData.gdpr_justification || originalData.gdpr_justification || null,\n  legal_basis: gdprData.legal_basis || originalData.legal_basis || null,\n  retention_days: gdprData.retention_days || originalData.retention_days || 30,\n  sensitive_data_detected: gdprData.sensitive_data_detected !== undefined ? gdprData.sensitive_data_detected : (originalData.sensitive_data_detected !== undefined ? originalData.sensitive_data_detected : false),\n  data_volume: gdprData.data_volume || originalData.data_volume || 'Kh√¥ng x√°c ƒë·ªãnh',\n  notify_dpo: gdprData.notify_dpo !== undefined ? gdprData.notify_dpo : (originalData.notify_dpo !== undefined ? originalData.notify_dpo : false),\n  ai_decision_timestamp: gdprData.ai_decision_timestamp || gdprData.gdpr_completed_at || originalData.ai_decision_timestamp || new Date().toISOString(),\n  \n  // Format arrays\n  personal_data_found: personalDataFound,\n  personal_data_found_text: personalDataFoundText,\n  redaction_fields: redactionFields,\n  redaction_fields_text: redactionFieldsText,\n  \n  // Th√¥ng tin file (∆∞u ti√™n t·ª´ database)\n  file_name: gdprData.file_name || originalData.file_name || 'Kh√¥ng x√°c ƒë·ªãnh',\n  file_url: gdprData.file_url || gdprData.cloudinary_url || originalData.file_url || originalData.cloudinary_url || 'Kh√¥ng c√≥ URL',\n  processing_id: gdprData.processing_id || originalData.processing_id || 'Kh√¥ng c√≥',\n  \n  // Email recipients\n  recipient_emails: originalData.recipient_emails || originalData.shareWithEmails || [],\n  shareWithEmails: originalData.shareWithEmails || originalData.recipient_emails || []\n};\n\nconsole.log('‚úÖ Merged data for email:');\nconsole.log('   File Name:', mergedData.file_name);\nconsole.log('   Processing ID:', mergedData.processing_id);\nconsole.log('   GDPR Decision:', mergedData.gdpr_decision);\nconsole.log('   Personal Data Found:', mergedData.personal_data_found_text);\nconsole.log('   Redaction Fields:', mergedData.redaction_fields_text);\nconsole.log('=== END üìã MERGE GDPR DATA ===');\n\nreturn [{ json: mergedData }];"
      },
      "name": "üìã Merge GDPR Data cho Email",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2560, 144]
    }
  ],
  "email_template": {
    "subject": "K·∫øt qu·∫£ ki·ªÉm tra GDPR v√† chia s·∫ª t√†i li·ªáu: {{ $json.file_name }}",
    "message": "K√≠nh ch√†o b·∫°n,\n\nH·ªá th·ªëng AI GDPR Compliance Agent ƒë√£ ho√†n t·∫•t vi·ªác ki·ªÉm tra tu√¢n th·ªß GDPR cho t√†i li·ªáu c·ªßa b·∫°n.\n\n**Th√¥ng tin t√†i li·ªáu:**\n\n- T√™n file: {{ $json.file_name || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- Processing ID: {{ $json.processing_id || 'Kh√¥ng c√≥' }}\n- URL file: {{ $json.file_url || 'Kh√¥ng c√≥ URL' }}\n\n**üîç K·∫øt qu·∫£ ph√¢n t√≠ch n·ªôi dung:**\n\n- D·ªØ li·ªáu c√° nh√¢n t√¨m th·∫•y: {{ $json.personal_data_found_text || 'Kh√¥ng c√≥' }}\n- D·ªØ li·ªáu nh·∫°y c·∫£m: {{ $json.sensitive_data_detected ? 'C√≥' : 'Kh√¥ng' }}\n- Kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu: {{ $json.data_volume || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n\n**K·∫øt qu·∫£ quy·∫øt ƒë·ªãnh GDPR:**\n\n- Quy·∫øt ƒë·ªãnh x·ª≠ l√Ω: **{{ $json.gdpr_decision || 'Kh√¥ng x√°c ƒë·ªãnh' }}**\n- Th√¥ng b√°o DPO: {{ $json.notify_dpo ? 'C√≥' : 'Kh√¥ng' }}\n- C∆° s·ªü ph√°p l√Ω: {{ $json.legal_basis || 'Kh√¥ng c√≥' }}\n- Th·ªùi gian l∆∞u tr·ªØ: {{ $json.retention_days || 30 }} ng√†y\n- C√°c tr∆∞·ªùng c·∫ßn redact: {{ $json.redaction_fields_text || 'Kh√¥ng c√≥' }}\n\n**L√Ω do quy·∫øt ƒë·ªãnh:**\n\n{{ $json.gdpr_justification || 'Kh√¥ng c√≥ l√Ω do ƒë∆∞·ª£c cung c·∫•p.' }}\n\n**Th·ªùi ƒëi·ªÉm ra quy·∫øt ƒë·ªãnh:** {{ $json.ai_decision_timestamp || (new Date()).toISOString() }}\n\nN·∫øu b·∫°n c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o v·ªÅ k·∫øt qu·∫£ n√†y, vui l√≤ng li√™n h·ªá v·ªõi b·ªô ph·∫≠n b·∫£o m·∫≠t d·ªØ li·ªáu (DPO) ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\n\nTr√¢n tr·ªçng,\n\n**AI GDPR Compliance Agent**"
  }
}

