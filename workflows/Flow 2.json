{
  "name": "Test gdpt",
  "nodes": [
    {
      "parameters": {
        "content": "### LU·ªíNG 2: AI DOCUMENT MANAGEMENT AGENT ‚Äì GDPR COMPLIANCE (Updated)\n\n**M·ª•c ƒë√≠ch:** T·ª± ƒë·ªông ki·ªÉm tra tu√¢n th·ªß GDPR cho t√†i li·ªáu t·ª´ Flow 1.\n\n**T√≠nh nƒÉng ch√≠nh:**\n‚Ä¢ ƒê·ª£i Flow 1 ho√†n th√†nh v√† nh·∫≠n d·ªØ li·ªáu qua webhook\n‚Ä¢ AI quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông GDPR (delete/anonymize/allow)\n‚Ä¢ X√°c ƒë·ªãnh legal basis, DSR, retention\n‚Ä¢ L∆∞u k·∫øt qu·∫£ v√†o Google Sheets\n‚Ä¢ Frontend query k·∫øt qu·∫£ qua endpoint GET /gdpr\n‚Ä¢ Frontend quy·∫øt ƒë·ªãnh c√≥ g·ª≠i t·ªõi Flow 3 hay kh√¥ng\n\n**C·∫£i ti·∫øn:**\n‚Ä¢ Lo·∫°i b·ªè logic g·ª≠i email t·ª± ƒë·ªông\n‚Ä¢ Th√™m endpoint HTTP GET ƒë·ªÉ frontend query k·∫øt qu·∫£\n‚Ä¢ Frontend t·ª± quy·∫øt ƒë·ªãnh g·ª≠i t·ªõi Flow 3"
      },
      "name": "üìã M√¥ t·∫£ Lu·ªìng GDPR",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "30dd97d2-a9b0-4bb2-a9c6-8b4c05ad9f15"
    },
    {
      "parameters": {
        "jsCode": "// üß© Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o cho ki·ªÉm tra GDPR\n// H·ªó tr·ª£ nhi·ªÅu c·∫•u tr√∫c d·ªØ li·ªáu: document analyzer response, direct webhook, Google Drive trigger\nconst input = $json ?? {};\nconst body = input.body ?? {};\n\n// üîç Debug: Log input structure\nconsole.log('üì• Input structure:', JSON.stringify(input, null, 2).substring(0, 500));\n\n// üîç Parse webhook response t·ª´ document analyzer (c·∫•u tr√∫c m·ªõi)\nlet webhookData = null;\nlet processingId = null;\nlet cloudinaryUrl = null;\nlet fileUrl = null;\nlet fileName = null;\nlet userId = null;\nlet department = null;\nlet analysisResults = null;\nlet fileSize = null;\nlet mimeType = null;\nlet fileId = null;\n\n// ============================================\n// CASE 1: Document Analyzer Response (c√≥ success, processingId, data)\n// ============================================\nif (input.success !== undefined || body.success !== undefined) {\n  const response = input.success !== undefined ? input : body;\n  \n  // L·∫•y processingId\n  processingId = response.processingId || response.data?.processing_id || response.processing_id || null;\n  \n  // L·∫•y th√¥ng tin file t·ª´ data object\n  if (response.data) {\n    fileUrl = response.data.file_url || null;\n    cloudinaryUrl = response.data.cloudinary_url || response.data.file_url || null;\n    fileName = response.data.file_name || null;\n    userId = response.data.user_id || null;\n    department = response.data.department || null;\n    analysisResults = response.data.analysis_results || null;\n  }\n  \n  webhookData = response;\n  console.log('‚úÖ Parsed webhook response from document analyzer');\n  console.log('   Processing ID:', processingId);\n  console.log('   Cloudinary URL:', cloudinaryUrl);\n  console.log('   File Name:', fileName);\n}\n\n// ============================================\n// CASE 2: Direct webhook v·ªõi body.file (t·ª´ h√¨nh ·∫£nh)\n// ============================================\n// Lu√¥n ki·ªÉm tra body.file n·∫øu c√≥, ho·∫∑c n·∫øu ch∆∞a c√≥ processingId v√† cloudinaryUrl\nif (body.file || (!processingId && !cloudinaryUrl)) {\n  // L·∫•y t·ª´ body.file (n·∫øu c√≥)\n  if (body.file) {\n    fileName = fileName || body.file.name || null;\n    fileSize = body.file.size || null;\n    mimeType = body.file.mimeType || body.file.mime_type || null;\n    // QUAN TR·ªåNG: L·∫•y cloudinary_url t·ª´ body.file\n    cloudinaryUrl = cloudinaryUrl || body.file.cloudinary_url || body.file.url || body.file.cloudinaryUrl || null;\n    fileUrl = fileUrl || cloudinaryUrl || null;\n    console.log('‚úÖ Found file info in body.file');\n    console.log('   File Name:', fileName);\n    console.log('   File Size:', fileSize);\n    console.log('   MIME Type:', mimeType);\n    console.log('   Cloudinary URL:', cloudinaryUrl);\n  }\n  \n  // L·∫•y processingId t·ª´ nhi·ªÅu ngu·ªìn\n  processingId = processingId || \n    input.processingId || \n    body.processingId || \n    input.processing_id || \n    body.processing_id || \n    null;\n  \n  // L·∫•y cloudinary_url t·ª´ nhi·ªÅu ngu·ªìn\n  cloudinaryUrl = cloudinaryUrl || \n    input.cloudinary_url || \n    body.cloudinary_url || \n    input.cloudinaryUrl || \n    body.cloudinaryUrl || \n    input.file_url || \n    body.file_url || \n    null;\n  \n  // L·∫•y file_url\n  fileUrl = fileUrl || cloudinaryUrl || null;\n  \n  // L·∫•y user_id\n  userId = userId || \n    input.user_id || \n    body.user_id || \n    input.userId || \n    body.userId || \n    null;\n  \n  // L·∫•y department\n  department = department || \n    input.department || \n    body.department || \n    null;\n  \n  // L·∫•y analysis_results\n  analysisResults = analysisResults || \n    input.analysis_results || \n    body.analysis_results || \n    null;\n}\n\n// ============================================\n// CASE 3: Google Drive Trigger (fallback)\n// ============================================\nif (!fileUrl && !cloudinaryUrl) {\n  try {\n    fileId = input.id || body.id || null;\n    fileName = fileName || input.name || body.name || null;\n    fileSize = fileSize || input.size || body.size || null;\n    mimeType = mimeType || input.mimeType || body.mimeType || null;\n    \n    // T·∫°o URL Google Drive\n    if (fileId) {\n      fileUrl = `https://drive.google.com/file/d/${fileId}/view`;\n      console.log('‚úÖ Using Google Drive file info');\n    }\n  } catch (e) {\n    console.warn('‚ö†Ô∏è L·ªói khi x·ª≠ l√Ω th√¥ng tin Google Drive:', e.message);\n  }\n}\n\n// üîç Th·ª≠ l·∫•y email c·ªßa ch·ªß s·ªü h·ªØu t·ª´ output Google Drive Trigger (fallback)\nlet ownerEmail = null;\ntry {\n  ownerEmail =\n    input.owners?.[0]?.emailAddress ||\n    body.owners?.[0]?.emailAddress ||\n    input.lastModifyingUser?.emailAddress ||\n    userId || // D√πng user_id t·ª´ webhook n·∫øu c√≥\n    null;\n} catch (e) {\n  ownerEmail = null;\n}\n\n// üß± Format file size n·∫øu c√≥\nlet formattedFileSize = '1.0MB';\nif (fileSize) {\n  if (typeof fileSize === 'number') {\n    // Convert bytes to readable format\n    if (fileSize < 1024) {\n      formattedFileSize = `${fileSize}B`;\n    } else if (fileSize < 1024 * 1024) {\n      formattedFileSize = `${(fileSize / 1024).toFixed(2)}KB`;\n    } else {\n      formattedFileSize = `${(fileSize / (1024 * 1024)).toFixed(2)}MB`;\n    }\n  } else {\n    formattedFileSize = fileSize.toString();\n  }\n}\n\n// üß± D·ªØ li·ªáu m·∫´u (fallback khi thi·∫øu input)\nconst defaultData = {\n  documentTitle: fileName || 'T√†i li·ªáu m·∫´u - GDPR Check',\n  documentCategory: 'Nh√¢n s·ª±',\n  documentSummary: analysisResults?.data?.[0]?.document_summary?.output?.[0]?.content || \n                   analysisResults?.document_summary || \n                   'T√†i li·ªáu ch·ª©a d·ªØ li·ªáu c√° nh√¢n c·∫ßn ki·ªÉm tra GDPR',\n  originalFileId: processingId || fileId || 'sample_file_gdpr',\n  fileSize: formattedFileSize,\n  uploadDate: new Date().toISOString(),\n  uploader: ownerEmail || userId || 'privacy@company.com',\n  hasPersonalInfo: true,\n  containsSpecialCategoryData: false,\n  dataSubjectRequest: null,\n  legalBasis: null\n};\n\n// üß† G·ªôp d·ªØ li·ªáu: ∆Øu ti√™n parsed values ‚Üí input ‚Üí body ‚Üí m·∫∑c ƒë·ªãnh\nconst merged = {\n  documentTitle: fileName || input.documentTitle || body.documentTitle || defaultData.documentTitle,\n  documentCategory: input.documentCategory || body.documentCategory || defaultData.documentCategory,\n  documentSummary: input.documentSummary || body.documentSummary || defaultData.documentSummary,\n  originalFileId: processingId || fileId || input.originalFileId || body.originalFileId || defaultData.originalFileId,\n  fileSize: formattedFileSize || input.fileSize || body.fileSize || defaultData.fileSize,\n  uploadDate: input.uploadDate || body.uploadDate || defaultData.uploadDate,\n  uploader: ownerEmail || userId || input.uploader || body.uploader || defaultData.uploader,\n  hasPersonalInfo: input.hasPersonalInfo ?? body.hasPersonalInfo ?? defaultData.hasPersonalInfo,\n  containsSpecialCategoryData: input.containsSpecialCategoryData ?? body.containsSpecialCategoryData ?? defaultData.containsSpecialCategoryData,\n  dataSubjectRequest: input.dataSubjectRequest ?? body.dataSubjectRequest ?? defaultData.dataSubjectRequest,\n  legalBasis: input.legalBasis ?? body.legalBasis ?? defaultData.legalBasis\n};\n\n// üßæ Th√™m metadata h·ªá th·ªëng v√† th√¥ng tin file\nconst result = {\n  receivedAt: new Date().toISOString(),\n  workflowSource: 'gdpr-compliance',\n  processingTimestamp: new Date().toISOString(),\n  // üîó Th√¥ng tin file t·ª´ Cloudinary/webhook\n  fileUrl: fileUrl || cloudinaryUrl || null,\n  cloudinaryUrl: cloudinaryUrl || fileUrl || null, // Cloudinary URL ƒë·ªÉ download\n  fileId: fileId || processingId || null,\n  fileName: fileName || null,\n  mimeType: mimeType || null,\n  processingId: processingId || null, // Processing ID t·ª´ document analyzer\n  userId: userId || null,\n  department: department || null,\n  analysisResults: analysisResults || null, // K·∫øt qu·∫£ ph√¢n t√≠ch t·ª´ document analyzer\n  // üìä Th√¥ng tin Google Drive g·ªëc (n·∫øu c√≥)\n  googleDriveInfo: fileId ? {\n    id: fileId,\n    name: fileName,\n    size: fileSize,\n    mimeType: mimeType,\n    url: fileUrl,\n    owners: input.owners || body.owners || null,\n    lastModifyingUser: input.lastModifyingUser || body.lastModifyingUser || null\n  } : null,\n  // üìã Webhook data g·ªëc (n·∫øu c√≥)\n  webhookData: webhookData || (Object.keys(input).length > 0 ? input : null),\n  ...merged\n};\n\n// üîç Debug: Log k·∫øt qu·∫£ cu·ªëi c√πng\nconsole.log('‚úÖ Normalized data result:');\nconsole.log('   Processing ID:', result.processingId);\nconsole.log('   File Name:', result.fileName);\nconsole.log('   Cloudinary URL:', result.cloudinaryUrl);\nconsole.log('   File URL:', result.fileUrl);\nconsole.log('   User ID:', result.userId);\nconsole.log('   MIME Type:', result.mimeType);\n\n// üßπ D·ªçn undefined/null\nfor (const key in result) {\n  if (result[key] === undefined) result[key] = null;\n  if (typeof result[key] === 'string') result[key] = result[key].trim();\n}\n\n// ‚úÖ Tr·∫£ ra JSON ho√†n ch·ªânh\nreturn [{ json: result }];\n"
      },
      "name": "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        352
      ],
      "id": "816fb97b-17b0-49d9-a68f-e203912d7be7"
    },
    {
      "parameters": {
        "url": "={{ $json.cloudinaryUrl || $json.fileUrl }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "name": "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        352
      ],
      "id": "download-cloudinary-file",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// üîó Merge file binary data v·ªõi JSON data t·ª´ normalization node\n// L·∫•y d·ªØ li·ªáu t·ª´ normalization node (node ƒë·∫ßu ti√™n trong input chain)\nlet normalizedData = {};\ntry {\n  // Th·ª≠ l·∫•y t·ª´ node normalization tr·ª±c ti·∫øp\n  normalizedData = $('2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o').item.json || {};\n} catch (e) {\n  // Fallback: l·∫•y t·ª´ input items\n  const inputItems = $input.all();\n  if (inputItems.length > 0) {\n    normalizedData = inputItems[0].json || {};\n  }\n  // N·∫øu v·∫´n kh√¥ng c√≥, d√πng $json hi·ªán t·∫°i\n  if (Object.keys(normalizedData).length === 0) {\n    normalizedData = $json || {};\n  }\n}\n\n// L·∫•y binary data t·ª´ HTTP Request (file download)\nconst binaryData = $binary?.data || null;\n\n// Merge d·ªØ li·ªáu - gi·ªØ nguy√™n t·∫•t c·∫£ data t·ª´ normalization\nconst result = {\n  ...normalizedData,\n  // Th√¥ng tin file ƒë√£ download\n  fileDownloaded: !!binaryData,\n  fileDownloadTimestamp: binaryData ? new Date().toISOString() : null,\n  downloadStatus: binaryData ? 'success' : 'failed',\n  // Binary data s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông pass qua n8n\n  // C√≥ th·ªÉ access qua $binary trong c√°c node ti·∫øp theo\n};\n\nconsole.log('‚úÖ File downloaded from Cloudinary:', result.cloudinaryUrl);\nconsole.log('   File binary available:', !!binaryData);\nconsole.log('   File name:', result.fileName);\nconsole.log('   Processing ID:', result.processingId);\n\n// Tr·∫£ v·ªÅ v·ªõi binary data (n·∫øu c√≥)\nif (binaryData) {\n  return [{ json: result, binary: $binary }];\n} else {\n  return [{ json: result }];\n}\n"
      },
      "name": "2.6Ô∏è‚É£ Merge File Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        352
      ],
      "id": "merge-file-data"
    },
    {
      "parameters": {
        "jsCode": "// üìã Chu·∫©n b·ªã prompt chi ti·∫øt v·ªõi t·∫•t c·∫£ data ƒë√£ chu·∫©n h√≥a cho Gemini\nconst data = $json;\nconst binaryData = $binary?.data || null;\n\n// Ki·ªÉm tra c√≥ file PDF kh√¥ng\nif (!binaryData) {\n  console.warn('‚ö†Ô∏è Kh√¥ng c√≥ file PDF binary data!');\n}\n\n// T·∫°o prompt chi ti·∫øt v·ªõi t·∫•t c·∫£ th√¥ng tin\nconst prompt = `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch tu√¢n th·ªß GDPR (General Data Protection Regulation).\n\nNHI·ªÜM V·ª§: Ph√¢n t√≠ch t√†i li·ªáu PDF ƒë√≠nh k√®m v√† ƒë∆∞a ra quy·∫øt ƒë·ªãnh GDPR ph√π h·ª£p.\n\nTH√îNG TIN T√ÄI LI·ªÜU:\n- T√™n file: ${data.fileName || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- Processing ID: ${data.processingId || 'Kh√¥ng c√≥'}\n- Ng∆∞·ªùi upload: ${data.uploader || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- User ID: ${data.userId || 'Kh√¥ng c√≥'}\n- Ph√≤ng ban: ${data.department || 'Kh√¥ng c√≥'}\n- K√≠ch th∆∞·ªõc file: ${data.fileSize || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- MIME Type: ${data.mimeType || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- URL file: ${data.cloudinaryUrl || data.fileUrl || 'Kh√¥ng c√≥'}\n\n${data.analysisResults ? `\nK·∫æT QU·∫¢ PH√ÇN T√çCH TR∆Ø·ªöC ƒê√ì (n·∫øu c√≥):\n${JSON.stringify(data.analysisResults, null, 2)}\n` : ''}\n\nY√äU C·∫¶U PH√ÇN T√çCH:\n1. ƒê·ªçc v√† ph√¢n t√≠ch to√†n b·ªô n·ªôi dung t√†i li·ªáu PDF ƒë√≠nh k√®m\n2. X√°c ƒë·ªãnh c√°c lo·∫°i d·ªØ li·ªáu c√° nh√¢n (PII) c√≥ trong t√†i li·ªáu:\n   - T√™n, ƒë·ªãa ch·ªâ, s·ªë ƒëi·ªán tho·∫°i, email\n   - S·ªë CMND/CCCD, passport\n   - Th√¥ng tin t√†i ch√≠nh (s·ªë t√†i kho·∫£n, th·∫ª t√≠n d·ª•ng)\n   - Th√¥ng tin y t·∫ø\n   - D·ªØ li·ªáu sinh tr·∫Øc h·ªçc\n   - D·ªØ li·ªáu nh·∫°y c·∫£m kh√°c\n3. ƒê√°nh gi√° m·ª©c ƒë·ªô nh·∫°y c·∫£m c·ªßa d·ªØ li·ªáu (cao/trung b√¨nh/th·∫•p)\n4. X√°c ƒë·ªãnh kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu (high/medium/low)\n5. X√°c ƒë·ªãnh c∆° s·ªü ph√°p l√Ω (legal basis) cho vi·ªác x·ª≠ l√Ω d·ªØ li·ªáu:\n   - consent (ƒë·ªìng √Ω)\n   - contract (h·ª£p ƒë·ªìng)\n   - legal obligation (nghƒ©a v·ª• ph√°p l√Ω)\n   - vital interests (l·ª£i √≠ch quan tr·ªçng)\n   - public task (nhi·ªám v·ª• c√¥ng)\n   - legitimate interests (l·ª£i √≠ch h·ª£p ph√°p)\n6. ƒê∆∞a ra quy·∫øt ƒë·ªãnh GDPR:\n   - \"delete\": X√≥a t√†i li·ªáu n·∫øu vi ph·∫°m nghi√™m tr·ªçng GDPR\n   - \"anonymize\": ·∫®n danh h√≥a d·ªØ li·ªáu c√° nh√¢n\n   - \"allow\": Cho ph√©p l∆∞u tr·ªØ n·∫øu tu√¢n th·ªß GDPR\n7. X√°c ƒë·ªãnh c√°c tr∆∞·ªùng c·∫ßn redact (·∫©n danh h√≥a) n·∫øu quy·∫øt ƒë·ªãnh l√† \"anonymize\"\n8. X√°c ƒë·ªãnh th·ªùi gian l∆∞u tr·ªØ (retention days)\n9. X√°c ƒë·ªãnh c√≥ c·∫ßn th√¥ng b√°o DPO (Data Protection Officer) kh√¥ng\n\nƒê·ªäNH D·∫†NG OUTPUT (JSON):\n{\n  \"content\": {\n    \"gdprDecision\": \"delete|anonymize|allow\",\n    \"notifyDPO\": true/false,\n    \"legalBasis\": \"consent|contract|legal_obligation|vital_interests|public_task|legitimate_interests|null\",\n    \"retentionDays\": s·ªë_ng√†y,\n    \"redactionFields\": [\"danh_s√°ch_c√°c_tr∆∞·ªùng_c·∫ßn_·∫©n\"],\n    \"gdprJustification\": \"L√Ω do chi ti·∫øt cho quy·∫øt ƒë·ªãnh\",\n    \"fileUrl\": \"${data.fileUrl || ''}\",\n    \"fileName\": \"${data.fileName || ''}\",\n    \"personalDataFound\": [\"danh_s√°ch_d·ªØ_li·ªáu_c√°_nh√¢n_t√¨m_th·∫•y\"],\n    \"sensitiveDataDetected\": true/false,\n    \"dataVolume\": \"high|medium|low\"\n  },\n  \"finishReason\": \"stop\",\n  \"index\": 0,\n  \"uploader\": \"${data.uploader || ''}\"\n}\n\nQUAN TR·ªåNG:\n- Ph√¢n t√≠ch k·ªπ l∆∞·ª°ng n·ªôi dung PDF\n- ƒê∆∞a ra quy·∫øt ƒë·ªãnh d·ª±a tr√™n c√°c nguy√™n t·∫Øc GDPR\n- Gi·∫£i th√≠ch r√µ r√†ng l√Ω do cho quy·∫øt ƒë·ªãnh\n- Tr·∫£ v·ªÅ JSON ƒë√∫ng ƒë·ªãnh d·∫°ng`;\n\n// L∆∞u prompt v√†o result\nconst result = {\n  ...data,\n  gdprPrompt: prompt,\n  hasPdfBinary: !!binaryData\n};\n\nconsole.log('‚úÖ ƒê√£ chu·∫©n b·ªã prompt cho GDPR analysis');\nconsole.log('   Has PDF binary:', !!binaryData);\nconsole.log('   File name:', data.fileName);\n\n// Tr·∫£ v·ªÅ v·ªõi binary data (n·∫øu c√≥) ƒë·ªÉ Gemini c√≥ th·ªÉ ƒë·ªçc file PDF\nif (binaryData) {\n  return [{ json: result, binary: $binary }];\n} else {\n  return [{ json: result }];\n}"
      },
      "name": "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        352
      ],
      "id": "prepare-gdpr-prompt"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "={{ $json.gdprPrompt }}",
        "options": {}
      },
      "name": "3Ô∏è‚É£ AI GDPR Decision",
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        800,
        352
      ],
      "id": "b59e4065-efe8-4432-b558-e6513fac2cb7",
      "credentials": {
        "googlePalmApi": {
          "id": "91898OzbZbpGF2b2",
          "name": "Google Gemini(PaLM) Api account 4"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// üß† Parse k·∫øt qu·∫£ AI GDPR (Node 4) - FIXED VERSION\nlet ai = {};\nlet raw = '';\nlet clean = '';\nlet match = null;\n\ntry {\n  // üîç L·∫•y text t·ª´ ph·∫£n h·ªìi c·ªßa Gemini\n  raw = $json?.content?.parts?.[0]?.text || $json?.text || JSON.stringify($json);\n\n  // üßπ L√†m s·∫°ch k√Ω hi·ªáu code block\n  clean = raw.replace(/```json/gi, '').replace(/```/g, '').trim();\n\n  // üîé T√¨m ƒëo·∫°n JSON trong text\n  match = clean.match(/\\{[\\s\\S]*\\}/);\n\n  // üßæ Parse JSON\n  ai = JSON.parse(match ? match[0] : clean);\n  console.log(\"‚úÖ Parsed AI JSON:\", ai);\n} catch (error) {\n  console.warn(\"‚ö†Ô∏è Parse error:\", error.message);\n  console.log(\"üìù Raw preview:\", raw?.slice(0, 300));\n\n  // üõü Fallback an to√†n\n  ai = {\n    content: {\n      gdprDecision: \"anonymize\",\n      notifyDPO: true,\n      gdprJustification: \"‚ö†Ô∏è Parsing fallback due to invalid AI output\"\n    },\n    uploader: \"dangnguyen0175@gmail.com\"\n  };\n}\n\n// üß© H·ª£p nh·∫•t d·ªØ li·ªáu ƒë·∫ßu v√†o + k·∫øt qu·∫£ AI\nconst result = {\n  ...$input.first().json,\n  aiRawOutput: raw || null,\n\n  // üß† L·∫•y d·ªØ li·ªáu t·ª´ c·∫•u tr√∫c l·ªìng nhau (ai.content.*)\n  gdprDecision: ai.content?.gdprDecision || ai.gdprDecision || ai.action || \"anonymize\",\n  notifyDPO: !!(ai.content?.notifyDPO ?? ai.notifyDPO),\n  gdprJustification: ai.content?.gdprJustification || ai.gdprJustification || ai.justification || \"N/A\",\n  legalBasis: ai.content?.legalBasis || ai.legalBasis || null,\n  dataSubjectRequest: ai.content?.dataSubjectRequest || ai.dataSubjectRequest || null,\n  retentionDays: ai.content?.retentionDays || ai.retentionDays || 30,\n  redactionFields: ai.content?.redactionFields || ai.redactionFields || [],\n  aiDecisionTimestamp: ai.aiDecisionTimestamp || new Date().toISOString(),\n  uploader: ai.uploader || $input.first().json.uploader || \"dangnguyen0175@gmail.com\",\n  // üîó Th√¥ng tin file t·ª´ AI (n·∫øu c√≥)\n  fileUrl: ai.content?.fileUrl || $input.first().json.fileUrl || null,\n  fileName: ai.content?.fileName || $input.first().json.fileName || null,\n  // üîç Th√¥ng tin ph√¢n t√≠ch n·ªôi dung file\n  personalDataFound: ai.content?.personalDataFound || ai.personalDataFound || [],\n  sensitiveDataDetected: ai.content?.sensitiveDataDetected ?? ai.sensitiveDataDetected ?? false,\n  dataVolume: ai.content?.dataVolume || ai.dataVolume || 'unknown',\n  // üßæ Log th√™m th√¥ng tin tr·∫°ng th√°i parser\n  aiParseStatus: match ? \"success\" : \"fallback\",\n  aiParsed: ai\n};\n\n// üßæ Log k·∫øt qu·∫£ cu·ªëi c√πng ƒë·ªÉ ki·ªÉm tra\nconsole.log(\"üìú GDPR Parsed Result:\", result);\n\nreturn [{ json: result }];\n"
      },
      "name": "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        352
      ],
      "id": "a711b63b-068c-49b5-acc8-7cc220df4046"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.gdprDecision }}",
              "rightValue": "delete",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1092,
        224
      ],
      "id": "c43814e9-dbe3-4492-82b2-8ebe00e4dd51"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.gdprDecision }}",
              "rightValue": "anonymize",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1092,
        384
      ],
      "id": "9cfeec8f-5ee5-4b3a-a22d-72440c4cd960"
    },
    {
      "parameters": {
        "jsCode": "// ===============================================\n// üßπ GDPR ACTION: DELETE / REVOKE DOCUMENT ACCESS\n// ===============================================\n\n// L·∫•y d·ªØ li·ªáu ƒë·∫ßu v√†o\nconst data = $json;\nconst fileId = data.originalFileId || null;\n\n// Bi·∫øn k·∫øt qu·∫£ m·∫∑c ƒë·ªãnh\nlet result = {\n  ...data,\n  gdprActionPerformed: 'delete',\n  status: 'GDPR_REVOKE_APPLIED',\n  deleteSuccess: false,\n  deleteMethod: null,\n  deleteTimestamp: new Date().toISOString(),\n  deleteLog: ''\n};\n\n// N·∫øu c√≥ ID file g·ªëc th√¨ ti·∫øn h√†nh ‚Äúx√≥a‚Äù (ho·∫∑c thu h·ªìi chia s·∫ª)\ntry {\n  if (fileId) {\n    // --- N·∫øu b·∫°n d√πng Google Drive API ---\n    // Gi·∫£ l·∫≠p h√†nh ƒë·ªông g·ªçi API n8n kh√°c (·ªü m√¥i tr∆∞·ªùng th·ª±c, s·∫Ω d√πng node Google Drive Delete)\n    result.deleteMethod = 'revoke_access';\n    result.deleteSuccess = true;\n    result.deleteLog = `T√†i li·ªáu ${fileId} ƒë√£ ƒë∆∞·ª£c thu h·ªìi quy·ªÅn truy c·∫≠p.`;\n  } else {\n    result.deleteLog = 'Kh√¥ng t√¨m th·∫•y originalFileId ƒë·ªÉ x√≥a.';\n  }\n} catch (err) {\n  result.status = 'GDPR_DELETE_FAILED';\n  result.deleteSuccess = false;\n  result.deleteLog = `L·ªói khi x√≥a: ${err.message}`;\n}\n\n// Tr·∫£ v·ªÅ k·∫øt qu·∫£ x·ª≠ l√Ω\nreturn [{ json: result }];\n"
      },
      "name": "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        144
      ],
      "id": "29264876-faa8-469f-8c84-b8784b2e3575"
    },
    {
      "parameters": {
        "jsCode": "// Gi·∫£ l·∫≠p ·∫©n danh/redact\nlet summary = $json.documentSummary || '';\nfor (const f of ($json.redactionFields || [])) summary = summary.replace(new RegExp(f, 'gi'), '[REDACTED]');\nreturn { json: { ...$json, documentSummary: summary, gdprActionPerformed: 'anonymize', status: 'GDPR_ANON_APPLIED' } };"
      },
      "name": "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        384
      ],
      "id": "b0104c72-e463-4d14-8646-1fc7c46e51a3"
    },
    {
      "parameters": {
        "jsCode": "return { json: { ...$json, gdprActionPerformed: 'allow', status: 'GDPR_ALLOWED' } };"
      },
      "name": "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        576
      ],
      "id": "5fb7aec3-b461-4013-9cda-1023242ae74f"
    },
    {
      "parameters": {},
      "name": "7.8 Merge Actions",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        1360,
        160
      ],
      "id": "e0a4ba1f-10dc-44f1-a31b-5657a115d28e"
    },
    {
      "parameters": {
        "jsCode": "// üîß Format d·ªØ li·ªáu cho PostgreSQL INSERT\n// L·∫•y d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc\nconst data = $json;\n\n// Helper function ƒë·ªÉ escape SQL strings\nfunction escapeSQL(str) {\n  if (!str) return null;\n  return String(str).replace(/'/g, \"''\").replace(/\\\\/g, '\\\\\\\\');\n}\n\n// Helper function ƒë·ªÉ format PostgreSQL array\nfunction formatPostgresArray(arr) {\n  if (!Array.isArray(arr) || arr.length === 0) return 'ARRAY[]::TEXT[]';\n  const escaped = arr.map(item => `'${escapeSQL(String(item))}'`).join(', ');\n  return `ARRAY[${escaped}]`;\n}\n\n// Format JSONB cho analysis_results\nlet analysisResultsJSON = 'NULL';\nif (data.analysis_results || data.analysisResults) {\n  try {\n    const jsonStr = JSON.stringify(data.analysis_results || data.analysisResults);\n    analysisResultsJSON = `'${escapeSQL(jsonStr)}'::jsonb`;\n  } catch (e) {\n    console.warn('‚ö†Ô∏è L·ªói khi format analysis_results:', e.message);\n    analysisResultsJSON = 'NULL';\n  }\n}\n\n// Format c√°c gi√° tr·ªã\nconst result = {\n  ...data,\n  // Format arrays cho PostgreSQL\n  redaction_fields_sql: formatPostgresArray(data.redaction_fields || data.redactionFields || []),\n  personal_data_found_sql: formatPostgresArray(data.personal_data_found || data.personalDataFound || []),\n  // Format JSONB\n  analysis_results_sql: analysisResultsJSON,\n  // Format text fields (escape quotes)\n  gdpr_justification_sql: data.gdpr_justification || data.gdprJustification ? `'${escapeSQL(data.gdpr_justification || data.gdprJustification)}'` : 'NULL',\n  legal_basis_sql: data.legal_basis || data.legalBasis ? `'${escapeSQL(data.legal_basis || data.legalBasis)}'` : 'NULL',\n  data_volume_sql: data.data_volume || data.dataVolume ? `'${escapeSQL(data.data_volume || data.dataVolume)}'` : 'NULL',\n  gdpr_action_performed_sql: data.gdpr_action_performed || data.gdprActionPerformed ? `'${escapeSQL(data.gdpr_action_performed || data.gdprActionPerformed)}'` : 'NULL',\n  // Format timestamps\n  ai_decision_timestamp_sql: data.ai_decision_timestamp || data.aiDecisionTimestamp ? `'${data.ai_decision_timestamp || data.aiDecisionTimestamp}'::timestamp` : 'NULL',\n  gdpr_completed_at_sql: data.gdpr_completed_at || data.gdprCompletedAt ? `'${data.gdpr_completed_at || data.gdprCompletedAt}'::timestamp` : 'NOW()::timestamp'\n};\n\nconsole.log('‚úÖ ƒê√£ format d·ªØ li·ªáu cho PostgreSQL INSERT');\n\nreturn [{ json: result }];"
      },
      "name": "1Ô∏è‚É£1Ô∏è‚É£.5Ô∏è‚É£ Format Data cho PostgreSQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        352
      ],
      "id": "format-data-for-postgres"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO gdpr_compliance_results (\n  processing_id, audit_id, file_name, file_url, cloudinary_url, user_id, department, uploader,\n  analysis_results, gdpr_decision, gdpr_justification, legal_basis, retention_days,\n  redaction_fields, personal_data_found, sensitive_data_detected, data_volume, notify_dpo,\n  status, gdpr_action_performed, ai_decision_timestamp, gdpr_completed_at, workflow_source, flow2_completed\n) VALUES (\n  '{{ $json.processing_id }}',\n  {{ $json.auditId || $json.audit_id ? `'${$json.auditId || $json.audit_id}'` : 'NULL' }},\n  {{ $json.file_name || $json.fileName ? `'${$json.file_name || $json.fileName}'` : 'NULL' }},\n  {{ $json.file_url || $json.fileUrl ? `'${$json.file_url || $json.fileUrl}'` : 'NULL' }},\n  {{ $json.cloudinary_url || $json.cloudinaryUrl ? `'${$json.cloudinary_url || $json.cloudinaryUrl}'` : 'NULL' }},\n  {{ $json.user_id || $json.userId ? `'${$json.user_id || $json.userId}'` : 'NULL' }},\n  {{ $json.department ? `'${$json.department}'` : 'NULL' }},\n  {{ $json.uploader ? `'${$json.uploader}'` : 'NULL' }},\n  {{ $json.analysis_results_sql }},\n  {{ $json.gdpr_decision || $json.gdprDecision ? `'${$json.gdpr_decision || $json.gdprDecision}'` : 'NULL' }},\n  {{ $json.gdpr_justification_sql }},\n  {{ $json.legal_basis_sql }},\n  {{ $json.retention_days || $json.retentionDays || 30 }},\n  {{ $json.redaction_fields_sql }},\n  {{ $json.personal_data_found_sql }},\n  {{ $json.sensitive_data_detected !== undefined ? $json.sensitive_data_detected : ($json.sensitiveDataDetected !== undefined ? $json.sensitiveDataDetected : false) }},\n  {{ $json.data_volume_sql }},\n  {{ $json.notify_dpo !== undefined ? $json.notify_dpo : ($json.notifyDPO !== undefined ? $json.notifyDPO : false) }},\n  '{{ $json.status || 'gdpr_completed' }}',\n  {{ $json.gdpr_action_performed_sql }},\n  {{ $json.ai_decision_timestamp_sql }},\n  {{ $json.gdpr_completed_at_sql }},\n  '{{ $json.workflow_source || 'flow2-gdpr-compliance' }}',\n  {{ $json.flow2_completed !== undefined ? $json.flow2_completed : true }}\n) ON CONFLICT (processing_id) DO UPDATE SET\n  audit_id = EXCLUDED.audit_id,\n  file_name = EXCLUDED.file_name,\n  file_url = EXCLUDED.file_url,\n  cloudinary_url = EXCLUDED.cloudinary_url,\n  user_id = EXCLUDED.user_id,\n  department = EXCLUDED.department,\n  uploader = EXCLUDED.uploader,\n  analysis_results = EXCLUDED.analysis_results,\n  gdpr_decision = EXCLUDED.gdpr_decision,\n  gdpr_justification = EXCLUDED.gdpr_justification,\n  legal_basis = EXCLUDED.legal_basis,\n  retention_days = EXCLUDED.retention_days,\n  redaction_fields = EXCLUDED.redaction_fields,\n  personal_data_found = EXCLUDED.personal_data_found,\n  sensitive_data_detected = EXCLUDED.sensitive_data_detected,\n  data_volume = EXCLUDED.data_volume,\n  notify_dpo = EXCLUDED.notify_dpo,\n  status = EXCLUDED.status,\n  gdpr_action_performed = EXCLUDED.gdpr_action_performed,\n  ai_decision_timestamp = EXCLUDED.ai_decision_timestamp,\n  gdpr_completed_at = EXCLUDED.gdpr_completed_at,\n  updated_at = CURRENT_TIMESTAMP\nRETURNING *;",
        "options": {}
      },
      "name": "1Ô∏è‚É£1Ô∏è‚É£ L∆∞u k·∫øt qu·∫£ GDPR v√†o PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2128,
        352
      ],
      "id": "1425a37a-f1e7-40b3-b2dd-23242095d644"
    },
    {
      "parameters": {
        "jsCode": "// üì§ Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i sang Flow 3 (Document Sharing)\n// L·∫•y d·ªØ li·ªáu t·ª´ PostgreSQL result ho·∫∑c t·ª´ node tr∆∞·ªõc\nconst pgResult = $json || {};\n\n// L·∫•y d·ªØ li·ªáu t·ª´ node chu·∫©n b·ªã data (n·∫øu c·∫ßn)\nlet preparedData = {};\ntry {\n  preparedData = $('1Ô∏è‚É£2Ô∏è‚É£ Chu·∫©n b·ªã Data GDPR ƒë·∫ßy ƒë·ªß').item.json || {};\n} catch (e) {\n  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Prepare node:', e.message);\n}\n\n// Merge d·ªØ li·ªáu: ∆∞u ti√™n PostgreSQL result, sau ƒë√≥ prepared data\nconst dataForFlow3 = {\n  // Th√¥ng tin file c∆° b·∫£n\n  processing_id: pgResult.processing_id || preparedData.processing_id || null,\n  processingId: pgResult.processing_id || preparedData.processing_id || null,\n  file_name: pgResult.file_name || preparedData.file_name || null,\n  fileName: pgResult.file_name || preparedData.file_name || null,\n  file_url: pgResult.file_url || preparedData.file_url || null,\n  fileUrl: pgResult.file_url || preparedData.file_url || null,\n  cloudinary_url: pgResult.cloudinary_url || preparedData.cloudinary_url || null,\n  cloudinaryUrl: pgResult.cloudinary_url || preparedData.cloudinary_url || null,\n  user_id: pgResult.user_id || preparedData.user_id || null,\n  userId: pgResult.user_id || preparedData.user_id || null,\n  department: pgResult.department || preparedData.department || null,\n  uploader: pgResult.uploader || preparedData.uploader || null,\n  \n  // K·∫øt qu·∫£ GDPR t·ª´ Flow 2\n  gdpr_decision: pgResult.gdpr_decision || preparedData.gdpr_decision || null,\n  gdprDecision: pgResult.gdpr_decision || preparedData.gdpr_decision || null,\n  gdpr_justification: pgResult.gdpr_justification || preparedData.gdpr_justification || null,\n  gdprJustification: pgResult.gdpr_justification || preparedData.gdpr_justification || null,\n  legal_basis: pgResult.legal_basis || preparedData.legal_basis || null,\n  legalBasis: pgResult.legal_basis || preparedData.legal_basis || null,\n  retention_days: pgResult.retention_days || preparedData.retention_days || 30,\n  retentionDays: pgResult.retention_days || preparedData.retention_days || 30,\n  \n  // Arrays\n  redaction_fields: pgResult.redaction_fields || preparedData.redaction_fields || [],\n  redactionFields: pgResult.redaction_fields || preparedData.redaction_fields || [],\n  personal_data_found: pgResult.personal_data_found || preparedData.personal_data_found || [],\n  personalDataFound: pgResult.personal_data_found || preparedData.personal_data_found || [],\n  \n  // Flags\n  sensitive_data_detected: pgResult.sensitive_data_detected !== undefined ? pgResult.sensitive_data_detected : (preparedData.sensitive_data_detected !== undefined ? preparedData.sensitive_data_detected : false),\n  sensitiveDataDetected: pgResult.sensitive_data_detected !== undefined ? pgResult.sensitive_data_detected : (preparedData.sensitive_data_detected !== undefined ? preparedData.sensitive_data_detected : false),\n  data_volume: pgResult.data_volume || preparedData.data_volume || null,\n  dataVolume: pgResult.data_volume || preparedData.data_volume || null,\n  notify_dpo: pgResult.notify_dpo !== undefined ? pgResult.notify_dpo : (preparedData.notify_dpo !== undefined ? preparedData.notify_dpo : false),\n  notifyDPO: pgResult.notify_dpo !== undefined ? pgResult.notify_dpo : (preparedData.notify_dpo !== undefined ? preparedData.notify_dpo : false),\n  \n  // Status\n  status: pgResult.status || preparedData.status || 'gdpr_completed',\n  gdpr_action_performed: pgResult.gdpr_action_performed || preparedData.gdpr_action_performed || null,\n  gdprActionPerformed: pgResult.gdpr_action_performed || preparedData.gdpr_action_performed || null,\n  \n  // Timestamps\n  ai_decision_timestamp: pgResult.ai_decision_timestamp || preparedData.ai_decision_timestamp || null,\n  aiDecisionTimestamp: pgResult.ai_decision_timestamp || preparedData.ai_decision_timestamp || null,\n  gdpr_completed_at: pgResult.gdpr_completed_at || preparedData.gdpr_completed_at || null,\n  gdprCompletedAt: pgResult.gdpr_completed_at || preparedData.gdpr_completed_at || null,\n  \n  // Metadata\n  workflow_source: 'flow2-gdpr-compliance',\n  flow2_completed: true,\n  \n  // Note: recipient_emails, recipient_names, sharing_method s·∫Ω ƒë∆∞·ª£c frontend g·ª≠i k√®m\n  // Flow 2 ch·ªâ g·ª≠i d·ªØ li·ªáu GDPR, frontend s·∫Ω th√™m th√¥ng tin chia s·∫ª\n};\n\nconsole.log('‚úÖ ƒê√£ chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i sang Flow 3:');\nconsole.log('   Processing ID:', dataForFlow3.processing_id);\nconsole.log('   File Name:', dataForFlow3.file_name);\nconsole.log('   GDPR Decision:', dataForFlow3.gdpr_decision);\nconsole.log('   Legal Basis:', dataForFlow3.legal_basis);\n\nreturn [{ json: dataForFlow3 }];"
      },
      "name": "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data g·ª≠i Flow 3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        352
      ],
      "id": "prepare-data-for-flow3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n.aidocmanageagent.io.vn/webhook/document-management",
        "authentication": "none",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "name": "1Ô∏è‚É£4Ô∏è‚É£ G·ª≠i d·ªØ li·ªáu sang Flow 3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2360,
        352
      ],
      "id": "send-to-flow3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// üìä Chu·∫©n b·ªã d·ªØ li·ªáu GDPR ƒë·∫ßy ƒë·ªß ƒë·ªÉ l∆∞u v√†o PostgreSQL\n// L·∫•y d·ªØ li·ªáu t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR\nlet gdprData = {};\nlet normalizedData = {};\n\ntry {\n  // L·∫•y t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR (c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin GDPR)\n  gdprData = $('4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR').item.json || {};\n} catch (e) {\n  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Parse node:', e.message);\n}\n\ntry {\n  // L·∫•y t·ª´ node chu·∫©n h√≥a (c√≥ th√¥ng tin file g·ªëc)\n  normalizedData = $('2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o').item.json || {};\n} catch (e) {\n  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Normalize node:', e.message);\n}\n\n// Helper function ƒë·ªÉ convert array th√†nh PostgreSQL array format\nfunction formatArrayForPostgres(arr) {\n  if (!Array.isArray(arr) || arr.length === 0) return [];\n  return arr.map(item => String(item));\n}\n\n// Merge t·∫•t c·∫£ d·ªØ li·ªáu ƒë·ªÉ c√≥ k·∫øt qu·∫£ GDPR ƒë·∫ßy ƒë·ªß\nconst result = {\n  // Audit info\n  auditId: `gdpr_${Date.now()}`,\n  audit_id: `gdpr_${Date.now()}`,\n  timestamp: new Date().toISOString(),\n  \n  // Th√¥ng tin file c∆° b·∫£n\n  processingId: gdprData.processingId || normalizedData.processingId || $json.processingId || null,\n  processing_id: gdprData.processingId || normalizedData.processingId || $json.processingId || null,\n  fileName: gdprData.fileName || normalizedData.fileName || $json.fileName || null,\n  file_name: gdprData.fileName || normalizedData.fileName || $json.fileName || null,\n  fileUrl: gdprData.fileUrl || normalizedData.fileUrl || $json.fileUrl || null,\n  file_url: gdprData.fileUrl || normalizedData.fileUrl || $json.fileUrl || null,\n  cloudinaryUrl: gdprData.cloudinaryUrl || normalizedData.cloudinaryUrl || $json.cloudinaryUrl || null,\n  cloudinary_url: gdprData.cloudinaryUrl || normalizedData.cloudinaryUrl || $json.cloudinaryUrl || null,\n  userId: gdprData.userId || normalizedData.userId || $json.userId || null,\n  user_id: gdprData.userId || normalizedData.userId || $json.userId || null,\n  department: gdprData.department || normalizedData.department || $json.department || null,\n  uploader: gdprData.uploader || normalizedData.uploader || $json.uploader || null,\n  \n  // K·∫øt qu·∫£ ph√¢n t√≠ch t·ª´ Flow 1 (n·∫øu c√≥) - gi·ªØ nguy√™n JSONB\n  analysisResults: gdprData.analysisResults || normalizedData.analysisResults || $json.analysisResults || null,\n  analysis_results: gdprData.analysisResults || normalizedData.analysisResults || $json.analysisResults || null,\n  \n  // K·∫øt qu·∫£ GDPR t·ª´ Flow 2\n  gdprDecision: gdprData.gdprDecision || $json.gdprDecision || null,\n  gdpr_decision: gdprData.gdprDecision || $json.gdprDecision || null,\n  gdprJustification: gdprData.gdprJustification || $json.gdprJustification || null,\n  gdpr_justification: gdprData.gdprJustification || $json.gdprJustification || null,\n  legalBasis: gdprData.legalBasis || $json.legalBasis || null,\n  legal_basis: gdprData.legalBasis || $json.legalBasis || null,\n  retentionDays: gdprData.retentionDays || $json.retentionDays || 30,\n  retention_days: gdprData.retentionDays || $json.retentionDays || 30,\n  \n  // Arrays - gi·ªØ nguy√™n array format ƒë·ªÉ PostgreSQL node x·ª≠ l√Ω\n  redactionFields: formatArrayForPostgres(gdprData.redactionFields || $json.redactionFields || []),\n  redaction_fields: formatArrayForPostgres(gdprData.redactionFields || $json.redactionFields || []),\n  personalDataFound: formatArrayForPostgres(gdprData.personalDataFound || $json.personalDataFound || []),\n  personal_data_found: formatArrayForPostgres(gdprData.personalDataFound || $json.personalDataFound || []),\n  \n  sensitiveDataDetected: gdprData.sensitiveDataDetected !== undefined ? gdprData.sensitiveDataDetected : ($json.sensitiveDataDetected !== undefined ? $json.sensitiveDataDetected : false),\n  sensitive_data_detected: gdprData.sensitiveDataDetected !== undefined ? gdprData.sensitiveDataDetected : ($json.sensitiveDataDetected !== undefined ? $json.sensitiveDataDetected : false),\n  dataVolume: gdprData.dataVolume || $json.dataVolume || null,\n  data_volume: gdprData.dataVolume || $json.dataVolume || null,\n  notifyDPO: gdprData.notifyDPO !== undefined ? gdprData.notifyDPO : ($json.notifyDPO !== undefined ? $json.notifyDPO : false),\n  notify_dpo: gdprData.notifyDPO !== undefined ? gdprData.notifyDPO : ($json.notifyDPO !== undefined ? $json.notifyDPO : false),\n  \n  // Status v√† action\n  status: $json.status || $json.gdprActionPerformed || 'gdpr_completed',\n  gdprActionPerformed: $json.gdprActionPerformed || null,\n  gdpr_action_performed: $json.gdprActionPerformed || null,\n  \n  // Timestamps\n  aiDecisionTimestamp: gdprData.aiDecisionTimestamp || $json.aiDecisionTimestamp || new Date().toISOString(),\n  ai_decision_timestamp: gdprData.aiDecisionTimestamp || $json.aiDecisionTimestamp || new Date().toISOString(),\n  created_at: normalizedData.receivedAt || new Date().toISOString(),\n  updated_at: new Date().toISOString(),\n  gdpr_completed_at: gdprData.aiDecisionTimestamp || $json.aiDecisionTimestamp || new Date().toISOString(),\n  \n  // Metadata\n  workflow_source: 'flow2-gdpr-compliance',\n  flow2_completed: true\n};\n\nconsole.log('‚úÖ ƒê√£ chu·∫©n b·ªã d·ªØ li·ªáu GDPR ƒë·∫ßy ƒë·ªß cho PostgreSQL:');\nconsole.log('   Processing ID:', result.processing_id);\nconsole.log('   File Name:', result.file_name);\nconsole.log('   GDPR Decision:', result.gdpr_decision);\nconsole.log('   Legal Basis:', result.legal_basis);\nconsole.log('   Notify DPO:', result.notify_dpo);\nconsole.log('   Redaction Fields:', result.redaction_fields);\nconsole.log('   Personal Data Found:', result.personal_data_found);\n\nreturn [{ json: result }];"
      },
      "name": "1Ô∏è‚É£2Ô∏è‚É£ Chu·∫©n b·ªã Data GDPR ƒë·∫ßy ƒë·ªß",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        352
      ],
      "id": "1532d717-8c9f-439e-8118-7d59844beae1"
    },
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "gdpr",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "üîç Webhook GET: Query GDPR Result",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        176,
        600
      ],
      "id": "query-gdpr-webhook",
      "webhookId": "query-gdpr-result"
    },
    {
      "parameters": {
        "jsCode": "// üîç Parse processingId t·ª´ query parameter\n// L·∫•y processingId t·ª´ query parameter c·ªßa webhook GET\nconst query = $json.query || {};\nconst processingId = query.processingId || query.processing_id || null;\n\nif (!processingId) {\n  return [{\n    json: {\n      success: false,\n      error: 'Missing processingId parameter',\n      message: 'Vui l√≤ng cung c·∫•p processingId trong query parameter. V√≠ d·ª•: /gdpr?processingId=xxx'\n    }\n  }];\n}\n\n// Tr·∫£ v·ªÅ processingId ƒë·ªÉ node Google Sheets Read c√≥ th·ªÉ query\nreturn [{\n  json: {\n    processingId: processingId,\n    processing_id: processingId,\n    query: query\n  }\n}];"
      },
      "name": "üîç Parse processingId",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        600
      ],
      "id": "query-gdpr-from-sheets"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  id,\n  processing_id,\n  audit_id,\n  file_name,\n  file_url,\n  cloudinary_url,\n  user_id,\n  department,\n  uploader,\n  analysis_results,\n  gdpr_decision,\n  gdpr_justification,\n  legal_basis,\n  retention_days,\n  redaction_fields,\n  personal_data_found,\n  sensitive_data_detected,\n  data_volume,\n  notify_dpo,\n  status,\n  gdpr_action_performed,\n  created_at,\n  updated_at,\n  ai_decision_timestamp,\n  gdpr_completed_at,\n  workflow_source,\n  flow2_completed\nFROM gdpr_compliance_results \nWHERE processing_id = '{{ $json.processingId || $json.processing_id }}' \nORDER BY created_at DESC \nLIMIT 1;",
        "options": {}
      },
      "name": "üîç Query GDPR t·ª´ PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        600,
        600
      ],
      "id": "read-gdpr-from-sheets"
    },
    {
      "parameters": {
        "jsCode": "// üìä Format v√† x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ PostgreSQL\n// PostgreSQL node c√≥ th·ªÉ tr·∫£ v·ªÅ array ho·∫∑c object\nlet pgData = null;\n\n// X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ PostgreSQL\nif (Array.isArray($json)) {\n  // N·∫øu l√† array, l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n\n  pgData = $json.length > 0 ? $json[0] : null;\n} else if ($json && typeof $json === 'object') {\n  // N·∫øu l√† object, d√πng tr·ª±c ti·∫øp\n  pgData = $json;\n} else {\n  // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu\n  pgData = null;\n}\n\n// Ki·ªÉm tra n·∫øu kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu\nif (!pgData || !pgData.processing_id) {\n  return [{\n    json: {\n      success: false,\n      error: 'Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ GDPR v·ªõi processingId n√†y',\n      message: 'Kh√¥ng c√≥ d·ªØ li·ªáu GDPR trong database'\n    }\n  }];\n}\n\n// Format d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß - ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c tr∆∞·ªùng ƒë∆∞·ª£c bao g·ªìm\nconst formattedData = {\n  // ID v√† metadata\n  id: pgData.id || null,\n  processing_id: pgData.processing_id || null,\n  processingId: pgData.processing_id || null,\n  audit_id: pgData.audit_id || null,\n  auditId: pgData.audit_id || null,\n  \n  // Th√¥ng tin file c∆° b·∫£n\n  file_name: pgData.file_name || null,\n  fileName: pgData.file_name || null,\n  file_url: pgData.file_url || null,\n  fileUrl: pgData.file_url || null,\n  cloudinary_url: pgData.cloudinary_url || null,\n  cloudinaryUrl: pgData.cloudinary_url || null,\n  user_id: pgData.user_id || null,\n  userId: pgData.user_id || null,\n  department: pgData.department || null,\n  uploader: pgData.uploader || null,\n  \n  // K·∫øt qu·∫£ ph√¢n t√≠ch t·ª´ Flow 1 (JSONB)\n  analysis_results: pgData.analysis_results || null,\n  analysisResults: pgData.analysis_results || null,\n  \n  // K·∫øt qu·∫£ GDPR t·ª´ Flow 2\n  gdpr_decision: pgData.gdpr_decision || null,\n  gdprDecision: pgData.gdpr_decision || null,\n  gdpr_justification: pgData.gdpr_justification || null,\n  gdprJustification: pgData.gdpr_justification || null,\n  legal_basis: pgData.legal_basis || null,\n  legalBasis: pgData.legal_basis || null,\n  retention_days: pgData.retention_days || 30,\n  retentionDays: pgData.retention_days || 30,\n  \n  // Arrays - ƒë·∫£m b·∫£o lu√¥n l√† array\n  redaction_fields: Array.isArray(pgData.redaction_fields) ? pgData.redaction_fields : (pgData.redaction_fields ? [pgData.redaction_fields] : []),\n  redactionFields: Array.isArray(pgData.redaction_fields) ? pgData.redaction_fields : (pgData.redaction_fields ? [pgData.redaction_fields] : []),\n  personal_data_found: Array.isArray(pgData.personal_data_found) ? pgData.personal_data_found : (pgData.personal_data_found ? [pgData.personal_data_found] : []),\n  personalDataFound: Array.isArray(pgData.personal_data_found) ? pgData.personal_data_found : (pgData.personal_data_found ? [pgData.personal_data_found] : []),\n  \n  // Flags\n  sensitive_data_detected: pgData.sensitive_data_detected !== undefined ? pgData.sensitive_data_detected : false,\n  sensitiveDataDetected: pgData.sensitive_data_detected !== undefined ? pgData.sensitive_data_detected : false,\n  data_volume: pgData.data_volume || null,\n  dataVolume: pgData.data_volume || null,\n  notify_dpo: pgData.notify_dpo !== undefined ? pgData.notify_dpo : false,\n  notifyDPO: pgData.notify_dpo !== undefined ? pgData.notify_dpo : false,\n  \n  // Status v√† action\n  status: pgData.status || 'gdpr_completed',\n  gdpr_action_performed: pgData.gdpr_action_performed || null,\n  gdprActionPerformed: pgData.gdpr_action_performed || null,\n  \n  // Timestamps\n  created_at: pgData.created_at || null,\n  createdAt: pgData.created_at || null,\n  updated_at: pgData.updated_at || null,\n  updatedAt: pgData.updated_at || null,\n  ai_decision_timestamp: pgData.ai_decision_timestamp || null,\n  aiDecisionTimestamp: pgData.ai_decision_timestamp || null,\n  gdpr_completed_at: pgData.gdpr_completed_at || null,\n  gdprCompletedAt: pgData.gdpr_completed_at || null,\n  \n  // Metadata\n  workflow_source: pgData.workflow_source || 'flow2-gdpr-compliance',\n  workflowSource: pgData.workflow_source || 'flow2-gdpr-compliance',\n  flow2_completed: pgData.flow2_completed !== undefined ? pgData.flow2_completed : true,\n  flow2Completed: pgData.flow2_completed !== undefined ? pgData.flow2_completed : true\n};\n\nconsole.log('‚úÖ ƒê√£ format d·ªØ li·ªáu GDPR t·ª´ PostgreSQL:');\nconsole.log('   Processing ID:', formattedData.processing_id);\nconsole.log('   File Name:', formattedData.file_name);\nconsole.log('   GDPR Decision:', formattedData.gdpr_decision);\nconsole.log('   Legal Basis:', formattedData.legal_basis);\nconsole.log('   Redaction Fields:', formattedData.redaction_fields);\nconsole.log('   Personal Data Found:', formattedData.personal_data_found);\nconsole.log('   Analysis Results:', formattedData.analysis_results ? 'C√≥' : 'Kh√¥ng c√≥');\n\nreturn [{\n  json: {\n    success: true,\n    data: formattedData\n  }\n}];"
      },
      "name": "üìã Format d·ªØ li·ªáu GDPR t·ª´ PostgreSQL",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        600
      ],
      "id": "format-gdpr-data-from-postgres"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "name": "üì§ Tr·∫£ v·ªÅ k·∫øt qu·∫£ GDPR",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        800,
        600
      ],
      "id": "respond-gdpr-result"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gdpr-compliance",
        "options": {}
      },
      "name": "1Ô∏è‚É£ Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        176,
        352
      ],
      "id": "4cb1e81b-bd99-4ac2-bc0d-f2b6589c2577",
      "webhookId": "gdpr-compliance-webhook"
    }
  ],
  "pinData": {},
  "connections": {
    "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o": {
      "main": [
        [
          {
            "node": "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary": {
      "main": [
        [
          {
            "node": "2.6Ô∏è‚É£ Merge File Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.6Ô∏è‚É£ Merge File Data": {
      "main": [
        [
          {
            "node": "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ AI GDPR Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ AI GDPR Decision": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7.8 Merge Actions": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£2Ô∏è‚É£ Chu·∫©n b·ªã Data GDPR ƒë·∫ßy ƒë·ªß",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£2Ô∏è‚É£ Chu·∫©n b·ªã Data GDPR ƒë·∫ßy ƒë·ªß": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£1Ô∏è‚É£.5Ô∏è‚É£ Format Data cho PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£1Ô∏è‚É£.5Ô∏è‚É£ Format Data cho PostgreSQL": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£1Ô∏è‚É£ L∆∞u k·∫øt qu·∫£ GDPR v√†o PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£1Ô∏è‚É£ L∆∞u k·∫øt qu·∫£ GDPR v√†o PostgreSQL": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data g·ª≠i Flow 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data g·ª≠i Flow 3": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£4Ô∏è‚É£ G·ª≠i d·ªØ li·ªáu sang Flow 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£4Ô∏è‚É£ G·ª≠i d·ªØ li·ªáu sang Flow 3": {
      "main": []
    },
    "üîç Webhook GET: Query GDPR Result": {
      "main": [
        [
          {
            "node": "üîç Parse processingId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Parse processingId": {
      "main": [
        [
          {
            "node": "üîç Query GDPR t·ª´ PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Query GDPR t·ª´ PostgreSQL": {
      "main": [
        [
          {
            "node": "üìã Format d·ªØ li·ªáu GDPR t·ª´ PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Format d·ªØ li·ªáu GDPR t·ª´ PostgreSQL": {
      "main": [
        [
          {
            "node": "üì§ Tr·∫£ v·ªÅ k·∫øt qu·∫£ GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Webhook Trigger": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "775bb188-57b6-4b9f-b5f4-c1d457b64bbb",
  "meta": {
    "instanceId": "d29aff038a4897a8be0d9843c07ba06d6b485556105b19c20835a7b0bfd5b9b2"
  },
  "id": "u47swad2UNGjafFK",
  "tags": []
}