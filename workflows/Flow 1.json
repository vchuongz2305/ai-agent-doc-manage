{
  "name": "Test 2",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Script ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu t·ª´ Aggregate node v√† l∆∞u v√†o Postgres\nconst aggregateData = $json; // L·∫•y d·ªØ li·ªáu tr·ª±c ti·∫øp t·ª´ Aggregate node\nconst fileData = $('Set File Data').item.json;\n\n// Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ l∆∞u v√†o Postgres\nconst dataToSave = {\n  processing_id: fileData.processingId,\n  file_name: fileData.name,\n  file_url: fileData.file_url,\n  user_id: fileData.userId,\n  department: fileData.department,\n  status: 'completed',\n  analysis_results: aggregateData,\n  cloudinary_url: fileData.cloudinary_url || fileData.file_url,\n  docx_url: '', // Kh√¥ng c√≥ Google Docs URL\n  created_at: new Date().toISOString(),\n  updated_at: new Date().toISOString(),\n  analysis_completed_at: new Date().toISOString()\n};\n\nreturn [{\n  json: dataToSave\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2016,
        1648
      ],
      "id": "71b22cc7-7cdb-4297-b95d-52956dee8208",
      "name": "Save to Postgres Script"
    },
    {
      "parameters": {
        "jsCode": "// Script ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Postgres node v√† format ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 2 (GDPR Compliance)\n// Postgres tr·∫£ v·ªÅ d·ªØ li·ªáu trong $json, c√≥ th·ªÉ l√† array ho·∫∑c object\nlet postgresResult = $json;\n\n// N·∫øu l√† array, l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n\nif (Array.isArray(postgresResult)) {\n  postgresResult = postgresResult[0] || postgresResult;\n}\n\n// N·∫øu Postgres tr·∫£ v·ªÅ d·∫°ng { rows: [...] }, l·∫•y rows\nif (postgresResult && postgresResult.rows && Array.isArray(postgresResult.rows)) {\n  postgresResult = postgresResult.rows[0] || {};\n}\n\n// L·∫•y fileData t·ª´ Set File Data\nconst fileData = $('Set File Data').item.json;\n\n// Format d·ªØ li·ªáu ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 2 (GDPR Compliance webhook)\n// Flow 2 c·∫ßn: file info, analysis_results, processing_id, cloudinary_url, docx_url\nconst responseData = {\n  success: true,\n  processingId: postgresResult.processing_id || fileData.processingId || '',\n  message: \"Document analysis completed\",\n  // D·ªØ li·ªáu ch√≠nh ƒë·ªÉ Flow 2 x·ª≠ l√Ω\n  data: {\n    processing_id: postgresResult.processing_id || fileData.processingId || '',\n    file_name: postgresResult.file_name || fileData.name || '',\n    file_url: postgresResult.file_url || fileData.file_url || '',\n    user_id: postgresResult.user_id || fileData.userId || '',\n    department: postgresResult.department || fileData.department || '',\n    status: postgresResult.status || 'completed',\n    analysis_results: postgresResult.analysis_results || null,\n    cloudinary_url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    docx_url: postgresResult.docx_url || '', // Google Docs URL\n    created_at: postgresResult.created_at || new Date().toISOString(),\n    updated_at: postgresResult.updated_at || new Date().toISOString(),\n    analysis_completed_at: postgresResult.analysis_completed_at || new Date().toISOString()\n  },\n  // Th√¥ng tin file ƒë·ªÉ Flow 2 download v√† ph√¢n t√≠ch\n  file: {\n    name: postgresResult.file_name || fileData.name || '',\n    url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    cloudinary_url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    processingId: postgresResult.processing_id || fileData.processingId || ''\n  }\n};\n\nconsole.log('üì§ Sending data to Flow 2 (GDPR Compliance):', JSON.stringify(responseData, null, 2));\n\nreturn [{\n  json: responseData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        1648
      ],
      "id": "2e2c93dd-c026-4aea-8a18-75f3fae24785",
      "name": "Retrieve from Postgres Script"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n.aidocmanageagent.io.vn/webhook/gdpr-compliance",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1312,
        1648
      ],
      "id": "5a51adb2-f005-46be-994c-b1a4a6d9d38d",
      "name": "Send HTTP Request to Flow 2",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "document-analyzer",
        "responseMode": "responseNode",
        "options": {
          "rawBody": true
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2272,
        720
      ],
      "id": "89bcf1e6-01da-4080-b74a-e9528294c4cc",
      "name": "Webhook",
      "webhookId": "8c724e88-5a5d-4919-82ba-760f48bf341f"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Document processing started\",\n  \"processingId\": \"{{ $json.body.processingId || $json.processingId || 'unknown' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -2064,
        512
      ],
      "id": "772a28ff-f332-4f4d-918f-4ad9ae0294e0",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// Delay 5 gi√¢y tr∆∞·ªõc khi g·ªçi Gemini API ƒë·ªÉ tr√°nh rate limit\nconsole.log('‚è≥ Waiting 5 seconds before AI call...');\nawait new Promise(resolve => setTimeout(resolve, 5000));\nconsole.log('‚úÖ Wait completed, proceeding to AI node');\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2128,
        1312
      ],
      "id": "e240ef14-1f9e-4a3f-adcf-990bc1e723c3",
      "name": "Wait Before AI"
    },
    {
      "parameters": {
        "jsCode": "// Parse k·∫øt qu·∫£ t·ª´ comprehensive_analysis node\nconst aiResult = $json.output || $json;\n\nconsole.log('Raw AI Result:', JSON.stringify(aiResult, null, 2));\n\n// Parse v√† format gi·ªëng nh∆∞ 6 node c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi Merge node\nlet parsed = {};\n\ntry {\n  // N·∫øu AI tr·∫£ v·ªÅ string, parse JSON\n  let parsedData = aiResult;\n  if (typeof aiResult === 'string') {\n    // Lo·∫°i b·ªè markdown code blocks n·∫øu c√≥\n    const cleanJson = aiResult\n      .replace(/```json/gi, '')\n      .replace(/```/g, '')\n      .trim();\n    \n    // T√¨m JSON trong string\n    const jsonMatch = cleanJson.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      parsedData = JSON.parse(jsonMatch[0]);\n    } else {\n      parsedData = JSON.parse(cleanJson);\n    }\n  }\n  \n  // Format ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi Merge node\n  parsed = {\n    // main_theme format\n    main_theme: {\n      output: {\n        main_theme: parsedData.main_theme || \"\"\n      }\n    },\n    \n    // document_summary format\n    document_summary: {\n      output: {\n        document_summary: Array.isArray(parsedData.document_summary) \n          ? parsedData.document_summary \n          : []\n      }\n    },\n    \n    // key_takeaways format\n    key_takeaways: {\n      output: {\n        key_takeaways: Array.isArray(parsedData.key_takeaways) \n          ? parsedData.key_takeaways \n          : []\n      }\n    },\n    \n    // gaps_and_limitations format\n    gaps_and_limitations: {\n      output: {\n        gaps_and_limitations: Array.isArray(parsedData.gaps_and_limitations) \n          ? parsedData.gaps_and_limitations \n          : []\n      }\n    },\n    \n    // follow_up_questions format\n    follow_up_questions: {\n      output: {\n        follow_up_questions: Array.isArray(parsedData.follow_up_questions) \n          ? parsedData.follow_up_questions \n          : []\n      }\n    },\n    \n    // terminology_to_clarify format\n    terminology_to_clarify: {\n      output: {\n        terminology_to_clarify: Array.isArray(parsedData.terminology_to_clarify) \n          ? parsedData.terminology_to_clarify \n          : []\n      }\n    }\n  };\n  \n  console.log('Parsed Result:', JSON.stringify(parsed, null, 2));\n  \n} catch (error) {\n  console.error('Error parsing AI result:', error);\n  console.error('Raw data:', aiResult);\n  \n  // Fallback v·ªõi empty data\n  parsed = {\n    main_theme: { output: { main_theme: \"Error parsing AI result\" } },\n    document_summary: { output: { document_summary: [] } },\n    key_takeaways: { output: { key_takeaways: [] } },\n    gaps_and_limitations: { output: { gaps_and_limitations: [] } },\n    follow_up_questions: { output: { follow_up_questions: [] } },\n    terminology_to_clarify: { output: { terminology_to_clarify: [] } }\n  };\n}\n\n// Return format t∆∞∆°ng th√≠ch v·ªõi Merge node\nreturn [{\n  json: {\n    name: $('Set File Data').item.json.name,\n    main_theme: parsed.main_theme,\n    document_summary: parsed.document_summary,\n    key_takeaways: parsed.key_takeaways,\n    gaps_and_limitations: parsed.gaps_and_limitations,\n    follow_up_questions: parsed.follow_up_questions,\n    terminology_to_clarify: parsed.terminology_to_clarify\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        1296
      ],
      "id": "f6a01693-9f6d-46b0-81a2-235890fe6f8e",
      "name": "Parse Combined Result"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**Document Title:** {{ $('Set File Data').item.json.name }}\n\n**Document Text:** {{ $json.text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=YOU ARE A COMPREHENSIVE DOCUMENT ANALYSIS AGENT. YOU MUST ANALYZE A DOCUMENT AND EXTRACT ALL INFORMATION ACCURATELY, THEN OUTPUT ALL ANALYSIS RESULTS IN A SINGLE JSON OBJECT.\n\nYOUR TASK:\n1. CAREFULLY READ AND EXTRACT ALL INFORMATION from the document text (names, numbers, emails, IDs, passwords, dates, addresses, etc.)\n2. Identify the main theme and purpose of the document\n3. Create a detailed section-by-section summary with ALL extracted data\n4. Extract key takeaways including all personal information found\n5. Identify gaps and limitations (missing information)\n6. Generate relevant follow-up questions based on document type\n7. Clarify any terminology or abbreviations found\n\nCRITICAL EXTRACTION RULES:\n- Extract ALL personal information: names, phone numbers, emails, IDs (CCCD/CMND), passwords, addresses, dates\n- Extract ALL numbers, codes, and identifiers exactly as they appear\n- Extract ALL dates and timestamps\n- Preserve exact formatting and spelling\n- Do NOT modify or summarize extracted data - use exact values\n- If information is missing, note it in gaps_and_limitations\n\nOUTPUT FORMAT (MANDATORY JSON):\n{\n  \"main_theme\": \"Three sentences describing: document type/topic, purpose/use case, target audience/who it's for\",\n  \"document_summary\": [\n    {\n      \"section_title\": \"Exact section name or field name from document\",\n      \"content\": \"Detailed summary including ALL extracted values. For example: 'H·ªç v√† T√™n: Tr·∫ßn H√† Duy, S·ªë ƒëi·ªán tho·∫°i: 0967125575, Email: haduy@gmail.com' - include ALL fields and their values\"\n    }\n  ],\n  \"key_takeaways\": [\n    {\n      \"point\": \"Specific information extracted (e.g., 'Personal identification information found', 'Contact details provided')\",\n      \"context\": \"Detailed explanation with actual values extracted (e.g., 'Document contains: Name: Tr·∫ßn H√† Duy, Phone: 0967125575, Email: haduy@gmail.com, CCCD: 03949582948')\"\n    }\n  ],\n  \"gaps_and_limitations\": [\n    {\n      \"issue\": \"Missing information or incomplete data (e.g., 'Missing address', 'No date of birth provided')\",\n      \"reason\": \"Why this gap matters or what impact it has\"\n    }\n  ],\n  \"follow_up_questions\": [\n    \"Relevant question based on document type (e.g., 'Is this information for account registration?', 'What is the purpose of collecting this personal data?')\"\n  ],\n  \"terminology_to_clarify\": [\n    {\n      \"term\": \"Term or abbreviation found (e.g., 'CCCD', 'CMND')\",\n      \"explanation\": \"Definition or meaning of the term\"\n    }\n  ]\n}\n\nREQUIREMENTS:\n- Return ONLY valid JSON, no markdown code blocks (no ```json)\n- All fields are required\n- Be SPECIFIC and ACCURATE - include actual extracted values in summaries\n- main_theme: 3 sentences describing document type, purpose, and audience\n- document_summary: Array of sections - each section MUST include ALL extracted data from that section with exact values\n- key_takeaways: 3-7 items - each MUST reference actual extracted information with values\n- gaps_and_limitations: 1-5 items - identify what information is missing\n- follow_up_questions: 3-7 relevant questions based on document content\n- terminology_to_clarify: Array of terms/abbreviations found with explanations\n\nIMPORTANT:\n- Do NOT wrap output in markdown code blocks\n- Output must be valid JSON that can be parsed directly\n- All arrays must have at least 1 item\n- Include ALL extracted information in document_summary and key_takeaways\n- Be detailed and comprehensive - do not summarize away important data\n- Preserve exact values from the document (names, numbers, emails, etc.)"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -1904,
        1328
      ],
      "id": "569e579b-069b-4a70-a4c8-1853e3ec2485",
      "name": "comprehensive_analysis",
      "settings": {
        "errorHandling": {
          "retry": {
            "enabled": true,
            "maxRetries": 5,
            "retryDelay": 10000
          }
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO documents (processing_id, file_name, file_url, user_id, department, status, analysis_results, cloudinary_url, docx_url, created_at, updated_at, analysis_completed_at) VALUES ('{{ $json.processing_id }}', '{{ $json.file_name }}', '{{ $json.file_url }}', '{{ $json.user_id }}', '{{ $json.department }}', '{{ $json.status }}', '{{ JSON.stringify($json.analysis_results).replace(/'/g, \"''\") }}'::jsonb, '{{ $json.cloudinary_url }}', '{{ $json.docx_url || '' }}', '{{ $json.created_at }}'::timestamp, '{{ $json.updated_at }}'::timestamp, '{{ $json.analysis_completed_at }}'::timestamp) ON CONFLICT (processing_id) DO UPDATE SET status = EXCLUDED.status, analysis_results = EXCLUDED.analysis_results, cloudinary_url = EXCLUDED.cloudinary_url, docx_url = COALESCE(NULLIF(EXCLUDED.docx_url, ''), documents.docx_url), updated_at = EXCLUDED.updated_at::timestamp, analysis_completed_at = EXCLUDED.analysis_completed_at::timestamp RETURNING *;",
        "options": {}
      },
      "id": "3f4ba535-0b6f-4e79-9560-d09a34fe4b19",
      "name": "Save Analysis to Postgres",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1808,
        1648
      ],
      "credentials": {
        "postgres": {
          "id": "lYVcMJl3c3m62cYc",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -2256,
        1648
      ],
      "id": "071863e0-b7e3-4c76-a486-177758883036",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "numberInputs": 1
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -2432,
        1568
      ],
      "id": "d72778f1-99ec-4a33-8728-567c17cff5f1",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"main_theme\": \"Document type and content overview in three sentences: (1) What type of document this is and its primary topic, (2) The main purpose or objective of the document, (3) Who the intended audience or users are. Example: 'This is a business contract document outlining service terms and conditions. Its purpose is to establish legal obligations between parties. The target audience includes legal teams, business managers, and involved stakeholders.'\",\n  \"document_summary\": [\n    {\n      \"section_title\": \"Section or category name from the document (e.g., 'Introduction', 'Terms and Conditions', 'Personal Information', 'Financial Summary', 'Technical Specifications')\",\n      \"content\": \"Detailed summary of this section including ALL extracted data, values, dates, names, numbers, and key information. For personal info: 'H·ªç v√† T√™n: Tr·∫ßn H√† Duy, S·ªë ƒëi·ªán tho·∫°i: 0967125575, Email: haduy@gmail.com'. For contracts: 'Parties: Company A and Company B, Contract Date: 2024-01-15, Duration: 12 months, Value: $50,000'. For reports: 'Report covers Q1 2024 performance, Revenue: $1.2M, Growth: 15%, Key metrics: 250 customers, 95% satisfaction'.\"\n    }\n  ],\n  \"key_takeaways\": [\n    {\n      \"point\": \"Main finding or important information extracted (e.g., 'Contract value and duration', 'Personal identification data found', 'Financial performance metrics', 'Technical requirements specified')\",\n      \"context\": \"Detailed explanation with actual extracted values. Examples: 'Document contains contract between Company A and B valued at $50,000 for 12 months starting 2024-01-15' OR 'Document contains personal information: Name: Tr·∫ßn H√† Duy, Phone: 0967125575, Email: haduy@gmail.com, CCCD: 03949582948' OR 'Q1 2024 report shows revenue of $1.2M with 15% growth and 250 active customers'\"\n    },\n    {\n      \"point\": \"Another important finding or data point\",\n      \"context\": \"Detailed explanation with specific values and context\"\n    },\n    {\n      \"point\": \"Additional key information or insight\",\n      \"context\": \"Detailed explanation with extracted data\"\n    }\n  ],\n  \"gaps_and_limitations\": [\n    {\n      \"issue\": \"Missing or incomplete information identified (e.g., 'Missing signature date', 'No contact address provided', 'Incomplete financial breakdown', 'Unclear technical specifications')\",\n      \"reason\": \"Why this gap matters or what impact it has (e.g., 'Signature date is required for contract validity' OR 'Address needed for complete profile' OR 'Financial breakdown needed for budget planning')\"\n    },\n    {\n      \"issue\": \"Another limitation or missing information\",\n      \"reason\": \"Explanation of why this matters\"\n    }\n  ],\n  \"follow_up_questions\": [\n    \"Relevant question based on document type and content. For personal info: 'What is the purpose of collecting this personal information?' For contracts: 'What are the key terms and obligations?' For reports: 'What are the main performance indicators?' For technical docs: 'What are the technical requirements and specifications?'\",\n    \"Another relevant question based on document content\",\n    \"Additional question to clarify or understand the document better\",\n    \"Question about data security, compliance, or next steps if applicable\"\n  ],\n  \"terminology_to_clarify\": [\n    {\n      \"term\": \"Technical term, abbreviation, or specialized vocabulary found in document (e.g., 'CCCD', 'GDPR', 'SLA', 'ROI', 'API', 'NDA')\",\n      \"explanation\": \"Clear definition or explanation of the term. Example: 'CCCD - CƒÉn c∆∞·ªõc c√¥ng d√¢n, Vietnamese Citizen ID Card' OR 'SLA - Service Level Agreement, defines expected service performance' OR 'GDPR - General Data Protection Regulation, EU data privacy law'\"\n    }\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -1760,
        1184
      ],
      "id": "b33d0da6-81c5-4570-94da-b6ab04310107",
      "name": "Structured Output Parser - Comprehensive"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1648,
        704
      ],
      "id": "fbce9a2a-c446-4542-8228-fb2f7149de78",
      "name": "2nd Loop Over Items"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1984,
        720
      ],
      "id": "9b34b150-f5fd-4abd-b158-abfa3fd45f21",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "url": "={{ $('Set File Data').item.json.cloudinary_url || $('Set File Data').item.json.file_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "24083e37-b21f-47ed-90ed-0c4ff33e0622",
      "name": "Download File From URL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1424,
        720
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0f8bc803-94c0-4689-92de-1ae03bc6e1a0",
              "name": "name",
              "value": "={{ $json.body.file.name || $json.file.name || $json.name || 'document.pdf' }}",
              "type": "string"
            },
            {
              "id": "b215de7b-64c4-4125-8d5e-4445b5a7f85a",
              "name": "file_url",
              "value": "={{ $json.body.file.url || $json.file.url || $json.fileUrl }}",
              "type": "string"
            },
            {
              "id": "c3d4e5f6-7890-1234-5678-9abcdef01234",
              "name": "processingId",
              "value": "={{ $json.body.processingId || $json.processingId }}",
              "type": "string"
            },
            {
              "id": "d4e5f6a7-8901-2345-6789-bcdef0123456",
              "name": "userId",
              "value": "={{ $json.body.userId || $json.userId }}",
              "type": "string"
            },
            {
              "id": "e5f6a7b8-9012-3456-789a-cdef01234567",
              "name": "department",
              "value": "={{ $json.body.department || $json.department }}",
              "type": "string"
            },
            {
              "id": "f6a7b8c9-0123-4567-890a-bcdef0123456",
              "name": "cloudinary_url",
              "value": "={{ $json.body.file.cloudinary_url || $json.body.file.url || $json.file.cloudinary_url || $json.file.url }}",
              "type": "string"
            },
            {
              "id": "a7b8c9d0-1234-5678-901a-cdef01234567",
              "name": "cloudinary_public_id",
              "value": "={{ $json.body.file.cloudinary_public_id || $json.file.cloudinary_public_id }}",
              "type": "string"
            },
            {
              "id": "b8c9d0e1-2345-6789-012a-bcdef0123456",
              "name": "webhook_url",
              "value": "={{ $json.body.webhook_url || $json.webhook_url || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "4e9c4a57-3f02-4dfb-9adc-266201a1f6d5",
      "name": "Set File Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1824,
        864
      ]
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "7033b920-b992-43cf-b470-0bb5a53d3c5a",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -1200,
        720
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1920,
        1184
      ],
      "id": "f5d1f02b-676a-4576-8f91-bf18b2ba54ac",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "xGgK6hMSasvuPMXj",
          "name": "Google Gemini(PaLM) Api account 5"
        }
      }
    },
    {
      "parameters": {
        "content": "Dang Hong Nguyen - Analyze",
        "height": 1472,
        "width": 1728
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2592,
        368
      ],
      "typeVersion": 1,
      "id": "adc96094-45c2-4b8c-b67b-4bd5cb79c621",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### LU·ªíNG 2: AI DOCUMENT MANAGEMENT AGENT ‚Äì GDPR COMPLIANCE (Fixed Clean)\n\n**M·ª•c ƒë√≠ch:** T·ª± ƒë·ªông ki·ªÉm tra tu√¢n th·ªß GDPR cho t√†i li·ªáu.\n\n**T√≠nh nƒÉng ch√≠nh:**\n‚Ä¢ AI quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông GDPR (delete/anonymize/allow)\n‚Ä¢ X√°c ƒë·ªãnh legal basis, DSR, retention\n‚Ä¢ T·ª± ƒë·ªông th√¥ng b√°o DPO khi c·∫ßn\n‚Ä¢ Ghi log v√† audit trail ƒë·∫ßy ƒë·ªß.\n\n**C·∫£i ti·∫øn:**\n‚Ä¢ S·ª≠a l·ªói ph√¢n nh√°nh If/Else chu·∫©n.\n‚Ä¢ Th√™m Merge node ƒë·ªÉ h·ª£p nh·∫•t c√°c nh√°nh h√†nh ƒë·ªông."
      },
      "name": "üìã M√¥ t·∫£ Lu·ªìng GDPR",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -384,
        352
      ],
      "id": "4b5912dd-3f90-4ead-9d60-8da39f68d0b7"
    },
    {
      "parameters": {
        "jsCode": "// üß© Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o cho ki·ªÉm tra GDPR\n// H·ªó tr·ª£ nhi·ªÅu c·∫•u tr√∫c d·ªØ li·ªáu: document analyzer response, direct webhook, Google Drive trigger\nconst input = $json ?? {};\nconst body = input.body ?? {};\n\n// üîç Debug: Log input structure\nconsole.log('üì• Input structure:', JSON.stringify(input, null, 2).substring(0, 500));\n\n// üîç Parse webhook response t·ª´ document analyzer (c·∫•u tr√∫c m·ªõi)\nlet webhookData = null;\nlet processingId = null;\nlet cloudinaryUrl = null;\nlet fileUrl = null;\nlet fileName = null;\nlet userId = null;\nlet department = null;\nlet analysisResults = null;\nlet fileSize = null;\nlet mimeType = null;\nlet fileId = null;\n\n// ============================================\n// CASE 1: Document Analyzer Response (c√≥ success, processingId, data)\n// ============================================\nif (input.success !== undefined || body.success !== undefined) {\n  const response = input.success !== undefined ? input : body;\n  \n  // L·∫•y processingId\n  processingId = response.processingId || response.data?.processing_id || response.processing_id || null;\n  \n  // L·∫•y th√¥ng tin file t·ª´ data object\n  if (response.data) {\n    fileUrl = response.data.file_url || null;\n    cloudinaryUrl = response.data.cloudinary_url || response.data.file_url || null;\n    fileName = response.data.file_name || null;\n    userId = response.data.user_id || null;\n    department = response.data.department || null;\n    analysisResults = response.data.analysis_results || null;\n  }\n  \n  webhookData = response;\n  console.log('‚úÖ Parsed webhook response from document analyzer');\n  console.log('   Processing ID:', processingId);\n  console.log('   Cloudinary URL:', cloudinaryUrl);\n  console.log('   File Name:', fileName);\n}\n\n// ============================================\n// CASE 2: Direct webhook v·ªõi body.file (t·ª´ h√¨nh ·∫£nh)\n// ============================================\n// Lu√¥n ki·ªÉm tra body.file n·∫øu c√≥, ho·∫∑c n·∫øu ch∆∞a c√≥ processingId v√† cloudinaryUrl\nif (body.file || (!processingId && !cloudinaryUrl)) {\n  // L·∫•y t·ª´ body.file (n·∫øu c√≥)\n  if (body.file) {\n    fileName = fileName || body.file.name || null;\n    fileSize = body.file.size || null;\n    mimeType = body.file.mimeType || body.file.mime_type || null;\n    // QUAN TR·ªåNG: L·∫•y cloudinary_url t·ª´ body.file\n    cloudinaryUrl = cloudinaryUrl || body.file.cloudinary_url || body.file.url || body.file.cloudinaryUrl || null;\n    fileUrl = fileUrl || cloudinaryUrl || null;\n    console.log('‚úÖ Found file info in body.file');\n    console.log('   File Name:', fileName);\n    console.log('   File Size:', fileSize);\n    console.log('   MIME Type:', mimeType);\n    console.log('   Cloudinary URL:', cloudinaryUrl);\n  }\n  \n  // L·∫•y processingId t·ª´ nhi·ªÅu ngu·ªìn\n  processingId = processingId || \n    input.processingId || \n    body.processingId || \n    input.processing_id || \n    body.processing_id || \n    null;\n  \n  // L·∫•y cloudinary_url t·ª´ nhi·ªÅu ngu·ªìn\n  cloudinaryUrl = cloudinaryUrl || \n    input.cloudinary_url || \n    body.cloudinary_url || \n    input.cloudinaryUrl || \n    body.cloudinaryUrl || \n    input.file_url || \n    body.file_url || \n    null;\n  \n  // L·∫•y file_url\n  fileUrl = fileUrl || cloudinaryUrl || null;\n  \n  // L·∫•y user_id\n  userId = userId || \n    input.user_id || \n    body.user_id || \n    input.userId || \n    body.userId || \n    null;\n  \n  // L·∫•y department\n  department = department || \n    input.department || \n    body.department || \n    null;\n  \n  // L·∫•y analysis_results\n  analysisResults = analysisResults || \n    input.analysis_results || \n    body.analysis_results || \n    null;\n}\n\n// ============================================\n// CASE 3: Google Drive Trigger (fallback)\n// ============================================\nif (!fileUrl && !cloudinaryUrl) {\n  try {\n    fileId = input.id || body.id || null;\n    fileName = fileName || input.name || body.name || null;\n    fileSize = fileSize || input.size || body.size || null;\n    mimeType = mimeType || input.mimeType || body.mimeType || null;\n    \n    // T·∫°o URL Google Drive\n    if (fileId) {\n      fileUrl = `https://drive.google.com/file/d/${fileId}/view`;\n      console.log('‚úÖ Using Google Drive file info');\n    }\n  } catch (e) {\n    console.warn('‚ö†Ô∏è L·ªói khi x·ª≠ l√Ω th√¥ng tin Google Drive:', e.message);\n  }\n}\n\n// üîç Th·ª≠ l·∫•y email c·ªßa ch·ªß s·ªü h·ªØu t·ª´ output Google Drive Trigger (fallback)\nlet ownerEmail = null;\ntry {\n  ownerEmail =\n    input.owners?.[0]?.emailAddress ||\n    body.owners?.[0]?.emailAddress ||\n    input.lastModifyingUser?.emailAddress ||\n    userId || // D√πng user_id t·ª´ webhook n·∫øu c√≥\n    null;\n} catch (e) {\n  ownerEmail = null;\n}\n\n// üß± Format file size n·∫øu c√≥\nlet formattedFileSize = '1.0MB';\nif (fileSize) {\n  if (typeof fileSize === 'number') {\n    // Convert bytes to readable format\n    if (fileSize < 1024) {\n      formattedFileSize = `${fileSize}B`;\n    } else if (fileSize < 1024 * 1024) {\n      formattedFileSize = `${(fileSize / 1024).toFixed(2)}KB`;\n    } else {\n      formattedFileSize = `${(fileSize / (1024 * 1024)).toFixed(2)}MB`;\n    }\n  } else {\n    formattedFileSize = fileSize.toString();\n  }\n}\n\n// üß± D·ªØ li·ªáu m·∫´u (fallback khi thi·∫øu input)\nconst defaultData = {\n  documentTitle: fileName || 'T√†i li·ªáu m·∫´u - GDPR Check',\n  documentCategory: 'Nh√¢n s·ª±',\n  documentSummary: analysisResults?.data?.[0]?.document_summary?.output?.[0]?.content || \n                   analysisResults?.document_summary || \n                   'T√†i li·ªáu ch·ª©a d·ªØ li·ªáu c√° nh√¢n c·∫ßn ki·ªÉm tra GDPR',\n  originalFileId: processingId || fileId || 'sample_file_gdpr',\n  fileSize: formattedFileSize,\n  uploadDate: new Date().toISOString(),\n  uploader: ownerEmail || userId || 'privacy@company.com',\n  hasPersonalInfo: true,\n  containsSpecialCategoryData: false,\n  dataSubjectRequest: null,\n  legalBasis: null\n};\n\n// üß† G·ªôp d·ªØ li·ªáu: ∆Øu ti√™n parsed values ‚Üí input ‚Üí body ‚Üí m·∫∑c ƒë·ªãnh\nconst merged = {\n  documentTitle: fileName || input.documentTitle || body.documentTitle || defaultData.documentTitle,\n  documentCategory: input.documentCategory || body.documentCategory || defaultData.documentCategory,\n  documentSummary: input.documentSummary || body.documentSummary || defaultData.documentSummary,\n  originalFileId: processingId || fileId || input.originalFileId || body.originalFileId || defaultData.originalFileId,\n  fileSize: formattedFileSize || input.fileSize || body.fileSize || defaultData.fileSize,\n  uploadDate: input.uploadDate || body.uploadDate || defaultData.uploadDate,\n  uploader: ownerEmail || userId || input.uploader || body.uploader || defaultData.uploader,\n  hasPersonalInfo: input.hasPersonalInfo ?? body.hasPersonalInfo ?? defaultData.hasPersonalInfo,\n  containsSpecialCategoryData: input.containsSpecialCategoryData ?? body.containsSpecialCategoryData ?? defaultData.containsSpecialCategoryData,\n  dataSubjectRequest: input.dataSubjectRequest ?? body.dataSubjectRequest ?? defaultData.dataSubjectRequest,\n  legalBasis: input.legalBasis ?? body.legalBasis ?? defaultData.legalBasis\n};\n\n// üßæ Th√™m metadata h·ªá th·ªëng v√† th√¥ng tin file\nconst result = {\n  receivedAt: new Date().toISOString(),\n  workflowSource: 'gdpr-compliance',\n  processingTimestamp: new Date().toISOString(),\n  // üîó Th√¥ng tin file t·ª´ Cloudinary/webhook\n  fileUrl: fileUrl || cloudinaryUrl || null,\n  cloudinaryUrl: cloudinaryUrl || fileUrl || null, // Cloudinary URL ƒë·ªÉ download\n  fileId: fileId || processingId || null,\n  fileName: fileName || null,\n  mimeType: mimeType || null,\n  processingId: processingId || null, // Processing ID t·ª´ document analyzer\n  userId: userId || null,\n  department: department || null,\n  analysisResults: analysisResults || null, // K·∫øt qu·∫£ ph√¢n t√≠ch t·ª´ document analyzer\n  // üìä Th√¥ng tin Google Drive g·ªëc (n·∫øu c√≥)\n  googleDriveInfo: fileId ? {\n    id: fileId,\n    name: fileName,\n    size: fileSize,\n    mimeType: mimeType,\n    url: fileUrl,\n    owners: input.owners || body.owners || null,\n    lastModifyingUser: input.lastModifyingUser || body.lastModifyingUser || null\n  } : null,\n  // üìã Webhook data g·ªëc (n·∫øu c√≥)\n  webhookData: webhookData || (Object.keys(input).length > 0 ? input : null),\n  ...merged\n};\n\n// üîç Debug: Log k·∫øt qu·∫£ cu·ªëi c√πng\nconsole.log('‚úÖ Normalized data result:');\nconsole.log('   Processing ID:', result.processingId);\nconsole.log('   File Name:', result.fileName);\nconsole.log('   Cloudinary URL:', result.cloudinaryUrl);\nconsole.log('   File URL:', result.fileUrl);\nconsole.log('   User ID:', result.userId);\nconsole.log('   MIME Type:', result.mimeType);\n\n// üßπ D·ªçn undefined/null\nfor (const key in result) {\n  if (result[key] === undefined) result[key] = null;\n  if (typeof result[key] === 'string') result[key] = result[key].trim();\n}\n\n// ‚úÖ Tr·∫£ ra JSON ho√†n ch·ªânh\nreturn [{ json: result }];\n"
      },
      "name": "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        720
      ],
      "id": "caa46724-2740-4c54-b3ec-146b53f7915b"
    },
    {
      "parameters": {
        "url": "={{ $json.cloudinaryUrl || $json.fileUrl }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "name": "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        112,
        720
      ],
      "id": "5edcb9be-844d-47ba-88f5-9ea4af9abe54",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// üîó Merge file binary data v·ªõi JSON data t·ª´ normalization node\n// L·∫•y d·ªØ li·ªáu t·ª´ normalization node (node ƒë·∫ßu ti√™n trong input chain)\nlet normalizedData = {};\ntry {\n  // Th·ª≠ l·∫•y t·ª´ node normalization tr·ª±c ti·∫øp\n  normalizedData = $('2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o').item.json || {};\n} catch (e) {\n  // Fallback: l·∫•y t·ª´ input items\n  const inputItems = $input.all();\n  if (inputItems.length > 0) {\n    normalizedData = inputItems[0].json || {};\n  }\n  // N·∫øu v·∫´n kh√¥ng c√≥, d√πng $json hi·ªán t·∫°i\n  if (Object.keys(normalizedData).length === 0) {\n    normalizedData = $json || {};\n  }\n}\n\n// L·∫•y binary data t·ª´ HTTP Request (file download)\nconst binaryData = $binary?.data || null;\n\n// Merge d·ªØ li·ªáu - gi·ªØ nguy√™n t·∫•t c·∫£ data t·ª´ normalization\nconst result = {\n  ...normalizedData,\n  // Th√¥ng tin file ƒë√£ download\n  fileDownloaded: !!binaryData,\n  fileDownloadTimestamp: binaryData ? new Date().toISOString() : null,\n  downloadStatus: binaryData ? 'success' : 'failed',\n  // Binary data s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông pass qua n8n\n  // C√≥ th·ªÉ access qua $binary trong c√°c node ti·∫øp theo\n};\n\nconsole.log('‚úÖ File downloaded from Cloudinary:', result.cloudinaryUrl);\nconsole.log('   File binary available:', !!binaryData);\nconsole.log('   File name:', result.fileName);\nconsole.log('   Processing ID:', result.processingId);\n\n// Tr·∫£ v·ªÅ v·ªõi binary data (n·∫øu c√≥)\nif (binaryData) {\n  return [{ json: result, binary: $binary }];\n} else {\n  return [{ json: result }];\n}\n"
      },
      "name": "2.6Ô∏è‚É£ Merge File Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        720
      ],
      "id": "5e93eca7-4ff2-4d27-bff0-5a845b745f9b"
    },
    {
      "parameters": {
        "jsCode": "// üìã Chu·∫©n b·ªã prompt chi ti·∫øt v·ªõi t·∫•t c·∫£ data ƒë√£ chu·∫©n h√≥a cho Gemini\nconst data = $json;\nconst binaryData = $binary?.data || null;\n\n// Ki·ªÉm tra c√≥ file PDF kh√¥ng\nif (!binaryData) {\n  console.warn('‚ö†Ô∏è Kh√¥ng c√≥ file PDF binary data!');\n}\n\n// T·∫°o prompt chi ti·∫øt v·ªõi t·∫•t c·∫£ th√¥ng tin\nconst prompt = `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch tu√¢n th·ªß GDPR (General Data Protection Regulation).\n\nNHI·ªÜM V·ª§: Ph√¢n t√≠ch t√†i li·ªáu PDF ƒë√≠nh k√®m v√† ƒë∆∞a ra quy·∫øt ƒë·ªãnh GDPR ph√π h·ª£p.\n\nTH√îNG TIN T√ÄI LI·ªÜU:\n- T√™n file: ${data.fileName || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- Processing ID: ${data.processingId || 'Kh√¥ng c√≥'}\n- Ng∆∞·ªùi upload: ${data.uploader || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- User ID: ${data.userId || 'Kh√¥ng c√≥'}\n- Ph√≤ng ban: ${data.department || 'Kh√¥ng c√≥'}\n- K√≠ch th∆∞·ªõc file: ${data.fileSize || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- MIME Type: ${data.mimeType || 'Kh√¥ng x√°c ƒë·ªãnh'}\n- URL file: ${data.cloudinaryUrl || data.fileUrl || 'Kh√¥ng c√≥'}\n\n${data.analysisResults ? `\nK·∫æT QU·∫¢ PH√ÇN T√çCH TR∆Ø·ªöC ƒê√ì (n·∫øu c√≥):\n${JSON.stringify(data.analysisResults, null, 2)}\n` : ''}\n\nY√äU C·∫¶U PH√ÇN T√çCH:\n1. ƒê·ªçc v√† ph√¢n t√≠ch to√†n b·ªô n·ªôi dung t√†i li·ªáu PDF ƒë√≠nh k√®m\n2. X√°c ƒë·ªãnh c√°c lo·∫°i d·ªØ li·ªáu c√° nh√¢n (PII) c√≥ trong t√†i li·ªáu:\n   - T√™n, ƒë·ªãa ch·ªâ, s·ªë ƒëi·ªán tho·∫°i, email\n   - S·ªë CMND/CCCD, passport\n   - Th√¥ng tin t√†i ch√≠nh (s·ªë t√†i kho·∫£n, th·∫ª t√≠n d·ª•ng)\n   - Th√¥ng tin y t·∫ø\n   - D·ªØ li·ªáu sinh tr·∫Øc h·ªçc\n   - D·ªØ li·ªáu nh·∫°y c·∫£m kh√°c\n3. ƒê√°nh gi√° m·ª©c ƒë·ªô nh·∫°y c·∫£m c·ªßa d·ªØ li·ªáu (cao/trung b√¨nh/th·∫•p)\n4. X√°c ƒë·ªãnh kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu (high/medium/low)\n5. X√°c ƒë·ªãnh c∆° s·ªü ph√°p l√Ω (legal basis) cho vi·ªác x·ª≠ l√Ω d·ªØ li·ªáu:\n   - consent (ƒë·ªìng √Ω)\n   - contract (h·ª£p ƒë·ªìng)\n   - legal obligation (nghƒ©a v·ª• ph√°p l√Ω)\n   - vital interests (l·ª£i √≠ch quan tr·ªçng)\n   - public task (nhi·ªám v·ª• c√¥ng)\n   - legitimate interests (l·ª£i √≠ch h·ª£p ph√°p)\n6. ƒê∆∞a ra quy·∫øt ƒë·ªãnh GDPR:\n   - \"delete\": X√≥a t√†i li·ªáu n·∫øu vi ph·∫°m nghi√™m tr·ªçng GDPR\n   - \"anonymize\": ·∫®n danh h√≥a d·ªØ li·ªáu c√° nh√¢n\n   - \"allow\": Cho ph√©p l∆∞u tr·ªØ n·∫øu tu√¢n th·ªß GDPR\n7. X√°c ƒë·ªãnh c√°c tr∆∞·ªùng c·∫ßn redact (·∫©n danh h√≥a) n·∫øu quy·∫øt ƒë·ªãnh l√† \"anonymize\"\n8. X√°c ƒë·ªãnh th·ªùi gian l∆∞u tr·ªØ (retention days)\n9. X√°c ƒë·ªãnh c√≥ c·∫ßn th√¥ng b√°o DPO (Data Protection Officer) kh√¥ng\n\nƒê·ªäNH D·∫†NG OUTPUT (JSON):\n{\n  \"content\": {\n    \"gdprDecision\": \"delete|anonymize|allow\",\n    \"notifyDPO\": true/false,\n    \"legalBasis\": \"consent|contract|legal_obligation|vital_interests|public_task|legitimate_interests|null\",\n    \"retentionDays\": s·ªë_ng√†y,\n    \"redactionFields\": [\"danh_s√°ch_c√°c_tr∆∞·ªùng_c·∫ßn_·∫©n\"],\n    \"gdprJustification\": \"L√Ω do chi ti·∫øt cho quy·∫øt ƒë·ªãnh\",\n    \"fileUrl\": \"${data.fileUrl || ''}\",\n    \"fileName\": \"${data.fileName || ''}\",\n    \"personalDataFound\": [\"danh_s√°ch_d·ªØ_li·ªáu_c√°_nh√¢n_t√¨m_th·∫•y\"],\n    \"sensitiveDataDetected\": true/false,\n    \"dataVolume\": \"high|medium|low\"\n  },\n  \"finishReason\": \"stop\",\n  \"index\": 0,\n  \"uploader\": \"${data.uploader || ''}\"\n}\n\nQUAN TR·ªåNG:\n- Ph√¢n t√≠ch k·ªπ l∆∞·ª°ng n·ªôi dung PDF\n- ƒê∆∞a ra quy·∫øt ƒë·ªãnh d·ª±a tr√™n c√°c nguy√™n t·∫Øc GDPR\n- Gi·∫£i th√≠ch r√µ r√†ng l√Ω do cho quy·∫øt ƒë·ªãnh\n- Tr·∫£ v·ªÅ JSON ƒë√∫ng ƒë·ªãnh d·∫°ng`;\n\n// L∆∞u prompt v√†o result\nconst result = {\n  ...data,\n  gdprPrompt: prompt,\n  hasPdfBinary: !!binaryData\n};\n\nconsole.log('‚úÖ ƒê√£ chu·∫©n b·ªã prompt cho GDPR analysis');\nconsole.log('   Has PDF binary:', !!binaryData);\nconsole.log('   File name:', data.fileName);\n\n// Tr·∫£ v·ªÅ v·ªõi binary data (n·∫øu c√≥) ƒë·ªÉ Gemini c√≥ th·ªÉ ƒë·ªçc file PDF\nif (binaryData) {\n  return [{ json: result, binary: $binary }];\n} else {\n  return [{ json: result }];\n}"
      },
      "name": "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        720
      ],
      "id": "d2d9a709-14a5-4fe7-87ed-2841d4cb82c4"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "={{ $json.gdprPrompt }}",
        "options": {}
      },
      "name": "3Ô∏è‚É£ AI GDPR Decision",
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        416,
        720
      ],
      "id": "c3867886-5524-41eb-94b7-41a94ecea670",
      "credentials": {
        "googlePalmApi": {
          "id": "XVtVZk5W7pbY5uMP",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// üß† Parse k·∫øt qu·∫£ AI GDPR (Node 4) - FIXED VERSION\nlet ai = {};\nlet raw = '';\nlet clean = '';\nlet match = null;\n\ntry {\n  // üîç L·∫•y text t·ª´ ph·∫£n h·ªìi c·ªßa Gemini\n  raw = $json?.content?.parts?.[0]?.text || $json?.text || JSON.stringify($json);\n\n  // üßπ L√†m s·∫°ch k√Ω hi·ªáu code block\n  clean = raw.replace(/```json/gi, '').replace(/```/g, '').trim();\n\n  // üîé T√¨m ƒëo·∫°n JSON trong text\n  match = clean.match(/\\{[\\s\\S]*\\}/);\n\n  // üßæ Parse JSON\n  ai = JSON.parse(match ? match[0] : clean);\n  console.log(\"‚úÖ Parsed AI JSON:\", ai);\n} catch (error) {\n  console.warn(\"‚ö†Ô∏è Parse error:\", error.message);\n  console.log(\"üìù Raw preview:\", raw?.slice(0, 300));\n\n  // üõü Fallback an to√†n\n  ai = {\n    content: {\n      gdprDecision: \"anonymize\",\n      notifyDPO: true,\n      gdprJustification: \"‚ö†Ô∏è Parsing fallback due to invalid AI output\"\n    },\n    uploader: \"dangnguyen0175@gmail.com\"\n  };\n}\n\n// üß© H·ª£p nh·∫•t d·ªØ li·ªáu ƒë·∫ßu v√†o + k·∫øt qu·∫£ AI\nconst result = {\n  ...$input.first().json,\n  aiRawOutput: raw || null,\n\n  // üß† L·∫•y d·ªØ li·ªáu t·ª´ c·∫•u tr√∫c l·ªìng nhau (ai.content.*)\n  gdprDecision: ai.content?.gdprDecision || ai.gdprDecision || ai.action || \"anonymize\",\n  notifyDPO: !!(ai.content?.notifyDPO ?? ai.notifyDPO),\n  gdprJustification: ai.content?.gdprJustification || ai.gdprJustification || ai.justification || \"N/A\",\n  legalBasis: ai.content?.legalBasis || ai.legalBasis || null,\n  dataSubjectRequest: ai.content?.dataSubjectRequest || ai.dataSubjectRequest || null,\n  retentionDays: ai.content?.retentionDays || ai.retentionDays || 30,\n  redactionFields: ai.content?.redactionFields || ai.redactionFields || [],\n  aiDecisionTimestamp: ai.aiDecisionTimestamp || new Date().toISOString(),\n  uploader: ai.uploader || $input.first().json.uploader || \"dangnguyen0175@gmail.com\",\n  // üîó Th√¥ng tin file t·ª´ AI (n·∫øu c√≥)\n  fileUrl: ai.content?.fileUrl || $input.first().json.fileUrl || null,\n  fileName: ai.content?.fileName || $input.first().json.fileName || null,\n  // üîç Th√¥ng tin ph√¢n t√≠ch n·ªôi dung file\n  personalDataFound: ai.content?.personalDataFound || ai.personalDataFound || [],\n  sensitiveDataDetected: ai.content?.sensitiveDataDetected ?? ai.sensitiveDataDetected ?? false,\n  dataVolume: ai.content?.dataVolume || ai.dataVolume || 'unknown',\n  // üßæ Log th√™m th√¥ng tin tr·∫°ng th√°i parser\n  aiParseStatus: match ? \"success\" : \"fallback\",\n  aiParsed: ai\n};\n\n// üßæ Log k·∫øt qu·∫£ cu·ªëi c√πng ƒë·ªÉ ki·ªÉm tra\nconsole.log(\"üìú GDPR Parsed Result:\", result);\n\nreturn [{ json: result }];\n"
      },
      "name": "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        720
      ],
      "id": "36c916b9-3142-4912-8ea9-c39abbe913d2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.gdprDecision }}",
              "rightValue": "delete",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        704,
        576
      ],
      "id": "135259cd-b8fe-4f5e-9108-80cbc5c6e855"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.gdprDecision }}",
              "rightValue": "anonymize",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        704,
        752
      ],
      "id": "080683e4-d1a3-467f-aea4-335bca1df8de"
    },
    {
      "parameters": {
        "jsCode": "// ===============================================\n// üßπ GDPR ACTION: DELETE / REVOKE DOCUMENT ACCESS\n// ===============================================\n\n// L·∫•y d·ªØ li·ªáu ƒë·∫ßu v√†o\nconst data = $json;\nconst fileId = data.originalFileId || null;\n\n// Bi·∫øn k·∫øt qu·∫£ m·∫∑c ƒë·ªãnh\nlet result = {\n  ...data,\n  gdprActionPerformed: 'delete',\n  status: 'GDPR_REVOKE_APPLIED',\n  deleteSuccess: false,\n  deleteMethod: null,\n  deleteTimestamp: new Date().toISOString(),\n  deleteLog: ''\n};\n\n// N·∫øu c√≥ ID file g·ªëc th√¨ ti·∫øn h√†nh ‚Äúx√≥a‚Äù (ho·∫∑c thu h·ªìi chia s·∫ª)\ntry {\n  if (fileId) {\n    // --- N·∫øu b·∫°n d√πng Google Drive API ---\n    // Gi·∫£ l·∫≠p h√†nh ƒë·ªông g·ªçi API n8n kh√°c (·ªü m√¥i tr∆∞·ªùng th·ª±c, s·∫Ω d√πng node Google Drive Delete)\n    result.deleteMethod = 'revoke_access';\n    result.deleteSuccess = true;\n    result.deleteLog = `T√†i li·ªáu ${fileId} ƒë√£ ƒë∆∞·ª£c thu h·ªìi quy·ªÅn truy c·∫≠p.`;\n  } else {\n    result.deleteLog = 'Kh√¥ng t√¨m th·∫•y originalFileId ƒë·ªÉ x√≥a.';\n  }\n} catch (err) {\n  result.status = 'GDPR_DELETE_FAILED';\n  result.deleteSuccess = false;\n  result.deleteLog = `L·ªói khi x√≥a: ${err.message}`;\n}\n\n// Tr·∫£ v·ªÅ k·∫øt qu·∫£ x·ª≠ l√Ω\nreturn [{ json: result }];\n"
      },
      "name": "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        496
      ],
      "id": "fa779de4-696e-4d57-b5d8-0fbd36786edc"
    },
    {
      "parameters": {
        "jsCode": "// Gi·∫£ l·∫≠p ·∫©n danh/redact\nlet summary = $json.documentSummary || '';\nfor (const f of ($json.redactionFields || [])) summary = summary.replace(new RegExp(f, 'gi'), '[REDACTED]');\nreturn { json: { ...$json, documentSummary: summary, gdprActionPerformed: 'anonymize', status: 'GDPR_ANON_APPLIED' } };"
      },
      "name": "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        752
      ],
      "id": "3f68dc87-f3e7-48a0-8eaf-5d274a34b4c1"
    },
    {
      "parameters": {
        "jsCode": "return { json: { ...$json, gdprActionPerformed: 'allow', status: 'GDPR_ALLOWED' } };"
      },
      "name": "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        944
      ],
      "id": "8613689e-80d7-405c-98a6-78ea7faad0b2"
    },
    {
      "parameters": {},
      "name": "7.8 Merge Actions",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 1,
      "position": [
        976,
        512
      ],
      "id": "9dee6673-3bc2-4277-a1da-145729f8bea7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.notifyDPO }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            },
            {
              "id": "f37a3bfe-bcfc-4d92-b65b-c672411cf81e",
              "leftValue": "={{ $json.notifyDPO }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "name": "8Ô∏è‚É£ C·∫ßn th√¥ng b√°o DPO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1168,
        720
      ],
      "id": "3e7a95d2-57fd-4187-ad63-7bff9ea7ed9a"
    },
    {
      "parameters": {
        "sendTo": "tranhaduy204@gmail.com",
        "subject": "=üîê GDPR Alert: {{ $json.gdprDecision?.toUpperCase() || 'UNKNOWN' }} file requires immediate attention",
        "emailType": "text",
        "message": "=K√≠nh ch√†o DPO,\n\nH·ªá th·ªëng AI GDPR Compliance Agent ƒë√£ ph√°t hi·ªán m·ªôt t√†i li·ªáu vi ph·∫°m quy ƒë·ªãnh GDPR v√† c·∫ßn s·ª± can thi·ªáp ngay l·∫≠p t·ª©c.\n\n**Th√¥ng tin t√†i li·ªáu:**\n- T√™n file: {{ $json.fileName || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- URL file: {{ $json.fileUrl || 'Kh√¥ng c√≥ URL' }}\n- Uploader: {{ $json.uploader || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- Quy·∫øt ƒë·ªãnh x·ª≠ l√Ω: {{ $json.gdprDecision || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- Th√¥ng b√°o DPO: {{ $json.notifyDPO || 'Kh√¥ng' }}\n- C∆° s·ªü ph√°p l√Ω: {{ $json.legalBasis || 'Kh√¥ng c√≥' }}\n\n**üîç Ph√¢n t√≠ch n·ªôi dung file:**\n- D·ªØ li·ªáu c√° nh√¢n t√¨m th·∫•y: {{ $json.personalDataFound && $json.personalDataFound.length > 0 ? $json.personalDataFound.join(', ') : 'Kh√¥ng c√≥' }}\n- D·ªØ li·ªáu nh·∫°y c·∫£m: {{ $json.sensitiveDataDetected ? 'C√≥' : 'Kh√¥ng' }}\n- Kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu: {{ $json.dataVolume || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- C√°c tr∆∞·ªùng c·∫ßn redact: {{ $json.redactionFields && $json.redactionFields.length > 0 ? $json.redactionFields.join(', ') : 'Kh√¥ng c√≥' }}\n\n**L√Ω do quy·∫øt ƒë·ªãnh:**\n{{ $json.gdprJustification || 'Kh√¥ng c√≥ l√Ω do c·ª• th·ªÉ ƒë∆∞·ª£c cung c·∫•p.' }}\n\n**Th·ªùi ƒëi·ªÉm ra quy·∫øt ƒë·ªãnh:** {{ $json.aiDecisionTimestamp || (new Date()).toISOString() }}\n\n**H√†nh ƒë·ªông khuy·∫øn ngh·ªã:**\n- Xem x√©t v√† x√°c nh·∫≠n quy·∫øt ƒë·ªãnh c·ªßa AI\n- Li√™n h·ªá v·ªõi uploader ƒë·ªÉ l√†m r√µ m·ª•c ƒë√≠ch s·ª≠ d·ª•ng d·ªØ li·ªáu\n- Th·ª±c hi·ªán c√°c bi·ªán ph√°p kh·∫Øc ph·ª•c c·∫ßn thi·∫øt\n- C·∫≠p nh·∫≠t ch√≠nh s√°ch b·∫£o m·∫≠t n·∫øu c·∫ßn\n\nTr√¢n tr·ªçng,\n**AI GDPR Compliance Agent**",
        "options": {}
      },
      "name": "9Ô∏è‚É£ G·ª≠i email DPO",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        1360,
        608
      ],
      "id": "80528bf3-a700-4609-834f-e66b48d7558f",
      "webhookId": "02bbf782-9357-4ea4-b78e-664aaad97422",
      "credentials": {
        "gmailOAuth2": {
          "id": "LTZtTwz14XXGyrdz",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// üìß Chu·∫©n b·ªã d·ªØ li·ªáu email cho uploader\n// L·∫•y d·ªØ li·ªáu t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR (node c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin GDPR)\nlet gdprData = {};\n\ntry {\n  // Th·ª≠ l·∫•y t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR tr·ª±c ti·∫øp\n  gdprData = $('4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR').item.json || {};\n  console.log('‚úÖ L·∫•y d·ªØ li·ªáu t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR');\n} catch (e) {\n  // Fallback: l·∫•y t·ª´ input items\n  const inputItems = $input.all();\n  if (inputItems.length > 0) {\n    for (const item of inputItems) {\n      if (item.json && (item.json.gdprDecision || item.json.notifyDPO !== undefined)) {\n        gdprData = item.json;\n        break;\n      }\n    }\n    if (Object.keys(gdprData).length === 0 && inputItems.length > 0) {\n      gdprData = inputItems[0].json || {};\n    }\n  }\n  if (Object.keys(gdprData).length === 0) {\n    gdprData = $json || {};\n  }\n}\n\n// Validate v√† format email address\nfunction isValidEmail(email) {\n  if (!email || typeof email !== 'string') return false;\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  return emailRegex.test(email.trim());\n}\n\n// L·∫•y uploader v√† validate email\nlet uploaderEmail = gdprData.uploader || $json.uploader || null;\n\n// N·∫øu uploader kh√¥ng ph·∫£i email h·ª£p l·ªá, d√πng default\nif (!isValidEmail(uploaderEmail)) {\n  console.warn('‚ö†Ô∏è Uploader kh√¥ng ph·∫£i email h·ª£p l·ªá:', uploaderEmail);\n  console.warn('   S·ª≠ d·ª•ng email m·∫∑c ƒë·ªãnh: dangnguyen0175@gmail.com');\n  uploaderEmail = 'dangnguyen0175@gmail.com';\n}\n\n// Merge t·∫•t c·∫£ d·ªØ li·ªáu GDPR\nconst result = {\n  ...$json, // Gi·ªØ d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc\n  // Ghi ƒë√® b·∫±ng d·ªØ li·ªáu GDPR t·ª´ Parse node\n  uploader: uploaderEmail, // Email ƒë√£ ƒë∆∞·ª£c validate\n  gdprDecision: gdprData.gdprDecision || $json.gdprDecision || 'UNKNOWN',\n  notifyDPO: gdprData.notifyDPO !== undefined ? gdprData.notifyDPO : ($json.notifyDPO !== undefined ? $json.notifyDPO : false),\n  gdprJustification: gdprData.gdprJustification || $json.gdprJustification || 'Kh√¥ng c√≥ l√Ω do ƒë∆∞·ª£c cung c·∫•p.',\n  legalBasis: gdprData.legalBasis || $json.legalBasis || null,\n  retentionDays: gdprData.retentionDays || $json.retentionDays || 30,\n  redactionFields: gdprData.redactionFields || $json.redactionFields || [],\n  personalDataFound: gdprData.personalDataFound || $json.personalDataFound || [],\n  sensitiveDataDetected: gdprData.sensitiveDataDetected !== undefined ? gdprData.sensitiveDataDetected : ($json.sensitiveDataDetected !== undefined ? $json.sensitiveDataDetected : false),\n  dataVolume: gdprData.dataVolume || $json.dataVolume || 'unknown',\n  aiDecisionTimestamp: gdprData.aiDecisionTimestamp || $json.aiDecisionTimestamp || new Date().toISOString(),\n  fileName: gdprData.fileName || $json.fileName || null,\n  fileUrl: gdprData.fileUrl || $json.fileUrl || null,\n  cloudinaryUrl: gdprData.cloudinaryUrl || $json.cloudinaryUrl || null,\n  processingId: gdprData.processingId || $json.processingId || null,\n  userId: gdprData.userId || $json.userId || null\n};\n\nconsole.log('‚úÖ D·ªØ li·ªáu email ƒë√£ chu·∫©n b·ªã:');\nconsole.log('   Uploader email:', result.uploader);\nconsole.log('   GDPR Decision:', result.gdprDecision);\nconsole.log('   File Name:', result.fileName);\nconsole.log('   Legal Basis:', result.legalBasis);\n\nreturn [{ json: result }];"
      },
      "name": "9.5Ô∏è‚É£ Chu·∫©n b·ªã Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        720
      ],
      "id": "b0afb7cc-1512-40d8-9186-5432ced42a80"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.uploader }}",
        "subject": "=üì£ GDPR Result: {{ $json.gdprDecision?.toUpperCase() || 'UNKNOWN' }}",
        "emailType": "text",
        "message": "=K√≠nh ch√†o b·∫°n,\n\nH·ªá th·ªëng AI GDPR Compliance Agent ƒë√£ ho√†n t·∫•t vi·ªác ki·ªÉm tra tu√¢n th·ªß GDPR cho t√†i li·ªáu c·ªßa b·∫°n.\n\n**Th√¥ng tin t√†i li·ªáu:**\n- T√™n file: {{ $json.fileName || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n- Processing ID: {{ $json.processingId || 'Kh√¥ng c√≥' }}\n- URL file: {{ $json.fileUrl || $json.cloudinaryUrl || 'Kh√¥ng c√≥ URL' }}\n\n**üîç K·∫øt qu·∫£ ph√¢n t√≠ch n·ªôi dung:**\n- D·ªØ li·ªáu c√° nh√¢n t√¨m th·∫•y: {{ Array.isArray($json.personalDataFound) && $json.personalDataFound.length > 0 ? $json.personalDataFound.join(', ') : ($json.personalDataFound ? String($json.personalDataFound) : 'Kh√¥ng c√≥') }}\n- D·ªØ li·ªáu nh·∫°y c·∫£m: {{ $json.sensitiveDataDetected ? 'C√≥' : 'Kh√¥ng' }}\n- Kh·ªëi l∆∞·ª£ng d·ªØ li·ªáu: {{ $json.dataVolume || 'Kh√¥ng x√°c ƒë·ªãnh' }}\n\n**K·∫øt qu·∫£ quy·∫øt ƒë·ªãnh GDPR:**\n- Quy·∫øt ƒë·ªãnh x·ª≠ l√Ω: **{{ $json.gdprDecision || 'Kh√¥ng x√°c ƒë·ªãnh' }}**\n- Th√¥ng b√°o DPO: {{ $json.notifyDPO ? 'C√≥' : 'Kh√¥ng' }}\n- C∆° s·ªü ph√°p l√Ω: {{ $json.legalBasis || 'Kh√¥ng c√≥' }}\n- Th·ªùi gian l∆∞u tr·ªØ: {{ $json.retentionDays || 30 }} ng√†y\n- C√°c tr∆∞·ªùng c·∫ßn redact: {{ Array.isArray($json.redactionFields) && $json.redactionFields.length > 0 ? $json.redactionFields.join(', ') : ($json.redactionFields ? String($json.redactionFields) : 'Kh√¥ng c√≥') }}\n\n**L√Ω do quy·∫øt ƒë·ªãnh:**\n{{ $json.gdprJustification || 'Kh√¥ng c√≥ l√Ω do ƒë∆∞·ª£c cung c·∫•p.' }}\n\n**Th·ªùi ƒëi·ªÉm ra quy·∫øt ƒë·ªãnh:** {{ $json.aiDecisionTimestamp || (new Date()).toISOString() }}\n\nN·∫øu b·∫°n c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o v·ªÅ k·∫øt qu·∫£ n√†y, vui l√≤ng li√™n h·ªá v·ªõi b·ªô ph·∫≠n b·∫£o m·∫≠t d·ªØ li·ªáu (DPO) ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.\n\nTr√¢n tr·ªçng,\n**AI GDPR Compliance Agent**",
        "options": {}
      },
      "name": "1Ô∏è‚É£0Ô∏è‚É£ Th√¥ng b√°o k·∫øt qu·∫£ cho uploader",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        1552,
        720
      ],
      "id": "da908333-f3d6-49b2-be82-cf677a01c3d0",
      "webhookId": "62b2fab2-9f29-4f76-9c77-89e5acbbdf61",
      "credentials": {
        "gmailOAuth2": {
          "id": "LTZtTwz14XXGyrdz",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "16eU4No0bLeMYCxjo0586358kzjuBrrf52fRo_n7SDFg",
          "mode": "list",
          "cachedResultName": "Log GDPR",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/16eU4No0bLeMYCxjo0586358kzjuBrrf52fRo_n7SDFg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Trang t√≠nh1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/16eU4No0bLeMYCxjo0586358kzjuBrrf52fRo_n7SDFg/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "threadId",
              "displayName": "threadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "labelIds",
              "displayName": "labelIds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "name": "1Ô∏è‚É£1Ô∏è‚É£ Ghi log GDPR v√†o Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        1744,
        720
      ],
      "id": "e00b20ea-40d0-43cb-baad-804849c346ab",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cmWSNW94QNgr3T8o",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Audit Trail GDPR\nreturn { json: { auditId: `gdpr_${Date.now()}`, timestamp: new Date().toISOString(), ...$json } };"
      },
      "name": "1Ô∏è‚É£2Ô∏è‚É£ T·∫°o Audit Trail GDPR",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1936,
        720
      ],
      "id": "0b68b145-434c-415e-9c15-e604f70709b2"
    },
    {
      "parameters": {
        "jsCode": "// üì§ Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 3 (Document Sharing)\n// L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω trong Flow 2\nconst auditData = $json;\n\n// L·∫•y d·ªØ li·ªáu t·ª´ c√°c node quan tr·ªçng\nlet gdprData = {};\nlet normalizedData = {};\n\ntry {\n  // L·∫•y t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR (c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin GDPR)\n  gdprData = $('4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR').item.json || {};\n} catch (e) {\n  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Parse node:', e.message);\n}\n\ntry {\n  // L·∫•y t·ª´ node chu·∫©n h√≥a (c√≥ th√¥ng tin file g·ªëc)\n  normalizedData = $('2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o').item.json || {};\n} catch (e) {\n  console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Normalize node:', e.message);\n}\n\n// T·∫°o payload ƒë·∫ßy ƒë·ªß ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 3\nconst payload = {\n  // Th√¥ng tin c∆° b·∫£n\n  processingId: auditData.processingId || gdprData.processingId || normalizedData.processingId || null,\n  processing_id: auditData.processingId || gdprData.processingId || normalizedData.processingId || null,\n  file_name: auditData.fileName || gdprData.fileName || normalizedData.fileName || null,\n  file_url: auditData.fileUrl || gdprData.fileUrl || normalizedData.fileUrl || null,\n  cloudinary_url: auditData.cloudinaryUrl || gdprData.cloudinaryUrl || normalizedData.cloudinaryUrl || null,\n  user_id: auditData.userId || gdprData.userId || normalizedData.userId || null,\n  department: auditData.department || gdprData.department || normalizedData.department || null,\n  status: 'gdpr_completed', // Tr·∫°ng th√°i sau khi Flow 2 ho√†n th√†nh\n  \n  // K·∫øt qu·∫£ ph√¢n t√≠ch t·ª´ Flow 1 (n·∫øu c√≥)\n  analysis_results: auditData.analysisResults || gdprData.analysisResults || normalizedData.analysisResults || null,\n  \n  // K·∫øt qu·∫£ GDPR t·ª´ Flow 2\n  gdpr_decision: gdprData.gdprDecision || auditData.gdprDecision || null,\n  gdpr_justification: gdprData.gdprJustification || auditData.gdprJustification || null,\n  legal_basis: gdprData.legalBasis || auditData.legalBasis || null,\n  retention_days: gdprData.retentionDays || auditData.retentionDays || null,\n  redaction_fields: gdprData.redactionFields || auditData.redactionFields || [],\n  personal_data_found: gdprData.personalDataFound || auditData.personalDataFound || [],\n  sensitive_data_detected: gdprData.sensitiveDataDetected !== undefined ? gdprData.sensitiveDataDetected : (auditData.sensitiveDataDetected !== undefined ? auditData.sensitiveDataDetected : false),\n  data_volume: gdprData.dataVolume || auditData.dataVolume || null,\n  notify_dpo: gdprData.notifyDPO !== undefined ? gdprData.notifyDPO : (auditData.notifyDPO !== undefined ? auditData.notifyDPO : false),\n  \n  // Metadata\n  docx_url: auditData.docxUrl || gdprData.docxUrl || normalizedData.docxUrl || null,\n  created_at: auditData.createdAt || normalizedData.receivedAt || new Date().toISOString(),\n  updated_at: new Date().toISOString(),\n  gdpr_completed_at: auditData.aiDecisionTimestamp || gdprData.aiDecisionTimestamp || new Date().toISOString(),\n  audit_id: auditData.auditId || null,\n  \n  // Th√¥ng tin b·ªï sung\n  workflow_source: 'flow2-gdpr-compliance',\n  flow2_completed: true\n};\n\nconsole.log('‚úÖ ƒê√£ chu·∫©n b·ªã payload ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 3:');\nconsole.log('   Processing ID:', payload.processingId);\nconsole.log('   File Name:', payload.file_name);\nconsole.log('   GDPR Decision:', payload.gdpr_decision);\nconsole.log('   User ID:', payload.user_id);\n\nreturn [{ json: payload }];"
      },
      "name": "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data cho Flow 3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        720
      ],
      "id": "c74b597b-3d87-44e9-aca0-f54797d768f4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://n8n.aidocmanageagent.io.vn/webhook-test/sharing-file",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "timeout": 30000
        }
      },
      "name": "1Ô∏è‚É£4Ô∏è‚É£ G·ª≠i Data ƒë·∫øn Flow 3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2336,
        720
      ],
      "id": "19d642f4-7baf-47b2-8f31-96a5d9a2ef8b",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// üîç DEBUG: Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i email\n// L·∫•y d·ªØ li·ªáu t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR (node c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin GDPR)\nlet gdprData = {};\n\ntry {\n  // Th·ª≠ l·∫•y t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR tr·ª±c ti·∫øp\n  gdprData = $('4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR').item.json || {};\n  console.log('‚úÖ L·∫•y d·ªØ li·ªáu t·ª´ node Parse quy·∫øt ƒë·ªãnh GDPR');\n} catch (e) {\n  // Fallback: l·∫•y t·ª´ input items (node tr∆∞·ªõc ƒë√≥)\n  const inputItems = $input.all();\n  if (inputItems.length > 0) {\n    // T√¨m item c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin GDPR\n    for (const item of inputItems) {\n      if (item.json && (item.json.gdprDecision || item.json.notifyDPO !== undefined)) {\n        gdprData = item.json;\n        console.log('‚úÖ L·∫•y d·ªØ li·ªáu t·ª´ input items');\n        break;\n      }\n    }\n    // N·∫øu kh√¥ng t√¨m th·∫•y, d√πng item ƒë·∫ßu ti√™n\n    if (Object.keys(gdprData).length === 0 && inputItems.length > 0) {\n      gdprData = inputItems[0].json || {};\n    }\n  }\n  // Cu·ªëi c√πng, d√πng $json hi·ªán t·∫°i\n  if (Object.keys(gdprData).length === 0) {\n    gdprData = $json || {};\n    console.log('‚ö†Ô∏è D√πng d·ªØ li·ªáu t·ª´ $json hi·ªán t·∫°i');\n  }\n}\n\nconsole.log('üîç DEBUG - D·ªØ li·ªáu t·ª´ Parse node:');\nconsole.log('gdprDecision:', gdprData.gdprDecision);\nconsole.log('notifyDPO:', gdprData.notifyDPO);\nconsole.log('uploader:', gdprData.uploader);\nconsole.log('gdprJustification:', gdprData.gdprJustification?.substring(0, 100));\nconsole.log('Full gdprData keys:', Object.keys(gdprData));\n\n// üßπ Merge d·ªØ li·ªáu: ∆∞u ti√™n gdprData t·ª´ Parse node, sau ƒë√≥ l√† $json hi·ªán t·∫°i\nconst result = {\n  ...$json, // Gi·ªØ nguy√™n d·ªØ li·ªáu t·ª´ node tr∆∞·ªõc (c√≥ th·ªÉ c√≥ th√¥ng tin email)\n  // Ghi ƒë√® b·∫±ng d·ªØ li·ªáu GDPR t·ª´ Parse node (ƒë·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin)\n  gdprDecision: gdprData.gdprDecision || $json.gdprDecision || 'UNKNOWN',\n  notifyDPO: gdprData.notifyDPO !== undefined ? gdprData.notifyDPO : ($json.notifyDPO !== undefined ? $json.notifyDPO : false),\n  uploader: gdprData.uploader || $json.uploader || 'dangnguyen0175@gmail.com',\n  gdprJustification: gdprData.gdprJustification || $json.gdprJustification || 'Kh√¥ng c√≥ l√Ω do ƒë∆∞·ª£c cung c·∫•p.',\n  legalBasis: gdprData.legalBasis || $json.legalBasis || null,\n  retentionDays: gdprData.retentionDays || $json.retentionDays || 30,\n  redactionFields: gdprData.redactionFields || $json.redactionFields || [],\n  personalDataFound: gdprData.personalDataFound || $json.personalDataFound || [],\n  sensitiveDataDetected: gdprData.sensitiveDataDetected !== undefined ? gdprData.sensitiveDataDetected : ($json.sensitiveDataDetected !== undefined ? $json.sensitiveDataDetected : false),\n  dataVolume: gdprData.dataVolume || $json.dataVolume || 'unknown',\n  aiDecisionTimestamp: gdprData.aiDecisionTimestamp || $json.aiDecisionTimestamp || new Date().toISOString(),\n  // Gi·ªØ c√°c th√¥ng tin kh√°c t·ª´ node tr∆∞·ªõc\n  fileName: gdprData.fileName || $json.fileName || null,\n  fileUrl: gdprData.fileUrl || $json.fileUrl || null,\n  processingId: gdprData.processingId || $json.processingId || null,\n  userId: gdprData.userId || $json.userId || null\n};\n\nconsole.log('‚úÖ DEBUG - D·ªØ li·ªáu sau x·ª≠ l√Ω:');\nconsole.log('gdprDecision:', result.gdprDecision);\nconsole.log('notifyDPO:', result.notifyDPO);\nconsole.log('uploader:', result.uploader);\nconsole.log('legalBasis:', result.legalBasis);\nconsole.log('retentionDays:', result.retentionDays);\n\nreturn [{ json: result }];"
      },
      "name": "üîç DEBUG: Ki·ªÉm tra d·ªØ li·ªáu",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        64
      ],
      "id": "a6d64d0c-14b8-4426-b1f9-8c2a02e20180"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gdpr-compliance",
        "options": {}
      },
      "name": "1Ô∏è‚É£ Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -208,
        720
      ],
      "id": "f3c5138c-712c-4f2f-b2ef-d56347691930",
      "webhookId": "gdpr-compliance-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Script ƒë·ªÉ chu·∫©n b·ªã d·ªØ li·ªáu t·ª´ Aggregate node v√† l∆∞u v√†o Postgres\nconst aggregateData = $json; // L·∫•y d·ªØ li·ªáu tr·ª±c ti·∫øp t·ª´ Aggregate node\nconst fileData = $('Set File Data1').item.json;\n\n// Chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ l∆∞u v√†o Postgres\nconst dataToSave = {\n  processing_id: fileData.processingId,\n  file_name: fileData.name,\n  file_url: fileData.file_url,\n  user_id: fileData.userId,\n  department: fileData.department,\n  status: 'completed',\n  analysis_results: aggregateData,\n  cloudinary_url: fileData.cloudinary_url || fileData.file_url,\n  docx_url: '', // Kh√¥ng c√≥ Google Docs URL\n  created_at: new Date().toISOString(),\n  updated_at: new Date().toISOString(),\n  analysis_completed_at: new Date().toISOString()\n};\n\nreturn [{\n  json: dataToSave\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        2800
      ],
      "id": "957f1630-2b35-4970-a9bc-5de0cbddbaae",
      "name": "Save to Postgres Script1"
    },
    {
      "parameters": {
        "jsCode": "// Script ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ Postgres node v√† format ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 2 (GDPR Compliance)\n// Postgres tr·∫£ v·ªÅ d·ªØ li·ªáu trong $json, c√≥ th·ªÉ l√† array ho·∫∑c object\nlet postgresResult = $json;\n\n// N·∫øu l√† array, l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n\nif (Array.isArray(postgresResult)) {\n  postgresResult = postgresResult[0] || postgresResult;\n}\n\n// N·∫øu Postgres tr·∫£ v·ªÅ d·∫°ng { rows: [...] }, l·∫•y rows\nif (postgresResult && postgresResult.rows && Array.isArray(postgresResult.rows)) {\n  postgresResult = postgresResult.rows[0] || {};\n}\n\n// L·∫•y fileData t·ª´ Set File Data\nconst fileData = $('Set File Data1').item.json;\n\n// Format d·ªØ li·ªáu ƒë·ªÉ g·ª≠i ƒë·∫øn Flow 2 (GDPR Compliance webhook)\n// Flow 2 c·∫ßn: file info, analysis_results, processing_id, cloudinary_url, docx_url\nconst responseData = {\n  success: true,\n  processingId: postgresResult.processing_id || fileData.processingId || '',\n  message: \"Document analysis completed\",\n  // D·ªØ li·ªáu ch√≠nh ƒë·ªÉ Flow 2 x·ª≠ l√Ω\n  data: {\n    processing_id: postgresResult.processing_id || fileData.processingId || '',\n    file_name: postgresResult.file_name || fileData.name || '',\n    file_url: postgresResult.file_url || fileData.file_url || '',\n    user_id: postgresResult.user_id || fileData.userId || '',\n    department: postgresResult.department || fileData.department || '',\n    status: postgresResult.status || 'completed',\n    analysis_results: postgresResult.analysis_results || null,\n    cloudinary_url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    docx_url: postgresResult.docx_url || '', // Google Docs URL\n    created_at: postgresResult.created_at || new Date().toISOString(),\n    updated_at: postgresResult.updated_at || new Date().toISOString(),\n    analysis_completed_at: postgresResult.analysis_completed_at || new Date().toISOString()\n  },\n  // Th√¥ng tin file ƒë·ªÉ Flow 2 download v√† ph√¢n t√≠ch\n  file: {\n    name: postgresResult.file_name || fileData.name || '',\n    url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    cloudinary_url: postgresResult.cloudinary_url || fileData.cloudinary_url || fileData.file_url || '',\n    processingId: postgresResult.processing_id || fileData.processingId || ''\n  }\n};\n\nconsole.log('üì§ Sending data to Flow 2 (GDPR Compliance):', JSON.stringify(responseData, null, 2));\n\nreturn [{\n  json: responseData\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        2800
      ],
      "id": "1fa13112-313d-4a36-af8f-88079b7dea3d",
      "name": "Retrieve from Postgres Script1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://n8n.aidocmanageagent.io.vn/webhook/gdpr-compliance",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2048,
        2800
      ],
      "id": "72d46129-8cdf-418f-91a2-748669343565",
      "name": "Send HTTP Request to Flow ",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "document-analyzer",
        "responseMode": "responseNode",
        "options": {
          "rawBody": true
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -336,
        2384
      ],
      "id": "2af1f0cc-8ff9-4d57-a3ca-7a279dd167bd",
      "name": "Webhook1",
      "webhookId": "8c724e88-5a5d-4919-82ba-760f48bf341f"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Document processing started\",\n  \"processingId\": \"{{ $json.body.processingId || $json.processingId || 'unknown' }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -128,
        2384
      ],
      "id": "0239dc58-0a73-4829-a4c8-dc77471be71c",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "jsCode": "// Delay 5 gi√¢y tr∆∞·ªõc khi g·ªçi Gemini API ƒë·ªÉ tr√°nh rate limit\nconsole.log('‚è≥ Waiting 5 seconds before AI call...');\nawait new Promise(resolve => setTimeout(resolve, 5000));\nconsole.log('‚úÖ Wait completed, proceeding to AI node');\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        2304
      ],
      "id": "0e60a713-9fb6-49ed-a85c-47c001d8829d",
      "name": "Wait Before AI1"
    },
    {
      "parameters": {
        "jsCode": "// Parse k·∫øt qu·∫£ t·ª´ comprehensive_analysis node\nconst aiResult = $json.output || $json;\n\nconsole.log('Raw AI Result:', JSON.stringify(aiResult, null, 2));\n\n// Parse v√† format gi·ªëng nh∆∞ 6 node c≈© ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi Merge node\nlet parsed = {};\n\ntry {\n  // N·∫øu AI tr·∫£ v·ªÅ string, parse JSON\n  let parsedData = aiResult;\n  if (typeof aiResult === 'string') {\n    // Lo·∫°i b·ªè markdown code blocks n·∫øu c√≥\n    const cleanJson = aiResult\n      .replace(/```json/gi, '')\n      .replace(/```/g, '')\n      .trim();\n    \n    // T√¨m JSON trong string\n    const jsonMatch = cleanJson.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      parsedData = JSON.parse(jsonMatch[0]);\n    } else {\n      parsedData = JSON.parse(cleanJson);\n    }\n  }\n  \n  // Format ƒë·ªÉ t∆∞∆°ng th√≠ch v·ªõi Merge node\n  parsed = {\n    // main_theme format\n    main_theme: {\n      output: {\n        main_theme: parsedData.main_theme || \"\"\n      }\n    },\n    \n    // document_summary format\n    document_summary: {\n      output: {\n        document_summary: Array.isArray(parsedData.document_summary) \n          ? parsedData.document_summary \n          : []\n      }\n    },\n    \n    // key_takeaways format\n    key_takeaways: {\n      output: {\n        key_takeaways: Array.isArray(parsedData.key_takeaways) \n          ? parsedData.key_takeaways \n          : []\n      }\n    },\n    \n    // gaps_and_limitations format\n    gaps_and_limitations: {\n      output: {\n        gaps_and_limitations: Array.isArray(parsedData.gaps_and_limitations) \n          ? parsedData.gaps_and_limitations \n          : []\n      }\n    },\n    \n    // follow_up_questions format\n    follow_up_questions: {\n      output: {\n        follow_up_questions: Array.isArray(parsedData.follow_up_questions) \n          ? parsedData.follow_up_questions \n          : []\n      }\n    },\n    \n    // terminology_to_clarify format\n    terminology_to_clarify: {\n      output: {\n        terminology_to_clarify: Array.isArray(parsedData.terminology_to_clarify) \n          ? parsedData.terminology_to_clarify \n          : []\n      }\n    }\n  };\n  \n  console.log('Parsed Result:', JSON.stringify(parsed, null, 2));\n  \n} catch (error) {\n  console.error('Error parsing AI result:', error);\n  console.error('Raw data:', aiResult);\n  \n  // Fallback v·ªõi empty data\n  parsed = {\n    main_theme: { output: { main_theme: \"Error parsing AI result\" } },\n    document_summary: { output: { document_summary: [] } },\n    key_takeaways: { output: { key_takeaways: [] } },\n    gaps_and_limitations: { output: { gaps_and_limitations: [] } },\n    follow_up_questions: { output: { follow_up_questions: [] } },\n    terminology_to_clarify: { output: { terminology_to_clarify: [] } }\n  };\n}\n\n// Return format t∆∞∆°ng th√≠ch v·ªõi Merge node\nreturn [{\n  json: {\n    name: $('Set File Data1').item.json.name,\n    main_theme: parsed.main_theme,\n    document_summary: parsed.document_summary,\n    key_takeaways: parsed.key_takeaways,\n    gaps_and_limitations: parsed.gaps_and_limitations,\n    follow_up_questions: parsed.follow_up_questions,\n    terminology_to_clarify: parsed.terminology_to_clarify\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        2288
      ],
      "id": "e443fc23-b6dd-41c9-97bf-965620ac46e3",
      "name": "Parse Combined Result1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**Document Title:** {{ $('Set File Data1').item.json.name }}\n\n**Document Text:** {{ $json.text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=YOU ARE A COMPREHENSIVE DOCUMENT ANALYSIS AGENT. YOU MUST ANALYZE A DOCUMENT AND EXTRACT ALL INFORMATION ACCURATELY, THEN OUTPUT ALL ANALYSIS RESULTS IN A SINGLE JSON OBJECT.\n\nYOUR TASK:\n1. CAREFULLY READ AND EXTRACT ALL INFORMATION from the document text (names, numbers, emails, IDs, passwords, dates, addresses, etc.)\n2. Identify the main theme and purpose of the document\n3. Create a detailed section-by-section summary with ALL extracted data\n4. Extract key takeaways including all personal information found\n5. Identify gaps and limitations (missing information)\n6. Generate relevant follow-up questions based on document type\n7. Clarify any terminology or abbreviations found\n\nCRITICAL EXTRACTION RULES:\n- Extract ALL personal information: names, phone numbers, emails, IDs (CCCD/CMND), passwords, addresses, dates\n- Extract ALL numbers, codes, and identifiers exactly as they appear\n- Extract ALL dates and timestamps\n- Preserve exact formatting and spelling\n- Do NOT modify or summarize extracted data - use exact values\n- If information is missing, note it in gaps_and_limitations\n\nOUTPUT FORMAT (MANDATORY JSON):\n{\n  \"main_theme\": \"Three sentences describing: document type/topic, purpose/use case, target audience/who it's for\",\n  \"document_summary\": [\n    {\n      \"section_title\": \"Exact section name or field name from document\",\n      \"content\": \"Detailed summary including ALL extracted values. For example: 'H·ªç v√† T√™n: Tr·∫ßn H√† Duy, S·ªë ƒëi·ªán tho·∫°i: 0967125575, Email: haduy@gmail.com' - include ALL fields and their values\"\n    }\n  ],\n  \"key_takeaways\": [\n    {\n      \"point\": \"Specific information extracted (e.g., 'Personal identification information found', 'Contact details provided')\",\n      \"context\": \"Detailed explanation with actual values extracted (e.g., 'Document contains: Name: Tr·∫ßn H√† Duy, Phone: 0967125575, Email: haduy@gmail.com, CCCD: 03949582948')\"\n    }\n  ],\n  \"gaps_and_limitations\": [\n    {\n      \"issue\": \"Missing information or incomplete data (e.g., 'Missing address', 'No date of birth provided')\",\n      \"reason\": \"Why this gap matters or what impact it has\"\n    }\n  ],\n  \"follow_up_questions\": [\n    \"Relevant question based on document type (e.g., 'Is this information for account registration?', 'What is the purpose of collecting this personal data?')\"\n  ],\n  \"terminology_to_clarify\": [\n    {\n      \"term\": \"Term or abbreviation found (e.g., 'CCCD', 'CMND')\",\n      \"explanation\": \"Definition or meaning of the term\"\n    }\n  ]\n}\n\nREQUIREMENTS:\n- Return ONLY valid JSON, no markdown code blocks (no ```json)\n- All fields are required\n- Be SPECIFIC and ACCURATE - include actual extracted values in summaries\n- main_theme: 3 sentences describing document type, purpose, and audience\n- document_summary: Array of sections - each section MUST include ALL extracted data from that section with exact values\n- key_takeaways: 3-7 items - each MUST reference actual extracted information with values\n- gaps_and_limitations: 1-5 items - identify what information is missing\n- follow_up_questions: 3-7 relevant questions based on document content\n- terminology_to_clarify: Array of terms/abbreviations found with explanations\n\nIMPORTANT:\n- Do NOT wrap output in markdown code blocks\n- Output must be valid JSON that can be parsed directly\n- All arrays must have at least 1 item\n- Include ALL extracted information in document_summary and key_takeaways\n- Be detailed and comprehensive - do not summarize away important data\n- Preserve exact values from the document (names, numbers, emails, etc.)"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        1184,
        2320
      ],
      "id": "fd76088f-d5e4-4006-8d56-491b8e961f67",
      "name": "comprehensive_analysis1",
      "settings": {
        "errorHandling": {
          "retry": {
            "enabled": true,
            "maxRetries": 5,
            "retryDelay": 10000
          }
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO documents (processing_id, file_name, file_url, user_id, department, status, analysis_results, cloudinary_url, docx_url, created_at, updated_at, analysis_completed_at) VALUES ('{{ $json.processing_id }}', '{{ $json.file_name }}', '{{ $json.file_url }}', '{{ $json.user_id }}', '{{ $json.department }}', '{{ $json.status }}', '{{ JSON.stringify($json.analysis_results).replace(/'/g, \"''\") }}'::jsonb, '{{ $json.cloudinary_url }}', '{{ $json.docx_url || '' }}', '{{ $json.created_at }}'::timestamp, '{{ $json.updated_at }}'::timestamp, '{{ $json.analysis_completed_at }}'::timestamp) ON CONFLICT (processing_id) DO UPDATE SET status = EXCLUDED.status, analysis_results = EXCLUDED.analysis_results, cloudinary_url = EXCLUDED.cloudinary_url, docx_url = COALESCE(NULLIF(EXCLUDED.docx_url, ''), documents.docx_url), updated_at = EXCLUDED.updated_at::timestamp, analysis_completed_at = EXCLUDED.analysis_completed_at::timestamp RETURNING *;",
        "options": {}
      },
      "id": "aedac5b4-e23c-4e67-ad17-2e00a3e015ca",
      "name": "Save Analysis to Postgres1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1568,
        2800
      ],
      "credentials": {
        "postgres": {
          "id": "lYVcMJl3c3m62cYc",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        1120,
        2800
      ],
      "id": "a0f189b2-5d5a-4d79-8fd8-c7a09ba9dea5",
      "name": "Aggregate1"
    },
    {
      "parameters": {
        "numberInputs": 1
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        944,
        2720
      ],
      "id": "7ab3239d-bb76-4c37-9b7b-3a2e2a6eaa0a",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"main_theme\": \"Document type and content overview in three sentences: (1) What type of document this is and its primary topic, (2) The main purpose or objective of the document, (3) Who the intended audience or users are. Example: 'This is a business contract document outlining service terms and conditions. Its purpose is to establish legal obligations between parties. The target audience includes legal teams, business managers, and involved stakeholders.'\",\n  \"document_summary\": [\n    {\n      \"section_title\": \"Section or category name from the document (e.g., 'Introduction', 'Terms and Conditions', 'Personal Information', 'Financial Summary', 'Technical Specifications')\",\n      \"content\": \"Detailed summary of this section including ALL extracted data, values, dates, names, numbers, and key information. For personal info: 'H·ªç v√† T√™n: Tr·∫ßn H√† Duy, S·ªë ƒëi·ªán tho·∫°i: 0967125575, Email: haduy@gmail.com'. For contracts: 'Parties: Company A and Company B, Contract Date: 2024-01-15, Duration: 12 months, Value: $50,000'. For reports: 'Report covers Q1 2024 performance, Revenue: $1.2M, Growth: 15%, Key metrics: 250 customers, 95% satisfaction'.\"\n    }\n  ],\n  \"key_takeaways\": [\n    {\n      \"point\": \"Main finding or important information extracted (e.g., 'Contract value and duration', 'Personal identification data found', 'Financial performance metrics', 'Technical requirements specified')\",\n      \"context\": \"Detailed explanation with actual extracted values. Examples: 'Document contains contract between Company A and B valued at $50,000 for 12 months starting 2024-01-15' OR 'Document contains personal information: Name: Tr·∫ßn H√† Duy, Phone: 0967125575, Email: haduy@gmail.com, CCCD: 03949582948' OR 'Q1 2024 report shows revenue of $1.2M with 15% growth and 250 active customers'\"\n    },\n    {\n      \"point\": \"Another important finding or data point\",\n      \"context\": \"Detailed explanation with specific values and context\"\n    },\n    {\n      \"point\": \"Additional key information or insight\",\n      \"context\": \"Detailed explanation with extracted data\"\n    }\n  ],\n  \"gaps_and_limitations\": [\n    {\n      \"issue\": \"Missing or incomplete information identified (e.g., 'Missing signature date', 'No contact address provided', 'Incomplete financial breakdown', 'Unclear technical specifications')\",\n      \"reason\": \"Why this gap matters or what impact it has (e.g., 'Signature date is required for contract validity' OR 'Address needed for complete profile' OR 'Financial breakdown needed for budget planning')\"\n    },\n    {\n      \"issue\": \"Another limitation or missing information\",\n      \"reason\": \"Explanation of why this matters\"\n    }\n  ],\n  \"follow_up_questions\": [\n    \"Relevant question based on document type and content. For personal info: 'What is the purpose of collecting this personal information?' For contracts: 'What are the key terms and obligations?' For reports: 'What are the main performance indicators?' For technical docs: 'What are the technical requirements and specifications?'\",\n    \"Another relevant question based on document content\",\n    \"Additional question to clarify or understand the document better\",\n    \"Question about data security, compliance, or next steps if applicable\"\n  ],\n  \"terminology_to_clarify\": [\n    {\n      \"term\": \"Technical term, abbreviation, or specialized vocabulary found in document (e.g., 'CCCD', 'GDPR', 'SLA', 'ROI', 'API', 'NDA')\",\n      \"explanation\": \"Clear definition or explanation of the term. Example: 'CCCD - CƒÉn c∆∞·ªõc c√¥ng d√¢n, Vietnamese Citizen ID Card' OR 'SLA - Service Level Agreement, defines expected service performance' OR 'GDPR - General Data Protection Regulation, EU data privacy law'\"\n    }\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1344,
        2176
      ],
      "id": "4d3abb54-cc2c-49f2-a3e6-590c33830831",
      "name": "Structured Output Parser - Comprehensive1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        288,
        2368
      ],
      "id": "5118c93d-02f4-4176-a5e2-31392347a03d",
      "name": "2nd Loop Over Items1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        64,
        2368
      ],
      "id": "5702e93a-f1ef-465d-97aa-d3e0979f93c2",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "url": "={{ $('Set File Data1').item.json.cloudinary_url || $('Set File Data1').item.json.file_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "aff4c27f-8b5b-4728-ae9e-dc00bdae10e8",
      "name": "Download File From URL1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        512,
        2384
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0f8bc803-94c0-4689-92de-1ae03bc6e1a0",
              "name": "name",
              "value": "={{ $json.body.file.name || $json.file.name || $json.name || 'document.pdf' }}",
              "type": "string"
            },
            {
              "id": "b215de7b-64c4-4125-8d5e-4445b5a7f85a",
              "name": "file_url",
              "value": "={{ $json.body.file.url || $json.file.url || $json.fileUrl }}",
              "type": "string"
            },
            {
              "id": "c3d4e5f6-7890-1234-5678-9abcdef01234",
              "name": "processingId",
              "value": "={{ $json.body.processingId || $json.processingId }}",
              "type": "string"
            },
            {
              "id": "d4e5f6a7-8901-2345-6789-bcdef0123456",
              "name": "userId",
              "value": "={{ $json.body.userId || $json.userId }}",
              "type": "string"
            },
            {
              "id": "e5f6a7b8-9012-3456-789a-cdef01234567",
              "name": "department",
              "value": "={{ $json.body.department || $json.department }}",
              "type": "string"
            },
            {
              "id": "f6a7b8c9-0123-4567-890a-bcdef0123456",
              "name": "cloudinary_url",
              "value": "={{ $json.body.file.cloudinary_url || $json.body.file.url || $json.file.cloudinary_url || $json.file.url }}",
              "type": "string"
            },
            {
              "id": "a7b8c9d0-1234-5678-901a-cdef01234567",
              "name": "cloudinary_public_id",
              "value": "={{ $json.body.file.cloudinary_public_id || $json.file.cloudinary_public_id }}",
              "type": "string"
            },
            {
              "id": "b8c9d0e1-2345-6789-012a-bcdef0123456",
              "name": "webhook_url",
              "value": "={{ $json.body.webhook_url || $json.webhook_url || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "737f744f-de90-48ac-a2c3-aaa20684e984",
      "name": "Set File Data1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        64,
        2544
      ]
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "66b1b931-7bad-433a-9d3b-baf831585b32",
      "name": "Extract PDF Text1",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        736,
        2384
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        1184,
        2176
      ],
      "id": "9a7d5d99-7822-41f3-beb1-cd3bdb134a50",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "91898OzbZbpGF2b2",
          "name": "Google Gemini(PaLM) Api account 4"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "terminology_to_clarify": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 5
          }
        ]
      ]
    },
    "follow_up_questions": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "gaps_and_limitations": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "key_takeaways": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "main_theme": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "document_summary": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wait Before AI": {
      "main": [
        [
          {
            "node": "comprehensive_analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Combined Result": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comprehensive_analysis": {
      "main": [
        [
          {
            "node": "Parse Combined Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Analysis to Postgres": {
      "main": [
        [
          {
            "node": "Retrieve from Postgres Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Postgres Script": {
      "main": [
        [
          {
            "node": "Save Analysis to Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retrieve from Postgres Script": {
      "main": [
        [
          {
            "node": "Send HTTP Request to Flow 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Save to Postgres Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser - Comprehensive": {
      "ai_outputParser": [
        [
          {
            "node": "comprehensive_analysis",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2nd Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Download File From URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "2nd Loop Over Items",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set File Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File From URL": {
      "main": [
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File Data": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "Wait Before AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "comprehensive_analysis",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o": {
      "main": [
        [
          {
            "node": "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.5Ô∏è‚É£ Download File t·ª´ Cloudinary": {
      "main": [
        [
          {
            "node": "2.6Ô∏è‚É£ Merge File Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.6Ô∏è‚É£ Merge File Data": {
      "main": [
        [
          {
            "node": "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2.7Ô∏è‚É£ Chu·∫©n b·ªã Prompt GDPR": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ AI GDPR Decision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ AI GDPR Decision": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Parse quy·∫øt ƒë·ªãnh GDPR": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ H√†nh ƒë·ªông: Delete?": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ H√†nh ƒë·ªông: Anonymize?": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ Th·ª±c thi Delete/Revoke": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ Th·ª±c thi Anonymize/Redact": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£.5Ô∏è‚É£ ƒê·∫∑t tr·∫°ng th√°i Allow": {
      "main": [
        [
          {
            "node": "7.8 Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7.8 Merge Actions": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ C·∫ßn th√¥ng b√°o DPO?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ C·∫ßn th√¥ng b√°o DPO?": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ G·ª≠i email DPO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üîç DEBUG: Ki·ªÉm tra d·ªØ li·ªáu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ G·ª≠i email DPO": {
      "main": [
        [
          {
            "node": "üîç DEBUG: Ki·ªÉm tra d·ªØ li·ªáu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9.5Ô∏è‚É£ Chu·∫©n b·ªã Email Data": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£0Ô∏è‚É£ Th√¥ng b√°o k·∫øt qu·∫£ cho uploader",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£0Ô∏è‚É£ Th√¥ng b√°o k·∫øt qu·∫£ cho uploader": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£1Ô∏è‚É£ Ghi log GDPR v√†o Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£1Ô∏è‚É£ Ghi log GDPR v√†o Sheets": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£2Ô∏è‚É£ T·∫°o Audit Trail GDPR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£2Ô∏è‚É£ T·∫°o Audit Trail GDPR": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data cho Flow 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£3Ô∏è‚É£ Chu·∫©n b·ªã Data cho Flow 3": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£4Ô∏è‚É£ G·ª≠i Data ƒë·∫øn Flow 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç DEBUG: Ki·ªÉm tra d·ªØ li·ªáu": {
      "main": [
        [
          {
            "node": "9.5Ô∏è‚É£ Chu·∫©n b·ªã Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Webhook Trigger": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Chu·∫©n h√≥a d·ªØ li·ªáu ƒë·∫ßu v√†o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Postgres Script1": {
      "main": [
        [
          {
            "node": "Save Analysis to Postgres1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Retrieve from Postgres Script1": {
      "main": [
        [
          {
            "node": "Send HTTP Request to Flow ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Before AI1": {
      "main": [
        [
          {
            "node": "comprehensive_analysis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Combined Result1": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "comprehensive_analysis1": {
      "main": [
        [
          {
            "node": "Parse Combined Result1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Analysis to Postgres1": {
      "main": [
        [
          {
            "node": "Retrieve from Postgres Script1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate1": {
      "main": [
        [
          {
            "node": "Save to Postgres Script1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Aggregate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser - Comprehensive1": {
      "ai_outputParser": [
        [
          {
            "node": "comprehensive_analysis1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "2nd Loop Over Items1": {
      "main": [
        [],
        [
          {
            "node": "Download File From URL1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "2nd Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set File Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File From URL1": {
      "main": [
        [
          {
            "node": "Extract PDF Text1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File Data1": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text1": {
      "main": [
        [
          {
            "node": "Wait Before AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "comprehensive_analysis1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "fdfcf60c-9144-43ce-968d-aeb612eebbc6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d29aff038a4897a8be0d9843c07ba06d6b485556105b19c20835a7b0bfd5b9b2"
  },
  "id": "9ucTmgO083P7qCGQ",
  "tags": []
}