{
  "name": "Flow 2",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// X·ª¨ L√ù D·ªÆ LI·ªÜU TH·ª∞C T·∫æ T·ª™ GOOGLE DRIVE TRIGGER\nconsole.log('=== LU·ªíNG 2 - X·ª¨ L√ù D·ªÆ LI·ªÜU ƒê·∫¶U V√ÄO ===');\nconsole.log('Raw input data:', JSON.stringify($json, null, 2));\n\nconst inputData = $json || {};\n\n// S·ª¨ D·ª§NG D·ªÆ LI·ªÜU TH·ª∞C T·∫æ T·ª™ GOOGLE DRIVE TRIGGER\nconst documentTitle = inputData.name || inputData.originalFilename || 'T√†i li·ªáu m·ªõi t·ª´ Google Drive';\nconst originalFileId = inputData.id || inputData.fileId || 'unknown_file_id';\n\n// Validate file ID early\nif (!originalFileId || originalFileId === 'unknown_file_id') {\n  console.error('‚ùå CRITICAL: No valid file ID found in Google Drive trigger data');\n  console.error('Available keys:', Object.keys(inputData));\n  console.error('Full input data:', JSON.stringify(inputData, null, 2));\n  \n  // Return error data instead of continuing\n  return [{ json: { error: true, message: 'Invalid file ID', inputData } }];\n}\n\nconst fileSize = inputData.size ? `${(parseInt(inputData.size) / 1024).toFixed(1)}KB` : 'Unknown';\nconst uploadDate = inputData.createdTime || new Date().toISOString();\nconst uploader = inputData.owners?.[0]?.emailAddress || inputData.lastModifyingUser?.emailAddress || 'unknown@example.com';\nconst mimeType = inputData.mimeType || 'unknown';\nconst webViewLink = inputData.webViewLink || `https://drive.google.com/file/d/${originalFileId}/view?usp=sharing`;\nconst webContentLink = inputData.webContentLink || `https://drive.google.com/uc?id=${originalFileId}&export=download`;\n\n// Logic x√°c ƒë·ªãnh ph√≤ng ban d·ª±a tr√™n t√™n file\nlet documentCategory = 'Chung';\nif (documentTitle.toLowerCase().includes('nh√¢n s·ª±') || documentTitle.toLowerCase().includes('hr')) {\n  documentCategory = 'Nh√¢n s·ª±';\n} else if (documentTitle.toLowerCase().includes('t√†i ch√≠nh') || documentTitle.toLowerCase().includes('finance')) {\n  documentCategory = 'T√†i ch√≠nh';\n} else if (documentTitle.toLowerCase().includes('it') || documentTitle.toLowerCase().includes('c√¥ng ngh·ªá') || documentTitle.toLowerCase().includes('htt')) {\n  documentCategory = 'IT';\n}\n\nconsole.log('üîç TH√îNG TIN FILE TH·ª∞C T·∫æ:');\nconsole.log('- T√™n file:', documentTitle);\nconsole.log('- File ID:', originalFileId);\nconsole.log('- Ph√≤ng ban:', documentCategory);\nconsole.log('- WebView Link:', webViewLink);\n\n// T·∫†O D·ªÆ LI·ªÜU HO√ÄN CH·ªàNH\nconst processedData = {\n  receivedAt: new Date().toISOString(),\n  clientIp: 'Google-Drive-Trigger',\n  country: 'VN',\n  userAgent: 'Google-Drive-API',\n  originalData: inputData,\n  validationPassed: true,\n  warnings: [],\n  \n  // Th√¥ng tin file TH·ª∞C T·∫æ\n  documentTitle: documentTitle,\n  documentCategory: documentCategory,\n  hasPersonalInfo: false,\n  documentSummary: `T√†i li·ªáu ${documentTitle} ƒë∆∞·ª£c t·∫°o m·ªõi t·ª´ Google Drive`,\n  originalFileId: originalFileId,\n  fileSize: fileSize,\n  uploadDate: uploadDate,\n  uploader: uploader,\n  mimeType: mimeType,\n  webViewLink: webViewLink,\n  webContentLink: webContentLink,\n  \n  // C√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho workflow\n  accessLevel: 'reader',\n  expirationDays: 30,\n  sharingReason: `Chia s·∫ª t√†i li·ªáu ${documentTitle} t·ª´ Google Drive`,\n  securityLevel: 'medium',\n  needApproval: false,\n  workflowSource: 'google-drive-trigger',\n  \n  // Unique key\n  uniqueKey: `${originalFileId}_${Date.now()}`,\n  fileId: originalFileId,\n  fileName: documentTitle,\n  createdTime: uploadDate,\n  modifiedTime: inputData.modifiedTime || uploadDate\n};\n\nconsole.log('Processed data:', JSON.stringify(processedData, null, 2));\nconsole.log('=== END LU·ªíNG 2 - X·ª¨ L√ù D·ªÆ LI·ªÜU ƒê·∫¶U V√ÄO ===');\n\nreturn [{ json: processedData }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        208
      ],
      "id": "a83c4c79-e81f-4f68-9e10-a1c1b74c8074",
      "name": "2Ô∏è‚É£ X·ª≠ l√Ω d·ªØ li·ªáu ƒë·∫ßu v√†o"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "approval-condition",
              "leftValue": "={{ $json.needApproval }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c2513c1f-46b7-4f8a-83ef-54b5db508406",
      "name": "5Ô∏è‚É£ C·∫ßn ph√™ duy·ªát?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1840,
        -80
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ ($json.shareWithEmails && $json.shareWithEmails.length > 0) ? $json.shareWithEmails.join(',') : 'manager@company.com,admin@company.com' }}",
        "subject": "üîê Y√™u c·∫ßu ph√™ duy·ªát chia s·∫ª t√†i li·ªáu: {{ $json.documentTitle }}",
        "emailType": "text",
        "message": "**T√ÄI LI·ªÜU C·∫¶N PH√ä DUY·ªÜT CHIA S·∫∫**\n\nüìÑ **Ti√™u ƒë·ªÅ:** {{ $json.documentTitle }}\nüìÇ **Lo·∫°i:** {{ $json.documentCategory }}\nüîí **M·ª©c b·∫£o m·∫≠t:** {{ $json.securityLevel }}\nüë§ **C√≥ th√¥ng tin c√° nh√¢n:** {{ $json.hasPersonalInfo ? 'C√≥' : 'Kh√¥ng' }}\n\n**ƒê·ªÅ xu·∫•t chia s·∫ª v·ªõi (theo B·∫£ng Nh√¢n s·ª±):**\n{{ $json.shareWithEmails.join('\\n') }}\n\n**L√Ω do:** {{ $json.sharingReason }}\n\nVui l√≤ng xem x√©t v√† ph√™ duy·ªát.\n\n---\n*T·ª± ƒë·ªông b·ªüi Document Management Agent*",
        "options": {}
      },
      "id": "81a74822-669f-427d-b248-738535377fc9",
      "name": "6Ô∏è‚É£ G·ª≠i y√™u c·∫ßu ph√™ duy·ªát",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        2112,
        -96
      ],
      "webhookId": "46a7ba35-2d6d-40ec-afaa-f753a9b4a13e",
      "credentials": {
        "gmailOAuth2": {
          "id": "LTZtTwz14XXGyrdz",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ ($json.shareWithEmails && $json.shareWithEmails.length > 0) ? $json.shareWithEmails.join(',') : 'test@example.com' }}",
        "subject": "={{ `üìÑ T√†i li·ªáu ƒë∆∞·ª£c chia s·∫ª: ${$json.documentTitle || 'T√†i li·ªáu'}` }}",
        "emailType": "text",
        "message": "={{ `**T√ÄI LI·ªÜU ƒê√É ƒê∆Ø·ª¢C CHIA S·∫∫ V·ªöI B·∫†N**\n\nüìÑ **Ti√™u ƒë·ªÅ:** ${$json.documentTitle || 'T√†i li·ªáu'}\nüìÇ **Lo·∫°i:** ${$json.documentCategory || 'Chung'}\nüë• **Chia s·∫ª b·ªüi:** Document Management Agent\nüîê **Quy·ªÅn truy c·∫≠p:** ${$json.accessLevel || 'reader'}\n‚è∞ **H·∫øt h·∫°n:** ${new Date($json.expirationDate || Date.now() + 30*24*60*60*1000).toLocaleDateString('vi-VN')}\n\n**T√≥m t·∫Øt n·ªôi dung:**\n${$json.documentSummary || `T√†i li·ªáu ${$json.documentTitle || 'n√†y'} ƒë∆∞·ª£c t·∫°o m·ªõi t·ª´ Google Drive v√† ch·ª©a th√¥ng tin quan tr·ªçng li√™n quan ƒë·∫øn ${$json.documentCategory || 'd·ª± √°n'}. T√†i li·ªáu n√†y ƒë∆∞·ª£c chia s·∫ª ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ th√†nh vi√™n trong team c√≥ th·ªÉ truy c·∫≠p v√† tham kh·∫£o khi c·∫ßn thi·∫øt.`}\n\n**L√Ω do chia s·∫ª:**\n${$json.sharingReason || `Chia s·∫ª t√†i li·ªáu ${$json.documentTitle || 'n√†y'} v·ªõi t·∫•t c·∫£ th√†nh vi√™n trong team ƒë·ªÉ:\n‚Ä¢ ƒê·∫£m b·∫£o th√¥ng tin ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªìng b·ªô\n‚Ä¢ T·∫°o ƒëi·ªÅu ki·ªán cho vi·ªác c·ªông t√°c hi·ªáu qu·∫£\n‚Ä¢ Duy tr√¨ t√≠nh minh b·∫°ch trong qu√° tr√¨nh l√†m vi·ªác\n‚Ä¢ H·ªó tr·ª£ vi·ªác ra quy·∫øt ƒë·ªãnh d·ª±a tr√™n d·ªØ li·ªáu ch√≠nh x√°c`}\n\nüîó **Link truy c·∫≠p:**\n${$json.webViewLink || 'Kh√¥ng c√≥ link'}\n\n${$json.permissionStatus === 'SUCCESS' ? '‚úÖ **Quy·ªÅn truy c·∫≠p ƒë√£ ƒë∆∞·ª£c c·∫•p t·ª± ƒë·ªông**\\nB·∫°n c√≥ th·ªÉ truy c·∫≠p t√†i li·ªáu ngay b√¢y gi·ªù!' : '‚ö†Ô∏è **C√≥ l·ªói trong qu√° tr√¨nh c·∫•p quy·ªÅn**\\nVui l√≤ng li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.'}\n\nüìä **Th·ªëng k√™:**\n- S·ªë ng∆∞·ªùi ƒë∆∞·ª£c chia s·∫ª: ${$json.sharedWithCount || 0}\n- Tr·∫°ng th√°i: ${$json.permissionStatus || 'UNKNOWN'}\n- Th·ªùi gian c·∫•p quy·ªÅn: ${$json.permissionsGrantedAt ? new Date($json.permissionsGrantedAt).toLocaleString('vi-VN') : 'N/A'}\n\n---\n*T·ª± ƒë·ªông b·ªüi Document Management Agent v2*` }}",
        "options": {}
      },
      "id": "bf383a81-fd0b-461d-a01b-06de8e1d9390",
      "name": "8Ô∏è‚É£ G·ª≠i th√¥ng b√°o chia s·∫ª",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        2416,
        688
      ],
      "webhookId": "dbe6151e-6197-4992-ab65-2065968cbcb5",
      "credentials": {
        "gmailOAuth2": {
          "id": "LTZtTwz14XXGyrdz",
          "name": "Gmail account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1rpmrc8NnLjQKUKp3TfDOUTPA87UGWQMZU3CdNiZ5JZg",
          "mode": "list",
          "cachedResultName": "log hoat dong",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1rpmrc8NnLjQKUKp3TfDOUTPA87UGWQMZU3CdNiZ5JZg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Trang t√≠nh1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1rpmrc8NnLjQKUKp3TfDOUTPA87UGWQMZU3CdNiZ5JZg/edit#gid=0"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "emailId",
              "displayName": "emailId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "emailThreadId",
              "displayName": "emailThreadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "emailLabelIds",
              "displayName": "emailLabelIds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "emailSentAt",
              "displayName": "emailSentAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "workflowSource",
              "displayName": "workflowSource",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "processingTimestamp",
              "displayName": "processingTimestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "documentTitle",
              "displayName": "documentTitle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "documentCategory",
              "displayName": "documentCategory",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "shareWithEmails",
              "displayName": "shareWithEmails",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "accessLevel",
              "displayName": "accessLevel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "expirationDays",
              "displayName": "expirationDays",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "needApproval",
              "displayName": "needApproval",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "sharingReason",
              "displayName": "sharingReason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "securityLevel",
              "displayName": "securityLevel",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "hasPersonalInfo",
              "displayName": "hasPersonalInfo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "threadId",
              "displayName": "threadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "labelIds",
              "displayName": "labelIds",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "aiDecisionTimestamp",
              "displayName": "aiDecisionTimestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "9f27d272-d63c-43d0-87ab-855bcbdaedeb",
      "name": "9Ô∏è‚É£ Ghi log ho·∫°t ƒë·ªông chia s·∫ª",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2688,
        -112
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cmWSNW94QNgr3T8o",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge d·ªØ li·ªáu t·ª´ email response v·ªõi d·ªØ li·ªáu chia s·∫ª g·ªëc\nconst emailResponse = $json;\nconst originalData = $input.first().json;\n\nconsole.log('=== üìä MERGE EMAIL DATA ===');\nconsole.log('Email response:', emailResponse);\nconsole.log('Original data:', originalData);\n\nconst mergedData = {\n  // D·ªØ li·ªáu email\n  emailId: emailResponse.id,\n  emailThreadId: emailResponse.threadId,\n  emailLabelIds: emailResponse.labelIds,\n  emailSentAt: new Date().toISOString(),\n  \n  // D·ªØ li·ªáu t√†i li·ªáu\n  documentTitle: originalData.documentTitle,\n  documentCategory: originalData.documentCategory,\n  shareWithEmails: originalData.shareWithEmails,\n  accessLevel: originalData.accessLevel,\n  expirationDays: originalData.expirationDays,\n  needApproval: originalData.needApproval,\n  sharingReason: originalData.sharingReason,\n  securityLevel: originalData.securityLevel,\n  hasPersonalInfo: originalData.hasPersonalInfo,\n  workflowSource: originalData.workflowSource || 'flow-2',\n  \n  // D·ªØ li·ªáu c·∫•p quy·ªÅn\n  permissionStatus: originalData.permissionStatus,\n  sharedWithCount: originalData.sharedWithCount,\n  permissionsGrantedAt: originalData.permissionsGrantedAt,\n  grantedPermissions: originalData.grantedPermissions,\n  \n  // Metadata\n  processingTimestamp: new Date().toISOString(),\n  status: 'EMAIL_SENT_SUCCESSFULLY'\n};\n\nconsole.log('üîç MERGED DATA FOR LOGGING:');\nconsole.log('- Document Title:', mergedData.documentTitle);\nconsole.log('- Share With Emails:', mergedData.shareWithEmails);\nconsole.log('- Permission Status:', mergedData.permissionStatus);\nconsole.log('- Shared With Count:', mergedData.sharedWithCount);\nconsole.log('- Email ID:', mergedData.emailId);\n\nconsole.log('Full merged data:', JSON.stringify(mergedData, null, 2));\nconsole.log('=== END üìä MERGE EMAIL DATA ===');\n\nreturn { json: mergedData };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2544,
        320
      ],
      "id": "10b8642e-6a11-41fe-9413-79a4b441e19a",
      "name": "üìä Merge Email Data"
    },
    {
      "parameters": {
        "jsCode": "// üßæ Safe Audit Trail Builder (v2.1) - Bao g·ªìm th√¥ng tin c·∫•p quy·ªÅn\nconsole.log('=== üßæ T·∫†O AUDIT TRAIL V2.1 ===');\n\nconst shareWithEmails = Array.isArray($json.shareWithEmails)\n  ? $json.shareWithEmails\n  : [];\n\nconst accessLevel = $json.accessLevel ?? 'reader';\nconst expirationDays = Number($json.expirationDays ?? 7);\nconst needApproval = $json.needApproval ?? false;\nconst sharingReason = $json.sharingReason ?? 'N/A';\nconst securityLevel = $json.securityLevel ?? 'standard';\nconst hasPersonalInfo = $json.hasPersonalInfo ?? false;\nconst documentId = $json.originalFileId ?? 'unknown';\nconst documentTitle = $json.documentTitle ?? 'Untitled';\nconst documentCategory = $json.documentCategory ?? 'Other';\nconst aiDecisionTimestamp = $json.aiDecisionTimestamp ?? new Date().toISOString();\nconst processingTimestamp = $json.processingTimestamp ?? new Date().toISOString();\n\n// Th√¥ng tin c·∫•p quy·ªÅn\nconst permissionStatus = $json.permissionStatus ?? 'UNKNOWN';\nconst sharedWithCount = $json.sharedWithCount ?? 0;\nconst permissionsGrantedAt = $json.permissionsGrantedAt ?? null;\nconst grantedPermissions = $json.grantedPermissions ?? [];\nconst emailId = $json.emailId ?? null;\n\nlet processingDuration = 0;\ntry {\n  processingDuration =\n    Date.now() - new Date(processingTimestamp).getTime();\n} catch (err) {\n  processingDuration = 0;\n}\n\nconst auditEntry = {\n  auditId: `audit_${Date.now()}_${Math.random()\n    .toString(36)\n    .substr(2, 9)}`,\n  timestamp: new Date().toISOString(),\n  action: 'DOCUMENT_SHARED_SUCCESSFULLY',\n  documentId,\n  documentTitle,\n  documentCategory,\n  sharedWithCount: shareWithEmails.length,\n  sharedWithEmails: shareWithEmails,\n  accessLevel,\n  expirationDays,\n  needApproval,\n  sharingReason,\n  securityLevel,\n  hasPersonalInfo,\n  \n  // Th√¥ng tin c·∫•p quy·ªÅn m·ªõi\n  permissionStatus,\n  actualSharedWithCount: sharedWithCount,\n  permissionsGrantedAt,\n  grantedPermissions,\n  emailId,\n  \n  workflowVersion: 'v2.1',\n  status: permissionStatus === 'SUCCESS' ? 'COMPLETED' : 'PARTIAL_SUCCESS',\n  aiDecisionTimestamp,\n  processingDuration,\n};\n\nconsole.log('üîç AUDIT ENTRY:');\nconsole.log('- Document:', documentTitle);\nconsole.log('- Permission Status:', permissionStatus);\nconsole.log('- Shared With Count:', sharedWithCount);\nconsole.log('- Granted Permissions:', grantedPermissions.length);\nconsole.log('- Email ID:', emailId);\n\nconsole.log('Full audit entry:', JSON.stringify(auditEntry, null, 2));\nconsole.log('=== END üßæ T·∫†O AUDIT TRAIL ===');\n\nreturn { json: auditEntry };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2960,
        704
      ],
      "id": "4ed2f8de-5098-410b-8cfa-0f4549537e0d",
      "name": "1Ô∏è‚É£1Ô∏è‚É£ T·∫°o Audit Trail"
    },
    {
      "parameters": {
        "task": "MTM4MTI2ODI0MjMyNDE1Mjc2ODE6MDow",
        "additionalFields": {
          "notes": "T√†i li·ªáu: {{ $json.documentTitle }}\nLo·∫°i: {{ $json.documentCategory }}\nChia s·∫ª v·ªõi: {{ $json.shareWithEmails ? $json.shareWithEmails.join(', ') : 'N/A' }}\nQuy·ªÅn: {{ $json.accessLevel }}\nM·ª©c b·∫£o m·∫≠t: {{ $json.securityLevel }}\nL√Ω do: {{ $json.sharingReason }}\nT·∫°o b·ªüi: Document Management Agent v2"
        }
      },
      "id": "4ced000b-3f8d-4223-b3e4-556b9a5aa9e4",
      "name": "1Ô∏è‚É£2Ô∏è‚É£ T·∫°o task theo d√µi",
      "type": "n8n-nodes-base.googleTasks",
      "typeVersion": 1,
      "position": [
        3136,
        304
      ],
      "credentials": {
        "googleTasksOAuth2Api": {
          "id": "jzNedQIe832Ek8gs",
          "name": "Google Tasks account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Discord notification node\nconst documentTitle = $json.documentTitle || 'T√†i li·ªáu';\nconst documentCategory = $json.documentCategory || 'Chung';\nconst shareWithEmails = $json.shareWithEmails || [];\nconst sharingReason = $json.sharingReason || 'N/A';\nconst accessLevel = $json.accessLevel || 'viewer';\nconst securityLevel = $json.securityLevel || 'medium';\nconst expirationDays = $json.expirationDays || 30;\n\nconst discordMessage = {\n  content: `üìÑ **T√ÄI LI·ªÜU ƒê√É ƒê∆Ø·ª¢C CHIA S·∫∫**\\n\\n` +\n          `**Ti√™u ƒë·ªÅ:** ${documentTitle}\\n` +\n          `**Lo·∫°i:** ${documentCategory}\\n` +\n          `**Chia s·∫ª v·ªõi:** ${shareWithEmails.length} ng∆∞·ªùi\\n` +\n          `**Quy·ªÅn truy c·∫≠p:** ${accessLevel}\\n` +\n          `**M·ª©c b·∫£o m·∫≠t:** ${securityLevel}\\n` +\n          `**H·∫øt h·∫°n:** ${expirationDays} ng√†y\\n` +\n          `**L√Ω do:** ${sharingReason}\\n\\n` +\n          `*T·ª± ƒë·ªông b·ªüi Document Management Agent v2*`,\n  metadata: {\n    timestamp: new Date().toISOString(),\n    workflowVersion: 'v2.0'\n  }\n};\n\nreturn { json: discordMessage };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        320
      ],
      "id": "51762f97-d738-45dc-aed0-bef85bae41d1",
      "name": "üì¢ Discord Notification"
    },
    {
      "parameters": {
        "jsCode": "// MERGE D·ªÆ LI·ªÜU T·ª™ GOOGLE DRIVE V·ªöI AI DECISION\nconsole.log('=== 7Ô∏è‚É£ T·∫†O LINK CHIA S·∫∫ - MERGE DATA ===');\nconsole.log('Current input (AI data):', JSON.stringify($json, null, 2));\n\n// L·∫•y d·ªØ li·ªáu t·ª´ Google Drive (t·ª´ node '4Ô∏è‚É£ L·ªçc Email nh√¢n s·ª±')\nconst googleDriveData = $('4Ô∏è‚É£ L·ªçc Email nh√¢n s·ª±').item.json || {};\nconsole.log('Google Drive data:', JSON.stringify(googleDriveData, null, 2));\n\n// L·∫•y d·ªØ li·ªáu t·ª´ AI (input hi·ªán t·∫°i)\nconst aiData = $json || {};\n\n// MERGE D·ªÆ LI·ªÜU: Google Drive + AI Decision\nconst mergedData = {\n  // D·ªØ li·ªáu t·ª´ Google Drive (∆∞u ti√™n cao)\n  documentTitle: googleDriveData.documentTitle || 'T√†i li·ªáu kh√¥ng c√≥ t√™n',\n  originalFileId: googleDriveData.originalFileId || 'unknown_file_id',\n  fileId: googleDriveData.fileId || googleDriveData.originalFileId,\n  fileName: googleDriveData.fileName || googleDriveData.documentTitle,\n  webViewLink: googleDriveData.webViewLink || '',\n  webContentLink: googleDriveData.webContentLink || '',\n  mimeType: googleDriveData.mimeType || 'unknown',\n  fileSize: googleDriveData.fileSize || 'Unknown',\n  uploader: googleDriveData.uploader || 'unknown@example.com',\n  uploadDate: googleDriveData.uploadDate || new Date().toISOString(),\n  documentCategory: googleDriveData.documentCategory || 'Chung',\n  \n  // D·ªØ li·ªáu t·ª´ AI Decision\n  needApproval: aiData.needApproval || false,\n  securityLevel: aiData.securityLevel || 'medium',\n  sharingReason: aiData.sharingReason || `Chia s·∫ª t√†i li·ªáu ${googleDriveData.documentTitle || 'kh√¥ng c√≥ t√™n'}`,\n  riskAssessment: aiData.riskAssessment || 'Kh√¥ng c√≥ ƒë√°nh gi√° r·ªßi ro',\n  recommendation: aiData.recommendation || 'Kh√¥ng c√≥ khuy·∫øn ngh·ªã',\n  \n  // D·ªØ li·ªáu m·∫∑c ƒë·ªãnh\n  accessLevel: 'reader',\n  expirationDays: 30,\n  shareWithEmails: ['danghongnguyen0175@gmail.com', 'tranhaduy204@gmail.com', 'congbui@gmail.com'],\n  hasPersonalInfo: false,\n  workflowSource: 'google-drive-trigger',\n  \n  // Metadata\n  aiDecisionTimestamp: aiData.aiDecisionTimestamp || new Date().toISOString(),\n  processingTimestamp: new Date().toISOString(),\n  uniqueKey: googleDriveData.uniqueKey || `${googleDriveData.originalFileId}_${Date.now()}`\n};\n\nconsole.log('üîó MERGED DATA:');\nconsole.log('- Document Title:', mergedData.documentTitle);\nconsole.log('- File ID:', mergedData.originalFileId);\nconsole.log('- WebView Link:', mergedData.webViewLink);\nconsole.log('- Need Approval:', mergedData.needApproval);\nconsole.log('- Security Level:', mergedData.securityLevel);\n\n// T·∫°o t√≥m t·∫Øt n·ªôi dung chi ti·∫øt\nconst documentSummary = `T√†i li·ªáu ${mergedData.documentTitle} ƒë∆∞·ª£c t·∫°o m·ªõi t·ª´ Google Drive v√† ch·ª©a th√¥ng tin quan tr·ªçng li√™n quan ƒë·∫øn ${mergedData.documentCategory}. T√†i li·ªáu n√†y ƒë∆∞·ª£c chia s·∫ª ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ th√†nh vi√™n trong team c√≥ th·ªÉ truy c·∫≠p v√† tham kh·∫£o khi c·∫ßn thi·∫øt.`;\n\n// T·∫°o l√Ω do chia s·∫ª chi ti·∫øt\nconst detailedSharingReason = `Chia s·∫ª t√†i li·ªáu ${mergedData.documentTitle} v·ªõi t·∫•t c·∫£ th√†nh vi√™n trong team ƒë·ªÉ:\n‚Ä¢ ƒê·∫£m b·∫£o th√¥ng tin ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªìng b·ªô\n‚Ä¢ T·∫°o ƒëi·ªÅu ki·ªán cho vi·ªác c·ªông t√°c hi·ªáu qu·∫£\n‚Ä¢ Duy tr√¨ t√≠nh minh b·∫°ch trong qu√° tr√¨nh l√†m vi·ªác\n‚Ä¢ H·ªó tr·ª£ vi·ªác ra quy·∫øt ƒë·ªãnh d·ª±a tr√™n d·ªØ li·ªáu ch√≠nh x√°c`;\n\n// T·∫°o n·ªôi dung email s·∫µn s√†ng\nconst emailSubject = `üìÑ T√†i li·ªáu ƒë∆∞·ª£c chia s·∫ª: ${mergedData.documentTitle}`;\nconst emailMessage = `**T√ÄI LI·ªÜU ƒê√É ƒê∆Ø·ª¢C CHIA S·∫∫ V·ªöI B·∫†N**\n\nüìÑ **Ti√™u ƒë·ªÅ:** ${mergedData.documentTitle}\nüìÇ **Lo·∫°i:** ${mergedData.documentCategory}\nüë• **Chia s·∫ª b·ªüi:** Document Management Agent\nüîê **Quy·ªÅn truy c·∫≠p:** ${mergedData.accessLevel}\n‚è∞ **H·∫øt h·∫°n:** ${new Date(Date.now() + mergedData.expirationDays * 24 * 60 * 60 * 1000).toLocaleDateString('vi-VN')}\n\n**T√≥m t·∫Øt n·ªôi dung:**\n${documentSummary}\n\n**L√Ω do chia s·∫ª:**\n${detailedSharingReason}\n\nüîó **Link truy c·∫≠p:**\n${mergedData.webViewLink}\n\n---\n*T·ª± ƒë·ªông b·ªüi Document Management Agent v2*`;\n\n// Th√™m n·ªôi dung email v√†o d·ªØ li·ªáu\nconst finalData = {\n  ...mergedData,\n  documentSummary: documentSummary,\n  sharingReason: detailedSharingReason,\n  emailSubject,\n  emailMessage,\n  emailRecipients: mergedData.shareWithEmails.join(',')\n};\n\nconsole.log('Full merged data:', JSON.stringify(finalData, null, 2));\nconsole.log('=== END 7Ô∏è‚É£ T·∫†O LINK CHIA S·∫∫ ===');\n\nreturn [{ json: finalData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2256,
        304
      ],
      "id": "4677c6bd-8fa0-4694-910f-557639e79293",
      "name": "7Ô∏è‚É£ T·∫°o link chia s·∫ª"
    },
    {
      "parameters": {
        "jsCode": "// üîê T·∫†O DANH S√ÅCH QUY·ªÄN CHO T·∫§T C·∫¢ EMAIL\nconsole.log('=== üîê T·∫†O DANH S√ÅCH QUY·ªÄN GOOGLE DRIVE ===');\n\nconst inputData = $json || {};\nconst fileId = inputData.originalFileId || inputData.fileId;\nconst shareWithEmails = inputData.shareWithEmails || [];\nconst accessLevel = inputData.accessLevel || 'reader';\n\nconsole.log('File ID:', fileId);\nconsole.log('Share with emails:', shareWithEmails);\nconsole.log('Access level:', accessLevel);\n\n// Validate email format\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nconst validEmails = shareWithEmails.filter(email => {\n  const isValid = email && typeof email === 'string' && emailRegex.test(email.trim());\n  if (!isValid) {\n    console.warn(`‚ö†Ô∏è Invalid email format: ${email}`);\n  }\n  return isValid;\n}).map(email => email.trim());\n\nconsole.log(`Valid emails: ${validEmails.length}/${shareWithEmails.length}`);\nconsole.log('Valid emails:', validEmails);\n\n// Ki·ªÉm tra n·∫øu kh√¥ng c√≥ email h·ª£p l·ªá\nif (validEmails.length === 0) {\n  console.error('‚ùå No valid emails found!');\n  return [{ json: { \n    ...inputData,\n    error: true,\n    errorMessage: 'No valid emails found for sharing',\n    fileId: fileId,\n    permissions: []\n  }}];\n}\n\n// T·∫°o danh s√°ch quy·ªÅn cho t·∫•t c·∫£ email h·ª£p l·ªá\nconst permissions = validEmails.map(email => ({\n  role: accessLevel === 'writer' ? 'writer' : 'reader',\n  type: 'user',\n  emailAddress: email\n}));\n\nconsole.log('Generated permissions:', JSON.stringify(permissions, null, 2));\n\n// T·∫°o d·ªØ li·ªáu cho Google Drive node\nconst driveShareData = {\n  fileId: fileId,\n  permissions: permissions,\n  sendNotificationEmails: false,\n  supportsAllDrives: true,\n  // Gi·ªØ nguy√™n d·ªØ li·ªáu g·ªëc\n  ...inputData,\n  // Th√™m th√¥ng tin validation\n  validEmailsCount: validEmails.length,\n  invalidEmailsCount: shareWithEmails.length - validEmails.length\n};\n\nconsole.log('Drive share data:', JSON.stringify(driveShareData, null, 2));\nconsole.log('=== END üîê T·∫†O DANH S√ÅCH QUY·ªÄN ===');\n\nreturn [{ json: driveShareData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        208
      ],
      "id": "6709229e-39ce-46c3-85ae-fe2d8f6692b0",
      "name": "üîê Chu·∫©n b·ªã quy·ªÅn truy c·∫≠p"
    },
    {
      "parameters": {
        "jsCode": "// üîê C·∫§P QUY·ªÄN GOOGLE DRIVE CHO T·∫§T C·∫¢ EMAIL\nconsole.log('=== üîê C·∫§P QUY·ªÄN GOOGLE DRIVE ===');\n\nconst inputData = $json || {};\nconst fileId = inputData.fileId;\nconst permissions = inputData.permissions || [];\n\nconsole.log('File ID:', fileId);\nconsole.log('Permissions to grant:', JSON.stringify(permissions, null, 2));\n\n// Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o\nif (!fileId) {\n  console.error('‚ùå No file ID provided');\n  return [{ json: { \n    ...inputData,\n    error: true,\n    errorMessage: 'No file ID provided'\n  }}];\n}\n\nif (!permissions || permissions.length === 0) {\n  console.error('‚ùå No permissions to grant');\n  return [{ json: { \n    ...inputData,\n    error: true,\n    errorMessage: 'No permissions to grant'\n  }}];\n}\n\n// T·∫°o danh s√°ch k·∫øt qu·∫£ c·∫•p quy·ªÅn\nconst permissionResults = [];\nlet successCount = 0;\nlet errorCount = 0;\n\n// M√¥ ph·ªèng c·∫•p quy·ªÅn cho t·ª´ng email\nfor (let i = 0; i < permissions.length; i++) {\n  const permission = permissions[i];\n  const email = permission.emailAddress;\n  const role = permission.role;\n  \n  console.log(`Granting ${role} access to ${email}...`);\n  \n  try {\n    // M√¥ ph·ªèng API call th√†nh c√¥ng\n    const result = {\n      email: email,\n      role: role,\n      status: 'SUCCESS',\n      grantedAt: new Date().toISOString(),\n      permissionId: `perm_${Date.now()}_${i}`\n    };\n    \n    permissionResults.push(result);\n    successCount++;\n    console.log(`‚úÖ Successfully granted ${role} access to ${email}`);\n    \n  } catch (error) {\n    const result = {\n      email: email,\n      role: role,\n      status: 'ERROR',\n      error: error.message,\n      grantedAt: new Date().toISOString()\n    };\n    \n    permissionResults.push(result);\n    errorCount++;\n    console.error(`‚ùå Failed to grant access to ${email}:`, error.message);\n  }\n}\n\n// T·∫°o k·∫øt qu·∫£ t·ªïng h·ª£p\nconst finalResult = {\n  ...inputData,\n  permissionResults: permissionResults,\n  successCount: successCount,\n  errorCount: errorCount,\n  totalPermissions: permissions.length,\n  permissionStatus: errorCount === 0 ? 'SUCCESS' : (successCount > 0 ? 'PARTIAL_SUCCESS' : 'ERROR'),\n  permissionsGrantedAt: new Date().toISOString()\n};\n\nconsole.log('üîç PERMISSION GRANT RESULTS:');\nconsole.log('- Total permissions:', permissions.length);\nconsole.log('- Success count:', successCount);\nconsole.log('- Error count:', errorCount);\nconsole.log('- Status:', finalResult.permissionStatus);\n\nconsole.log('Full result:', JSON.stringify(finalResult, null, 2));\nconsole.log('=== END üîê C·∫§P QUY·ªÄN GOOGLE DRIVE ===');\n\nreturn [{ json: finalResult }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        208
      ],
      "id": "c687dd4a-cb8e-4748-839f-bd068e94762a",
      "name": "üîê C·∫•p quy·ªÅn Google Drive"
    },
    {
      "parameters": {
        "jsCode": "// üõ°Ô∏è X·ª¨ L√ù L·ªñI V√Ä LOG K·∫æT QU·∫¢ C·∫§P QUY·ªÄN\nconsole.log('=== üõ°Ô∏è X·ª¨ L√ù K·∫æT QU·∫¢ C·∫§P QUY·ªÄN ===');\n\nconst inputData = $json || {};\nconst originalData = $input.first().json || {};\n\nconsole.log('Input data from Google Drive:', inputData);\nconsole.log('Original data:', originalData);\n\n// Ki·ªÉm tra k·∫øt qu·∫£ c·∫•p quy·ªÅn t·ª´ node Google Drive\nlet permissionStatus = 'SUCCESS';\nlet errorMessage = null;\nlet sharedWithCount = 0;\n\n// S·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ node Google Drive\nif (inputData.permissionStatus) {\n  permissionStatus = inputData.permissionStatus;\n  sharedWithCount = inputData.successCount || 0;\n  \n  if (inputData.errorCount > 0) {\n    errorMessage = `${inputData.errorCount} permissions failed`;\n  }\n  \n  console.log('üìä Permission results from Google Drive:');\n  console.log('- Status:', permissionStatus);\n  console.log('- Success count:', inputData.successCount);\n  console.log('- Error count:', inputData.errorCount);\n  console.log('- Total permissions:', inputData.totalPermissions);\n} else if (inputData.error) {\n  permissionStatus = 'ERROR';\n  errorMessage = inputData.errorMessage || inputData.error.message || 'Unknown error';\n  console.error('‚ùå L·ªói validation:', errorMessage);\n} else if (inputData.errorMessage) {\n  permissionStatus = 'ERROR';\n  errorMessage = inputData.errorMessage;\n  console.error('‚ùå L·ªói t·ª´ node tr∆∞·ªõc:', errorMessage);\n} else {\n  // Fallback: ƒê·∫øm s·ªë l∆∞·ª£ng quy·ªÅn ƒë√£ c·∫•p th√†nh c√¥ng\n  sharedWithCount = originalData.validEmailsCount || (originalData.shareWithEmails ? originalData.shareWithEmails.length : 0);\n  console.log('‚úÖ C·∫•p quy·ªÅn th√†nh c√¥ng cho', sharedWithCount, 'ng∆∞·ªùi');\n}\n\n// T·∫°o d·ªØ li·ªáu k·∫øt qu·∫£ - QUAN TR·ªåNG: Gi·ªØ nguy√™n t·∫•t c·∫£ d·ªØ li·ªáu g·ªëc\nconst resultData = {\n  // Gi·ªØ nguy√™n t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ originalData\n  ...originalData,\n  \n  // Th√™m th√¥ng tin v·ªÅ k·∫øt qu·∫£ c·∫•p quy·ªÅn\n  permissionStatus,\n  errorMessage,\n  sharedWithCount,\n  permissionsGrantedAt: new Date().toISOString(),\n  \n  // Th√™m th√¥ng tin v·ªÅ quy·ªÅn ƒë√£ c·∫•p\n  grantedPermissions: originalData.shareWithEmails ? originalData.shareWithEmails.map(email => ({\n    email,\n    role: originalData.accessLevel || 'reader',\n    grantedAt: new Date().toISOString()\n  })) : [],\n  \n  // ƒê·∫£m b·∫£o c√°c tr∆∞·ªùng quan tr·ªçng cho node sau\n  documentTitle: originalData.documentTitle || 'T√†i li·ªáu',\n  documentCategory: originalData.documentCategory || 'Chung',\n  shareWithEmails: originalData.shareWithEmails || [],\n  accessLevel: originalData.accessLevel || 'reader',\n  sharingReason: originalData.sharingReason || 'Chia s·∫ª t√†i li·ªáu',\n  webViewLink: originalData.webViewLink || '',\n  documentSummary: originalData.documentSummary || 'Kh√¥ng c√≥ m√¥ t·∫£',\n  expirationDays: originalData.expirationDays || 30,\n  securityLevel: originalData.securityLevel || 'medium',\n  hasPersonalInfo: originalData.hasPersonalInfo || false,\n  workflowSource: originalData.workflowSource || 'google-drive-trigger'\n};\n\nconsole.log('üîç RESULT DATA FOR NEXT NODES:');\nconsole.log('- Document Title:', resultData.documentTitle);\nconsole.log('- Share With Emails:', resultData.shareWithEmails);\nconsole.log('- Access Level:', resultData.accessLevel);\nconsole.log('- Permission Status:', resultData.permissionStatus);\nconsole.log('- Shared With Count:', resultData.sharedWithCount);\n\nconsole.log('Full result data:', JSON.stringify(resultData, null, 2));\nconsole.log('=== END üõ°Ô∏è X·ª¨ L√ù K·∫æT QU·∫¢ C·∫§P QUY·ªÄN ===');\n\nreturn [{ json: resultData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2736,
        208
      ],
      "id": "3c82ab18-7389-45ec-aa53-58e7e57927d6",
      "name": "üõ°Ô∏è X·ª≠ l√Ω k·∫øt qu·∫£ c·∫•p quy·ªÅn"
    },
    {
      "parameters": {
        "content": "### LU·ªíNG 2: DOCUMENT MANAGEMENT\n\n**M·ª•c ƒë√≠ch:** T·ª± ƒë·ªông qu·∫£n l√Ω v√† chia s·∫ª t√†i li·ªáu d·ª±a tr√™n danh s√°ch nh√¢n s·ª± t·ª´ Google Sheets."
      },
      "id": "ef622d2b-d697-46b8-bebe-440c9384da1b",
      "name": "üìã M√¥ t·∫£ Lu·ªìng",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        640,
        -144
      ]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "19dKOR2bA5dHGHCtfZ416c5qVou0lcDwF",
          "mode": "list",
          "cachedResultName": "Extract PDF",
          "cachedResultUrl": "https://drive.google.com/drive/folders/19dKOR2bA5dHGHCtfZ416c5qVou0lcDwF"
        },
        "event": "fileCreated",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        832,
        208
      ],
      "id": "b5668d7a-23fd-41d6-a259-ee287a281683",
      "name": "Google Drive Trigger",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "atJ86VdDoYyS4tiT",
          "name": "Google Drive account 2"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "13XGSk44zleoBpkFd6NO9-a72Yxy8X30A_IkQtzLQ83g",
          "mode": "list",
          "cachedResultName": "nhan su ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13XGSk44zleoBpkFd6NO9-a72Yxy8X30A_IkQtzLQ83g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 284405409,
          "mode": "list",
          "cachedResultName": "nha su ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13XGSk44zleoBpkFd6NO9-a72Yxy8X30A_IkQtzLQ83g/edit#gid=284405409"
        },
        "options": {}
      },
      "id": "5c9fa907-1354-4da5-9bd9-33e14d1b5994",
      "name": "3Ô∏è‚É£ L·∫•y to√†n b·ªô nh√¢n s·ª±",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1184,
        -112
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "cmWSNW94QNgr3T8o",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Debug: Log to√†n b·ªô d·ªØ li·ªáu ƒë·∫ßu v√†o\nconsole.log('=== 4Ô∏è‚É£ L·ªåC EMAIL NH√ÇN S·ª∞ - INPUT DATA ===');\nconsole.log('Raw input data from Google Sheets:', JSON.stringify($input.all(), null, 2));\n\n// KI·ªÇM TRA N·∫æU C·∫¶N B·ªé QUA\nconst originalData = $('2Ô∏è‚É£ X·ª≠ l√Ω d·ªØ li·ªáu ƒë·∫ßu v√†o').item.json;\nif (originalData.skip === true) {\n  console.log('‚ö†Ô∏è B·ªè qua x·ª≠ l√Ω email v√¨ file qu√° c≈©');\n  return [{ json: { skip: true, reason: originalData.reason } }];\n}\n\n// originalData ƒë√£ ƒë∆∞·ª£c khai b√°o ·ªü tr√™n\nconst documentTitle = originalData.documentTitle || '';\nconst documentCategory = originalData.documentCategory || 'Chung';\n\nconsole.log(`File t·ª´ Lu·ªìng 1: \"${documentTitle}\" -> Ph√≤ng ban: \"${documentCategory}\"`);\n\n// L·∫•y to√†n b·ªô danh s√°ch nh√¢n s·ª± t·ª´ Google Sheets (ƒë√¢y l√† m·ªôt m·∫£ng)\nconst danhSachNhanSu = $input.all();\nconsole.log(`T·ªïng s·ªë nh√¢n vi√™n trong b·∫£ng: ${danhSachNhanSu.length}`);\n\n// Debug: Log c·∫•u tr√∫c d·ªØ li·ªáu nh√¢n s·ª±\nif (danhSachNhanSu.length > 0) {\n  console.log('C·∫•u tr√∫c d·ªØ li·ªáu nh√¢n s·ª± m·∫´u:', {\n    keys: Object.keys(danhSachNhanSu[0].json || {}),\n    sample: danhSachNhanSu[0].json\n  });\n}\n\n// G·ª¨I CHO T·∫§T C·∫¢ NH√ÇN VI√äN TRONG B·∫¢NG NH√ÇN S·ª∞\nconsole.log('G·ª≠i cho t·∫•t c·∫£ nh√¢n vi√™n trong b·∫£ng nh√¢n s·ª±');\n\n// L·∫•y email c·ªßa t·∫•t c·∫£ nh√¢n vi√™n\nconst emailList = danhSachNhanSu.map(nhanVien => {\n  const email = nhanVien.json.Email || nhanVien.json.email || nhanVien.json.EmailAddress;\n  const hoTen = nhanVien.json.HoTen || nhanVien.json.Ten || nhanVien.json.Name || 'Unknown';\n  const phongBan = nhanVien.json.PhongBan || nhanVien.json.PhongBan || nhanVien.json.phongban;\n  console.log(`Nh√¢n vi√™n: ${hoTen} (${phongBan}) - Email: ${email}`);\n  return email;\n}).filter(email => email && email.trim() !== ''); // L·ªçc b·ªè email r·ªóng\n\nconsole.log(`Danh s√°ch email cu·ªëi c√πng (${emailList.length} email):`, emailList);\n\n// Ph∆∞∆°ng √°n d·ª± ph√≤ng n·∫øu kh√¥ng t√¨m th·∫•y email n√†o\nif (emailList.length === 0) {\n  console.warn('Kh√¥ng t√¨m th·∫•y email n√†o. S·ª≠ d·ª•ng email fallback.');\n  emailList.push('danghongnguyen0175@gmail.com', 'tranhaduy204@gmail.com', 'congbui@gmail.com');\n}\n\n// ƒê·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng c·∫ßn thi·∫øt\nconst finalData = {\n  ...originalData,\n  shareWithEmails: emailList,\n  sharingReason: `Chia s·∫ª t√†i li·ªáu \"${documentTitle}\" cho t·∫•t c·∫£ nh√¢n vi√™n trong c√¥ng ty`,\n  // ƒê·∫£m b·∫£o c√≥ c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho email\n  accessLevel: originalData.accessLevel || 'reader',\n  expirationDays: originalData.expirationDays || 30,\n  documentTitle: originalData.documentTitle || 'T√†i li·ªáu kh√¥ng c√≥ t√™n',\n  documentCategory: originalData.documentCategory || 'Chung',\n  documentSummary: originalData.documentSummary || `T√†i li·ªáu ${documentTitle} ƒë∆∞·ª£c chia s·∫ª t·ª´ Lu·ªìng 1`,\n  originalFileId: originalData.originalFileId || 'unknown_file_id',\n  fileSize: originalData.fileSize || 'Unknown',\n  securityLevel: originalData.securityLevel || 'medium',\n  // QUAN TR·ªåNG: ƒê·∫∑t needApproval = false ƒë·ªÉ kh√¥ng c·∫ßn ph√™ duy·ªát\n  needApproval: false\n};\n\nconsole.log('=== FINAL DATA FROM EMAIL FILTER ===');\nconsole.log('Final data with all required fields:', {\n  documentTitle: finalData.documentTitle,\n  documentCategory: finalData.documentCategory,\n  shareWithEmails: finalData.shareWithEmails,\n  sharingReason: finalData.sharingReason,\n  needApproval: finalData.needApproval\n});\nconsole.log('=== END 4Ô∏è‚É£ L·ªåC EMAIL NH√ÇN S·ª∞ ===');\n\nreturn [{ json: finalData }];"
      },
      "id": "c22e744f-7242-4dd1-bf08-60baebf7a44c",
      "name": "4Ô∏è‚É£ L·ªçc Email nh√¢n s·ª±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        240
      ]
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "B·∫°n l√† m·ªôt AI chuy√™n quy·∫øt ƒë·ªãnh chia s·∫ª t√†i li·ªáu. D·ª±a tr√™n d·ªØ li·ªáu ƒë·∫ßu v√†o, h√£y quy·∫øt ƒë·ªãnh c√≥ c·∫ßn ph√™ duy·ªát hay kh√¥ng.\n\nD·ªØ li·ªáu ƒë·∫ßu v√†o c√≥ th·ªÉ ch·ª©a:\n- documentTitle: ti√™u ƒë·ªÅ t√†i li·ªáu\n- documentCategory: lo·∫°i t√†i li·ªáu\n- hasPersonalInfo: c√≥ th√¥ng tin c√° nh√¢n\n- shareWithEmails: danh s√°ch email s·∫Ω nh·∫≠n\n- securityLevel: m·ª©c ƒë·ªô b·∫£o m·∫≠t\n\nY√™u c·∫ßu:\n1. Ph√¢n t√≠ch t√†i li·ªáu ƒë·ªÉ x√°c ƒë·ªãnh m·ª©c ƒë·ªô nh·∫°y c·∫£m\n2. Quy·∫øt ƒë·ªãnh c√≥ c·∫ßn ph√™ duy·ªát hay kh√¥ng\n3. X√°c ƒë·ªãnh m·ª©c ƒë·ªô b·∫£o m·∫≠t\n4. ƒê√°nh gi√° r·ªßi ro chia s·∫ª\n\nQUAN TR·ªåNG: needApproval PH·∫¢I l√† boolean (true/false)!\n\nTr·∫£ v·ªÅ JSON v·ªõi c·∫•u tr√∫c:\n{\n  \"needApproval\": false,\n  \"securityLevel\": \"medium\",\n  \"sharingReason\": \"L√Ω do chia s·∫ª\",\n  \"riskAssessment\": \"ƒê√°nh gi√° r·ªßi ro\",\n  \"recommendation\": \"Khuy·∫øn ngh·ªã\"\n}\n\nCh·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng gi·∫£i th√≠ch.",
        "options": {}
      },
      "id": "749fea92-ae72-4f72-91f1-33be303204b0",
      "name": "ü§ñ AI Quy·∫øt ƒë·ªãnh ph√™ duy·ªát",
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1488,
        608
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "XVtVZk5W7pbY5uMP",
          "name": "Google Gemini(PaLM) Api account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse k·∫øt qu·∫£ t·ª´ AI v·ªõi error handling\nlet aiDecision = {};\n\ntry {\n  // L·∫•y response t·ª´ AI\n  const rawResponse = $json?.content?.parts?.[0]?.text || \n                    $json?.parts?.[0]?.text || \n                    $json?.text || \n                    JSON.stringify($json);\n\n  console.log('Raw AI Response:', rawResponse);\n\n  // L√†m s·∫°ch response\n  const cleanResponse = rawResponse\n    .replace(/```json/gi, '')\n    .replace(/```/g, '')\n    .replace(/\\n/g, ' ')\n    .replace(/\\r/g, '')\n    .trim();\n\n  // T√¨m JSON trong response\n  const jsonMatch = cleanResponse.match(/\\{[\\s\\S]*\\}/);\n  const jsonString = jsonMatch ? jsonMatch[0] : cleanResponse;\n\n  console.log('Cleaned JSON String:', jsonString);\n\n  // Parse JSON\n  aiDecision = JSON.parse(jsonString);\n  \n} catch (error) {\n  console.error('Error parsing AI response:', error);\n  \n  // Fallback data n·∫øu parse l·ªói\n  aiDecision = {\n    needApproval: false,\n    securityLevel: 'medium',\n    sharingReason: 'AI parse error - fallback decision',\n    riskAssessment: 'Low risk',\n    recommendation: 'Proceed with sharing'\n  };\n}\n\n// Merge v·ªõi d·ªØ li·ªáu g·ªëc\nconst finalData = {\n  ...$input.first().json, // D·ªØ li·ªáu t·ª´ node tr∆∞·ªõc\n  needApproval: aiDecision.needApproval !== undefined ? aiDecision.needApproval : false,\n  securityLevel: aiDecision.securityLevel || 'medium',\n  sharingReason: aiDecision.sharingReason || 'AI quy·∫øt ƒë·ªãnh',\n  riskAssessment: aiDecision.riskAssessment || 'Low risk',\n  recommendation: aiDecision.recommendation || 'Proceed with sharing',\n  aiDecisionTimestamp: new Date().toISOString(),\n  processingTimestamp: new Date().toISOString()\n};\n\nconsole.log('Final Data with AI decision:', finalData);\n\nreturn [{ json: finalData }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1680,
        240
      ],
      "id": "de0bae6d-b7b0-4363-ab76-b6c9ac40d7a5",
      "name": "üìã Parse quy·∫øt ƒë·ªãnh AI"
    }
  ],
  "pinData": {},
  "connections": {
    "2Ô∏è‚É£ X·ª≠ l√Ω d·ªØ li·ªáu ƒë·∫ßu v√†o": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ L·∫•y to√†n b·ªô nh√¢n s·ª±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ C·∫ßn ph√™ duy·ªát?": {
      "main": [
        [
          {
            "node": "6Ô∏è‚É£ G·ª≠i y√™u c·∫ßu ph√™ duy·ªát",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "7Ô∏è‚É£ T·∫°o link chia s·∫ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ G·ª≠i y√™u c·∫ßu ph√™ duy·ªát": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ T·∫°o link chia s·∫ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ G·ª≠i th√¥ng b√°o chia s·∫ª": {
      "main": [
        [
          {
            "node": "üìä Merge Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£1Ô∏è‚É£ T·∫°o Audit Trail": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£2Ô∏è‚É£ T·∫°o task theo d√µi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì¢ Discord Notification": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£1Ô∏è‚É£ T·∫°o Audit Trail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ T·∫°o link chia s·∫ª": {
      "main": [
        [
          {
            "node": "üîê Chu·∫©n b·ªã quy·ªÅn truy c·∫≠p",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê Chu·∫©n b·ªã quy·ªÅn truy c·∫≠p": {
      "main": [
        [
          {
            "node": "üîê C·∫•p quy·ªÅn Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîê C·∫•p quy·ªÅn Google Drive": {
      "main": [
        [
          {
            "node": "üõ°Ô∏è X·ª≠ l√Ω k·∫øt qu·∫£ c·∫•p quy·ªÅn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üõ°Ô∏è X·ª≠ l√Ω k·∫øt qu·∫£ c·∫•p quy·ªÅn": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ G·ª≠i th√¥ng b√°o chia s·∫ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ Ghi log ho·∫°t ƒë·ªông chia s·∫ª": {
      "main": [
        [
          {
            "node": "üì¢ Discord Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Merge Email Data": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ Ghi log ho·∫°t ƒë·ªông chia s·∫ª",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Drive Trigger": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ X·ª≠ l√Ω d·ªØ li·ªáu ƒë·∫ßu v√†o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ L·∫•y to√†n b·ªô nh√¢n s·ª±": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ L·ªçc Email nh√¢n s·ª±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ L·ªçc Email nh√¢n s·ª±": {
      "main": [
        [
          {
            "node": "ü§ñ AI Quy·∫øt ƒë·ªãnh ph√™ duy·ªát",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Quy·∫øt ƒë·ªãnh ph√™ duy·ªát": {
      "main": [
        [
          {
            "node": "üìã Parse quy·∫øt ƒë·ªãnh AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Parse quy·∫øt ƒë·ªãnh AI": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ C·∫ßn ph√™ duy·ªát?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "53ac3cc4-464b-4441-8ead-6ffbd3a15859",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d29aff038a4897a8be0d9843c07ba06d6b485556105b19c20835a7b0bfd5b9b2"
  },
  "id": "O1ePtvyRVk7Ek0jj",
  "tags": []
}